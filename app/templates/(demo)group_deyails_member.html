<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群组详情 | Project PG12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5', // Indigo-600
                        'primary-dark': '#4338CA', // Indigo-700
                        success: '#10B981', // Emerald-500
                        danger: '#F87171', // Red-400
                        warning: '#FBBF24', // Amber-400
                        // 从 add_expense.html 合并的颜色
                        balance: '#10B981', 
                        unbalanced: '#F87171', 
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F9FAFB;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .balance-card {
            transition: all 0.2s ease-in-out;
        }

        /* 响应式Tab切换按钮 */
        .tab-button.active {
            border-bottom: 3px solid #4F46E5;
            color: #4F46E5;
            font-weight: 600;
        }
        
        /* --- 从 add_expense.html 合并的样式 --- */
        /* 隐藏原生文件上传输入框 */
        #add-expense-modal input[type="file"],
        #add-payment-modal input[type="file"],
        #expense-detail-modal input[type="file"],
        #payment-detail-modal input[type="file"] {
            display: none;
        }

        /* 2. 分段切换按钮的样式 (Toggle Button Style) */
        .split-toggle-btn {
            /* 基础样式：字体 text-xs，填充 py-2 */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-weight: 700;
            color: #4F46E5;
            background-color: white;
            transition-duration: 0.2s;
            border: none;
            border-right: 1px solid #4F46E5;
        }

        .split-toggle-btn:hover {
            background-color: #4F46E51A; /* primary/10 */
        }
        
        .split-toggle-btn.active {
            background-color: #4F46E5 !important; 
            color: white !important;
        }
        
        /* 移除最后一个按钮的右边框 */
        .split-toggle-btn:last-child {
            border-right: none;
        }
        
        /* 新增定期费用样式 */
        .recurring-toggle {
            transition: all 0.2s ease-in-out;
        }
        
        .recurring-options {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .recurring-options.expanded {
            max-height: 500px;
        }
        
        .frequency-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .frequency-option:hover {
            border-color: #4F46E5;
            background-color: #f8faff;
        }
        
        .frequency-option.selected {
            border-color: #4F46E5;
            background-color: #4F46E5;
            color: white;
        }
        
        .preview-item {
            border-left: 3px solid #4F46E5;
            background-color: #f8faff;
        }
        
        /* 多选框样式 */
        .participant-checkbox {
            accent-color: #4F46E5;
        }
        
        /* 费用项样式 */
        .expense-item {
            transition: all 0.2s ease-in-out;
        }
        
        .expense-item:hover {
            transform: translateY(-2px);
        }
        
        /* 只读样式 */
        .readonly-field {
            background-color: #f9fafb;
            cursor: not-allowed;
        }
        
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-3 items-center h-16">

                <div class="flex items-center justify-start">
                    <button onclick="handleBackToPreviousPage()"
                        class="flex items-center space-x-1 text-gray-700 hover:text-primary transition duration-150 text-sm font-medium p-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span class="hidden sm:block">Back</span>
                    </button>
                </div>

                <div class="flex items-center justify-center">
                    <span class="text-xl font-bold text-gray-900 truncate">Project PG12 记账本</span>
                </div>

                <div class="flex items-center relative justify-end" id="user-menu-container">

                    <!-- 移除了管理员徽章 -->

                    <button id="user-display-button" onclick="toggleUserMenu()"
                        class="flex items-center space-x-1 p-2 rounded-lg text-gray-700 font-medium text-sm hover:bg-gray-100 transition duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                        <span id="user-display">张三</span>
                        <svg id="caret-icon" class="w-4 h-4 ml-1 transform transition-transform duration-200" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="logout-dropdown"
                        class="absolute right-0 top-full mt-2 w-40 bg-white rounded-lg shadow-xl py-1 z-10 hidden border border-gray-100">

                        <button onclick="handleMyProfile(); toggleUserMenu();"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-150 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>我的资料</span>
                        </button>

                        <button onclick="handleBackToDashboard(); toggleUserMenu();"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-150 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7m0 0l7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                            <span>主页</span>
                        </button>

                        <button onclick="handleLogout()"
                            class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition duration-150 flex items-center space-x-2 border-t border-gray-100 mt-1 pt-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-3m0-6V7a3 3 0 013-3h4"></path>
                            </svg>
                            <span>退出登录</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl border border-gray-100">

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
                <h2 id="group-name-display" class="text-3xl font-extrabold text-gray-900 mb-4 sm:mb-0">
                    周末旅行基金 <span class="text-sm font-normal text-gray-500">(ID: 1)</span>
                </h2>
                <div class="flex flex-wrap gap-3 mt-4 sm:mt-0"> 
                    <!-- 修改：添加费用按钮文字改为"添加费用" -->
                    <button onclick="handleAddNewExpense()"
                        class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-primary hover:bg-primary-dark transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>添加费用</span>
                    </button>
                    
                    <!-- 新增：添加支付按钮 -->
                    <button onclick="handleAddNewPayment()"
                        class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-success hover:bg-emerald-600 transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        <span>添加支付</span>
                    </button>
                </div>
            </div>

            <div id="group-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="balance-card bg-white p-6 rounded-xl border border-danger/20 shadow-lg">
                    <p class="text-sm font-medium text-danger">您欠款 (应付)</p>
                    <p class="text-3xl font-bold text-danger mt-1" id="balance-owed">¥150.50</p>
                    <p class="text-xs text-gray-500 mt-2">给 2 位成员</p>
                </div>

                <div class="balance-card bg-white p-6 rounded-xl border border-success/20 shadow-lg">
                    <p class="text-sm font-medium text-success">被欠款 (应收)</p>
                    <p class="text-3xl font-bold text-success mt-1" id="balance-owing-me">¥45.00</p>
                    <p class="text-xs text-gray-500 mt-2">从 1 位成员</p>
                </div>

                <div class="balance-card bg-white p-6 rounded-xl border border-warning/20 shadow-lg flex flex-col justify-between">
                    <div>
                        <p class="text-sm font-medium text-warning">建议结算</p>
                        <p class="text-xl font-bold text-gray-900 mt-1">总计 2 笔待清算</p>
                    </div>
                    <button onclick="handleSettleUp()"
                        class="w-full py-2 bg-warning/80 text-white rounded-lg hover:bg-warning transition duration-150 shadow-md transform hover:scale-[1.01] active:scale-[0.99] text-sm mt-3">
                        <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0012 4.499c-3.562 0-6.84 1.838-8.683 4.887m17.566 2h-5.545m-4.021 0h-5.545M5.636 12A8.001 8.001 0 0012 19.5c3.562 0 6.84-1.838 8.683-4.887"></path></svg>
                        <span>结算所有欠款</span>
                    </button>
                </div>
            </div>

            <!-- 修改后的导航栏 - 添加支付标签页 -->
            <div class="border-b border-gray-200 mb-6">
                <div class="flex space-x-8 overflow-x-auto">
                    <!-- 主要内容Tab -->
                    <button id="tab-expenses" onclick="setActiveTab('expenses')"
                        class="tab-button active pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        费用 (<span id="expense-count">3</span>)
                    </button>
                    <button id="tab-recurring" onclick="setActiveTab('recurring')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        定期费用 (<span id="recurring-count">2</span>)
                    </button>
                    <button id="tab-payments" onclick="setActiveTab('payments')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        支付 (<span id="payment-count">2</span>)
                    </button>
                    <button id="tab-members" onclick="setActiveTab('members')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        成员 (<span id="member-count">4</span>)
                    </button>
                    
                    <!-- 仅保留邀请成员功能 -->
                    <button id="tab-invite" onclick="setActiveTab('invite')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        邀请成员
                    </button>
                </div>
            </div>

            <!-- 费用内容 -->
            <div id="tab-content-expenses">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">最近的费用列表</h3>
                <div id="expenses-list" class="space-y-4">
                    <!-- 费用列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 定期费用内容 -->
            <div id="tab-content-recurring" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">定期费用列表</h3>
                    <button onclick="handleAddNewRecurringExpense()"
                        class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-warning hover:bg-amber-500 transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>添加定期费用</span>
                    </button>
                </div>
                <div id="recurring-list" class="space-y-4">
                    <!-- 定期费用列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 支付内容 -->
            <div id="tab-content-payments" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">最近的支付列表</h3>
                <div id="payments-list" class="space-y-4">
                    <!-- 支付列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 成员内容 - 移除了待处理请求区域 -->
            <div id="tab-content-members" class="hidden">
                <!-- 现有群组成员区 -->
                <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center border-b pb-2">
                    群组成员 (<span id="active-member-count">4</span> 人)
                </h3>
                <div id="member-list-container" class="space-y-3">
                    <!-- 成员列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 邀请成员内容 -->
            <div id="tab-content-invite" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">邀请成员</h3>
                <div class="bg-white p-6 rounded-lg border border-gray-200 max-w-lg mx-auto">
                    <div class="space-y-4">
                        <p class="text-sm text-gray-600">请输入您希望邀请的用户的 **注册邮箱 (Email Address)**。系统将向该邮箱发送邀请链接。</p>
                        <label for="invite-user-email-input" class="block text-sm font-medium text-gray-700">要邀请的邮箱</label>
                        <input type="email" id="invite-user-email-input"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="例如: user@example.com">
                        <p id="invite-loading-message" class="text-sm text-warning hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-warning inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            正在发送邀请...
                        </p>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="clearInviteForm()"
                            class="py-2 px-4 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150 text-sm font-medium">
                            取消
                        </button>
                        <button onclick="inviteNewMember()" id="invite-submit-button"
                            class="py-2 px-4 rounded-lg text-white bg-success hover:bg-emerald-600 transition duration-150 shadow-md text-sm font-medium">
                            发送邀请
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <!-- 自定义提示模态框 -->
    <div id="custom-alert-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
            <p id="alert-message" class="text-lg font-medium mb-4 text-center"></p>
            <button onclick="closeCustomAlert()"
                class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition duration-150">确定</button>
        </div>
    </div>

    <!-- 删除确认弹窗 -->
    <div id="delete-confirm-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
            <div class="text-center">
                <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
                <p class="text-sm text-gray-600 mb-6" id="delete-confirm-message">您确定要删除这个费用吗？此操作无法撤销。</p>
                
                <div class="flex space-x-3">
                    <button onclick="closeDeleteConfirm()"
                        class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                        取消
                    </button>
                    <button onclick="confirmDeleteExpense()"
                        class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除支付确认弹窗 -->
    <div id="delete-payment-confirm-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
            <div class="text-center">
                <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
                <p class="text-sm text-gray-600 mb-6" id="delete-payment-confirm-message">您确定要删除这个支付吗？此操作无法撤销。</p>
                
                <div class="flex space-x-3">
                    <button onclick="closeDeletePaymentConfirm()"
                        class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                        取消
                    </button>
                    <button onclick="confirmDeletePayment()"
                        class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加费用弹窗 -->
    <div id="add-expense-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加新费用</h2>

            <form id="expense-form" onsubmit="handleSaveExpense(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                        <input type="text" id="description" name="description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="例如：晚餐、酒店费用、杂货">
                    </div>

                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="amount" name="amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                placeholder="0.00" oninput="handleAmountChange()">
                        </div>
                    </div>

                    <!-- 修改：付款人固定为当前用户 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <div class="mt-1 p-3 bg-gray-50 rounded-md border border-gray-300">
                            <p class="text-gray-700 font-medium">您 (张三)</p>
                            <p class="text-xs text-gray-500 mt-1">创建此费用的成员自动成为付款人</p>
                        </div>
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="date" name="date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>

                    <!-- 新增：参与者选择 -->
                    <div id="participants-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要向您还款的成员)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <!-- 参与者复选框将通过JavaScript动态生成 -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                    </div>

                   
                    
                    <div id="receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">收据 / 证明 (可选)</label>
                        <label for="receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary hover:bg-primary/5 transition duration-150">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="file-name-display" class="text-gray-700">点击上传收据图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="receipt-file" name="receipt-file" accept="image/*" onchange="updateFileNameDisplay(this)">
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>

                    <!-- 修改：分摊方式UI调整 -->
                    <div id="split-method-selection" class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>
                        
                        <div class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-primary"> 
                            <button type="button" onclick="setSplitMethod('equal')" id="split-equal"
                                class="split-toggle-btn active flex-1">
                                Equally Split
                            </button>
                            <button type="button" onclick="setSplitMethod('exact')" id="split-exact"
                                class="split-toggle-btn flex-1">
                                Custom Amount
                            </button>
                        </div>
                    </div>
                    
                    <div id="split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>
                        
                        <div id="split-list" class="space-y-3 d-sm">
                            </div>

                        <div id="split-summary" class="mt-4 pt-3 border-t">
                            </div>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6">
                    <button type="submit"
                        class="w-full py-3 bg-primary text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-primary-dark transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                        保存费用
                    </button>
                    <button type="button" onclick="handleCancel()"
                        class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
                </div>

            </form>
        </div>
    </div>
    
    <!-- 添加定期费用弹窗 -->
    <div id="add-recurring-expense-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加定期费用</h2>

            <form id="recurring-expense-form" onsubmit="handleSaveRecurringExpense(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="recurring-description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                        <input type="text" id="recurring-description" name="recurring-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                            placeholder="例如：每月房租、每周清洁费">
                    </div>

                    <div>
                        <label for="recurring-amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="recurring-amount" name="recurring-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                                placeholder="0.00" oninput="handleRecurringAmountChange()">
                        </div>
                    </div>

                    <div>
                        <label for="recurring-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <select id="recurring-payer" name="recurring-payer" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                            <option value="">请选择付款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <!-- 定期费用设置 -->
                    <div id="recurring-section" class="border-t pt-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">定期费用设置</label>
                        </div>
                        
                        <div id="recurring-options" class="recurring-options expanded">
                            <!-- 频率选择 -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-3">重复频率</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="frequency-option selected" onclick="selectFrequency('daily')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每日</div>
                                            <div class="text-xs opacity-75">每天重复</div>
                                        </div>
                                    </div>
                                    <div class="frequency-option" onclick="selectFrequency('weekly')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每周</div>
                                            <div class="text-xs opacity-75">每周同一天</div>
                                        </div>
                                    </div>
                                    <div class="frequency-option" onclick="selectFrequency('monthly')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每月</div>
                                            <div class="text-xs opacity-75">每月同一天</div>
                                        </div>
                                    </div>
                                    <div class="frequency-option" onclick="selectFrequency('yearly')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每年</div>
                                            <div class="text-xs opacity-75">每年同一天</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 重复设置 -->
                            <div id="recurring-settings" class="space-y-4 mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="repeat-start" class="block text-sm font-medium text-gray-700">开始日期</label>
                                        <input type="date" id="repeat-start" name="repeat-start" required
                                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="repeat-end" class="block text-sm font-medium text-gray-700">结束日期 (可选)</label>
                                        <input type="date" id="repeat-end" name="repeat-end"
                                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                                    </div>
                                </div>
                            </div>

                            <!-- 预览区域 -->
                            <div id="recurring-preview" class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-900 mb-3">费用预览</h4>
                                <div id="preview-list" class="space-y-2">
                                    <div class="preview-item p-3 rounded">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">初始费用</span>
                                            <span class="text-sm text-gray-600" id="preview-initial-date">2025-10-28</span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1" id="preview-initial-amount">金额: $0.00</div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2" id="preview-summary">共 1 笔费用</p>
                            </div>
                        </div>
                    </div>

                    <div id="recurring-participants-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <!-- 参与者复选框将通过JavaScript动态生成 -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                    </div>

                    <div id="recurring-split-method-selection" class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>
                        
                        <div class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-warning">
                            <button type="button" onclick="setRecurringSplitMethod('equal')" id="recurring-split-equal"
                                class="split-toggle-btn active flex-1">
                                Equally Split
                            </button>
                            <button type="button" onclick="setRecurringSplitMethod('exact')" id="recurring-split-exact"
                                class="split-toggle-btn flex-1">
                                Custom Amount
                            </button>
                        </div>
                    </div>
                    
                    <div id="recurring-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>
                        
                        <div id="recurring-split-list" class="space-y-3">
                            <!-- 分摊详情将通过JavaScript动态生成 -->
                        </div>

                        <div id="recurring-split-summary" class="mt-4 pt-3 border-t">
                            <!-- 分摊摘要将通过JavaScript动态生成 -->
                        </div>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6">
                    <button type="submit"
                        class="w-full py-3 bg-warning text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-amber-500 transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                        保存定期费用
                    </button>
                    <button type="button" onclick="handleRecurringCancel()"
                        class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
                </div>

            </form>
        </div>
    </div>

    <!-- 新增：添加支付弹窗 -->
    <div id="add-payment-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加新支付</h2>

            <form id="payment-form" onsubmit="handleSavePayment(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="payment-description" class="block text-sm font-medium text-gray-700">支付描述</label>
                        <input type="text" id="payment-description" name="payment-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                            placeholder="例如：还款给小明、结算交通费">
                    </div>

                    <div>
                        <label for="payment-amount" class="block text-sm font-medium text-gray-700">支付金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="payment-amount" name="payment-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                                placeholder="0.00">
                        </div>
                    </div>

                    <!-- 新增：选择支付对象 -->
                    <div>
                        <label for="payment-to" class="block text-sm font-medium text-gray-700">支付给谁?</label>
                        <select id="payment-to" name="payment-to" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择收款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <!-- 新增：选择支付费用 -->
                    <div>
                        <label for="payment-for-expense" class="block text-sm font-medium text-gray-700">为哪个费用支付?</label>
                        <select id="payment-for-expense" name="payment-for-expense" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择费用</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <!-- 修改：付款人固定为当前用户 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <div class="mt-1 p-3 bg-gray-50 rounded-md border border-gray-300">
                            <p class="text-gray-700 font-medium">您 (张三)</p>
                            <p class="text-xs text-gray-500 mt-1">创建此支付的成员自动成为付款人</p>
                        </div>
                    </div>

                    <div>
                        <label for="payment-date" class="block text-sm font-medium text-gray-700">支付日期</label>
                        <input type="date" id="payment-date" name="payment-date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                    </div>
                    
                    <div id="payment-receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">支付凭证 (可选)</label>
                        <label for="payment-receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-success hover:bg-success/5 transition duration-150">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="payment-file-name-display" class="text-gray-700">点击上传支付凭证图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="payment-receipt-file" name="payment-receipt-file" accept="image/*" onchange="updatePaymentFileNameDisplay(this)">
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6">
                    <button type="submit"
                        class="w-full py-3 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                        保存支付
                    </button>
                    <button type="button" onclick="handlePaymentCancel()"
                        class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
                </div>

            </form>
        </div>
    </div>

    <!-- 新增：费用详情弹窗 -->
    <div id="expense-detail-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="expense-detail-title">费用详情</h2>

            <form id="expense-detail-form" onsubmit="handleUpdateExpense(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="detail-description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                        <input type="text" id="detail-description" name="detail-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm readonly-field"
                            placeholder="例如：晚餐、酒店费用、杂货" readonly>
                    </div>

                    <div>
                        <label for="detail-amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="detail-amount" name="detail-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm readonly-field"
                                placeholder="0.00" oninput="handleDetailAmountChange()" readonly>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <div class="mt-1 p-3 bg-gray-50 rounded-md border border-gray-300">
                            <p id="detail-payer" class="text-gray-700 font-medium">您 (张三)</p>
                            <p class="text-xs text-gray-500 mt-1">创建此费用的成员自动成为付款人</p>
                        </div>
                    </div>

                    <div>
                        <label for="detail-date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="detail-date" name="detail-date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm readonly-field"
                            readonly>
                    </div>

                    <!-- 参与者选择 -->
                    <div id="detail-participants-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要向您还款的成员)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200" id="detail-participants-container">
                            <!-- 参与者复选框将通过JavaScript动态生成 -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                    </div>
                    
                    <!-- 上传图片 -->
                    <div id="receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">收据 / 证明 (可选)</label>
                        <label for="receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary hover:bg-primary/5 transition duration-150">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="file-name-display" class="text-gray-700">点击上传收据图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="receipt-file" name="receipt-file" accept="image/*" onchange="updateFileNameDisplay(this)">
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>

                    <!-- 分摊方式 -->
                    <div id="detail-split-method-selection" class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>
                        
                        <div class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-primary"> 
                            <button type="button" onclick="setDetailSplitMethod('equal')" id="detail-split-equal"
                                class="split-toggle-btn active flex-1 readonly-field" disabled>
                                Equally Split
                            </button>
                            <button type="button" onclick="setDetailSplitMethod('exact')" id="detail-split-exact"
                                class="split-toggle-btn flex-1 readonly-field" disabled>
                                Custom Amount
                            </button>
                        </div>
                    </div>
                    
                    <div id="detail-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>
                        
                        <div id="detail-split-list" class="space-y-3">
                            <!-- 分摊详情将通过JavaScript动态生成 -->
                        </div>

                        <div id="detail-split-summary" class="mt-4 pt-3 border-t">
                            <!-- 分摊摘要将通过JavaScript动态生成 -->
                        </div>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6 flex justify-between" id="expense-detail-actions">
                    <!-- 按钮区域将通过JavaScript动态生成 -->
                </div>

            </form>
        </div>
    </div>

    <!-- 定期费用详情弹窗 -->
    <div id="recurring-detail-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="recurring-detail-title">定期费用详情</h2>

            <div class="space-y-6">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                    <p class="mt-1 text-gray-900 font-medium" id="recurring-detail-description">每月房租</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">金额 ($)</label>
                    <p class="mt-1 text-gray-900 font-medium" id="recurring-detail-amount">$1500.00</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">谁支付了?</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-payer">张三</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">频率</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-frequency">每月</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">开始日期</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-start-date">2025-11-01</p>
                </div>

                <div id="recurring-detail-end-date-container">
                    <label class="block text-sm font-medium text-gray-700">结束日期</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-end-date">2026-10-31</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">状态</label>
                    <div class="mt-1">
                        <span id="recurring-detail-status" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success/10 text-success">
                            启用
                        </span>
                    </div>
                </div>

                <div id="recurring-detail-participants-section">
                    <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200" id="recurring-detail-participants-container">
                        <!-- 参与者列表将通过JavaScript动态生成 -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">分摊方式</label>
                    <p class="text-gray-900" id="recurring-detail-split-method">Equally Split</p>
                </div>
                
                <div id="recurring-detail-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold mb-2">分摊详情</h4>
                    
                    <div id="recurring-detail-split-list" class="space-y-3">
                        <!-- 分摊详情将通过JavaScript动态生成 -->
                    </div>
                </div>

            </div>

            <div class="mt-8 border-t pt-6 flex justify-between">
                <div class="flex space-x-3">
                    <button onclick="handleDisableRecurringExpense()" id="disable-recurring-btn"
                        class="py-3 px-6 bg-gray-600 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-gray-700 transition duration-200">
                        禁用
                    </button>
                    <button onclick="handleEnableRecurringExpense()" id="enable-recurring-btn" class="hidden"
                        class="py-3 px-6 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200">
                        启用
                    </button>
                    <button onclick="handleDeleteRecurringExpense()"
                        class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                        删除定期费用
                    </button>
                </div>
                <div class="flex space-x-3">
                    <button onclick="handleRecurringDetailCancel()"
                        class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        关闭
                    </button>
                    <button onclick="handleEditRecurringExpense()"
                        class="py-3 px-6 bg-warning text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-amber-500 transition duration-200">
                        编辑定期费用
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- 新增：支付详情弹窗 -->
    <div id="payment-detail-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="payment-detail-title">支付详情</h2>

            <form id="payment-detail-form" onsubmit="handleUpdatePayment(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="payment-detail-description" class="block text-sm font-medium text-gray-700">支付描述</label>
                        <input type="text" id="payment-detail-description" name="payment-detail-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm readonly-field"
                            placeholder="例如：还款给小明、结算交通费" readonly>
                    </div>

                    <div>
                        <label for="payment-detail-amount" class="block text-sm font-medium text-gray-700">支付金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="payment-detail-amount" name="payment-detail-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-success focus:border-success sm:text-sm readonly-field"
                                placeholder="0.00" readonly>
                        </div>
                    </div>

                    <!-- 新增：选择支付对象 -->
                    <div>
                        <label for="payment-detail-to" class="block text-sm font-medium text-gray-700">支付给谁?</label>
                        <select id="payment-detail-to" name="payment-detail-to" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm readonly-field"
                            disabled>
                            <option value="">请选择收款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <!-- 新增：选择支付费用 -->
                    <div>
                        <label for="payment-detail-for-expense" class="block text-sm font-medium text-gray-700">为哪个费用支付?</label>
                        <select id="payment-detail-for-expense" name="payment-detail-for-expense" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm readonly-field"
                            disabled>
                            <option value="">请选择费用</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <!-- 修改：付款人固定为当前用户 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <div class="mt-1 p-3 bg-gray-50 rounded-md border border-gray-300">
                            <p id="payment-detail-payer" class="text-gray-700 font-medium">您 (张三)</p>
                            <p class="text-xs text-gray-500 mt-1">创建此支付的成员自动成为付款人</p>
                        </div>
                    </div>

                    <div>
                        <label for="payment-detail-date" class="block text-sm font-medium text-gray-700">支付日期</label>
                        <input type="date" id="payment-detail-date" name="payment-detail-date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm readonly-field"
                            readonly>
                    </div>
                    
                    <div id="payment-detail-receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">支付凭证 (可选)</label>
                        <label for="payment-detail-receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-success hover:bg-success/5 transition duration-150 readonly-field">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="payment-detail-file-name-display" class="text-gray-700">点击上传支付凭证图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="payment-detail-receipt-file" name="payment-detail-receipt-file" accept="image/*" onchange="updatePaymentDetailFileNameDisplay(this)" disabled>
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6 flex justify-between" id="payment-detail-actions">
                    <!-- 按钮区域将通过JavaScript动态生成 -->
                </div>

            </form>
        </div>
    </div>

    <script>
        // --- 全局状态和数据 (群组详情部分) ---
        const CURRENT_USER_ID = 'user_self';
        const CURRENT_USER_NAME = '张三'; // 移除了管理员标识
        const IS_CURRENT_USER_ADMIN = false; // 设置为false

        // Mock 成员列表
        let groupMembers = [
            { id: 'user_self', name: CURRENT_USER_NAME, email: 'zhangsan@example.com', isAdmin: false, balance: 0.00 },
            { id: 'user_2', name: '小明', email: 'xiaoming@example.com', isAdmin: false, balance: -15.50 },
            { id: 'user_3', name: '小红', email: 'xiaohong@example.com', isAdmin: true, balance: 30.00 },
            { id: 'user_4', name: '老王', email: 'laowang@example.com', isAdmin: false, balance: 0.00 }
        ];

        // Mock 费用列表
        let expensesList = [
            { 
                id: 'expense_1', 
                description: '周末聚餐费用', 
                amount: 225.00, 
                date: '2025-10-27', 
                payer: 'user_self',
                participants: ['user_self', 'user_2', 'user_3'],
                splitMethod: 'equal',
                splits: [
                    { id: 'user_self', name: '您 (张三)', amount: '75.00' },
                    { id: 'user_2', name: '小明', amount: '75.00' },
                    { id: 'user_3', name: '小红', amount: '75.00' }
                ]
            },
            { 
                id: 'expense_2', 
                description: '机场交通费', 
                amount: 60.00, 
                date: '2025-10-26', 
                payer: 'user_2',
                participants: ['user_self', 'user_2', 'user_3'],
                splitMethod: 'equal',
                splits: [
                    { id: 'user_self', name: '您 (张三)', amount: '20.00' },
                    { id: 'user_2', name: '小明', amount: '20.00' },
                    { id: 'user_3', name: '小红', amount: '20.00' }
                ]
            },
            { 
                id: 'expense_3', 
                description: '酒店住宿', 
                amount: 300.00, 
                date: '2025-10-25', 
                payer: 'user_3',
                participants: ['user_self', 'user_2', 'user_3'],
                splitMethod: 'equal',
                splits: [
                    { id: 'user_self', name: '您 (张三)', amount: '100.00' },
                    { id: 'user_2', name: '小明', amount: '100.00' },
                    { id: 'user_3', name: '小红', amount: '100.00' }
                ]
            }
        ];

        // Mock 支付列表
        let paymentsList = [
            { 
                id: 'payment_1', 
                description: '还款给小明', 
                amount: 75.00, 
                date: '2025-10-28', 
                payer: 'user_self',
                payee: 'user_2',
                expenseId: 'expense_1',
                receipt: null
            },
            { 
                id: 'payment_2', 
                description: '结算交通费', 
                amount: 20.00, 
                date: '2025-10-27', 
                payer: 'user_self',
                payee: 'user_3',
                expenseId: 'expense_2',
                receipt: null
            },
            { 
                id: 'payment_3', 
                description: '酒店费用还款', 
                amount: 100.00, 
                date: '2025-10-26', 
                payer: 'user_2',
                payee: 'user_3',
                expenseId: 'expense_3',
                receipt: null
            }
        ];
        // Mock 定期费用列表
        let recurringExpensesList = [
            {
                id: 'recurring_1',
                description: '每月房租',
                amount: 1500.00,
                startDate: '2025-10-01',
                frequency: 'monthly',
                payer: 'user_self',
                participants: ['user_self', 'user_2', 'user_3'],
                splitMethod: 'equal',
                splits: [
                    { id: 'user_self', name: '您 (张三)', amount: '500.00' },
                    { id: 'user_2', name: '小明', amount: '500.00' },
                    { id: 'user_3', name: '小红', amount: '500.00' }
                ],
                isActive: true
            },
           
        ];

        // 参与者选择状态
        let selectedParticipants = new Set([CURRENT_USER_ID]); // 默认包含自己

        // 费用详情相关全局状态
        let currentEditingExpense = null;
        let detailSelectedParticipants = new Set();
        let detailMemberSplits = [];
        let detailSplitMethod = 'equal';
        let isOwnExpense = false; // 标记当前查看的费用是否为自己创建

        // 支付详情相关全局状态
        let currentEditingPayment = null;
        let isOwnPayment = false; // 标记当前查看的支付是否为自己创建
        

        // 简单的邮箱验证函数
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // --- 费用/分摊相关全局状态 (从 add_expense.html 合并) ---
        const currentTransactionType = 'expense';
        let currentSplitMethod = 'equal'; // 'equal' or 'exact'
        let memberSplits = []; // 分摊状态：存储每个成员的分摊金额

        // 定期费用相关状态
        let recurringExpenseState = {
            isRecurring: false,
            frequency: 'daily',
            startDate: '',
            endDate: '',
        };
        let recurringSelectedParticipants = new Set([CURRENT_USER_ID]);
        let recurringSplitMethod = 'equal';
        let recurringMemberSplits = [];
        let currentEditingRecurringExpense = null;

        // --- 删除确认功能 ---
        function showDeleteConfirm(expenseDescription) {
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            
            if (modal && message) {
                message.textContent = `您确定要删除费用 "${expenseDescription}" 吗？此操作无法撤销。`;
                modal.classList.remove('hidden');
            }
        }

        function closeDeleteConfirm() {
            const modal = document.getElementById('delete-confirm-modal');
            if (modal) modal.classList.add('hidden');
        }

        function confirmDeleteExpense() {
            if (!isOwnExpense) {
                customAlert('权限错误', '您只能删除自己创建的费用');
                closeDeleteConfirm();
                return;
            }
            
            if (!currentEditingExpense) {
                customAlert('错误', '未找到要删除的费用');
                closeDeleteConfirm();
                return;
            }
            
            // 从费用列表中删除
            const index = expensesList.findIndex(e => e.id === currentEditingExpense.id);
            if (index !== -1) {
                expensesList.splice(index, 1);
            }
            
            customAlert('费用已删除', `费用 "${currentEditingExpense.description}" 已被删除`);
            
            // 关闭所有模态框并刷新费用列表
            closeDeleteConfirm();
            handleDetailCancel();
            refreshExpensesList();
        }

        // --- 删除支付确认功能 ---
        function showDeletePaymentConfirm(paymentDescription) {
            const modal = document.getElementById('delete-payment-confirm-modal');
            const message = document.getElementById('delete-payment-confirm-message');
            
            if (modal && message) {
                message.textContent = `您确定要删除支付 "${paymentDescription}" 吗？此操作无法撤销。`;
                modal.classList.remove('hidden');
            }
        }

        function closeDeletePaymentConfirm() {
            const modal = document.getElementById('delete-payment-confirm-modal');
            if (modal) modal.classList.add('hidden');
        }

        function confirmDeletePayment() {
            if (!isOwnPayment) {
                customAlert('权限错误', '您只能删除自己创建的支付');
                closeDeletePaymentConfirm();
                return;
            }
            
            if (!currentEditingPayment) {
                customAlert('错误', '未找到要删除的支付');
                closeDeletePaymentConfirm();
                return;
            }
            
            // 从支付列表中删除
            const index = paymentsList.findIndex(p => p.id === currentEditingPayment.id);
            if (index !== -1) {
                paymentsList.splice(index, 1);
            }
            
            customAlert('支付已删除', `支付 "${currentEditingPayment.description}" 已被删除`);
            
            // 关闭所有模态框并刷新支付列表
            closeDeletePaymentConfirm();
            handlePaymentDetailCancel();
            refreshPaymentsList();
        }

        // --- Tab 切换逻辑 ---
        let activeTab = 'expenses';
        
        function setActiveTab(tabName) {
            if (activeTab === tabName) return;

            // 移除所有tab的active状态
            const allTabs = ['expenses', 'recurring','payments', 'members', 'invite'];
            allTabs.forEach(tab => {
                const tabElement = document.getElementById(`tab-${tab}`);
                const contentElement = document.getElementById(`tab-content-${tab}`);
                
                if (tabElement) tabElement.classList.remove('active');
                if (contentElement) contentElement.classList.add('hidden');
            });

            // 设置当前tab为active状态
            const currentTab = document.getElementById(`tab-${tabName}`);
            const currentContent = document.getElementById(`tab-content-${tabName}`);
            
            if (currentTab) currentTab.classList.add('active');
            if (currentContent) currentContent.classList.remove('hidden');
            
            // 如果是成员tab，渲染成员列表
            if (tabName === 'members') {
                renderMemberList();
            }
            // 如果是支付tab，渲染支付列表
            else if (tabName === 'payments') {
                refreshPaymentsList();
            }
            else if (tabName === 'recurring') {
                refreshRecurringList();
            }
            // 如果是费用tab，渲染费用列表
            else if (tabName === 'expenses') {
                refreshExpensesList();
            }
            
            activeTab = tabName;
        }

        // --- 费用详情功能 ---
        function viewExpenseDetail(expenseId) {
            // 查找费用数据
            const expense = expensesList.find(e => e.id === expenseId);
            if (!expense) {
                customAlert('错误', '未找到费用信息');
                return;
            }
            
            currentEditingExpense = expense;
            isOwnExpense = expense.payer === CURRENT_USER_ID; // 检查是否为自己创建的费用
            
            // 打开模态框
            const modal = document.getElementById('expense-detail-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeExpenseDetailForm(expense);
            }
        }

        function initializeExpenseDetailForm(expense) {
            // 更新标题
            const titleElement = document.getElementById('expense-detail-title');
            if (titleElement) {
                titleElement.textContent = isOwnExpense ? '费用详情 (可编辑)' : '费用详情 (只读)';
            }
            
            // 填充基本信息
            document.getElementById('detail-description').value = expense.description;
            document.getElementById('detail-amount').value = expense.amount;
            document.getElementById('detail-date').value = expense.date;
            
            // 显示付款人信息
            const payerElement = document.getElementById('detail-payer');
            if (payerElement) {
                const payerName = groupMembers.find(m => m.id === expense.payer)?.name || expense.payer;
                payerElement.textContent = expense.payer === CURRENT_USER_ID ? `您 (${payerName})` : payerName;
            }
            
            // 初始化参与者选择
            detailSelectedParticipants = new Set(expense.participants || [CURRENT_USER_ID]);
            renderDetailParticipantSelection();
            
            // 初始化分摊方式
            detailSplitMethod = expense.splitMethod || 'equal';
            setDetailSplitMethod(detailSplitMethod, false);
            
            // 初始化分摊详情
            detailMemberSplits = expense.splits || [];
            if (detailMemberSplits.length === 0) {
                const amount = parseFloat(expense.amount) || 0;
                initializeDetailSplits(amount);
            }
            
            updateDetailSplitDetails();
            
            // 根据权限设置表单状态
            setExpenseDetailFormEditable(isOwnExpense);
            
            // 更新操作按钮
            updateExpenseDetailActions();
        }

        function setExpenseDetailFormEditable(editable) {
            const form = document.getElementById('expense-detail-form');
            if (!form) return;
            
            // 获取所有输入字段
            const inputs = form.querySelectorAll('input, select, button');
            inputs.forEach(input => {
                if (editable) {
                    input.classList.remove('readonly-field');
                    input.removeAttribute('readonly');
                    input.disabled = false;
                } else {
                    input.classList.add('readonly-field');
                    input.setAttribute('readonly', 'readonly');
                    input.disabled = true;
                }
            });
            
            // 特殊处理参与者选择
            const participantCheckboxes = form.querySelectorAll('input[type="checkbox"]');
            participantCheckboxes.forEach(checkbox => {
                if (editable) {
                    checkbox.disabled = checkbox.id.includes('user_self'); // 自己仍然不可选
                } else {
                    checkbox.disabled = true;
                }
            });
            
            // 特殊处理分摊方式按钮
            const splitButtons = form.querySelectorAll('.split-toggle-btn');
            splitButtons.forEach(button => {
                button.disabled = !editable;
                if (!editable) {
                    button.classList.add('readonly-field');
                } else {
                    button.classList.remove('readonly-field');
                }
            });
        }

        function updateExpenseDetailActions() {
            const actionsContainer = document.getElementById('expense-detail-actions');
            if (!actionsContainer) return;
            
            if (isOwnExpense) {
                // 自己创建的费用：显示删除和更新按钮
                actionsContainer.innerHTML = `
                    <button type="button" onclick="handleDeleteExpense()"
                        class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                        删除费用
                    </button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="handleDetailCancel()"
                            class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                            取消
                        </button>
                        <button type="submit"
                            class="py-3 px-6 bg-primary text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-primary-dark transition duration-200">
                            更新费用
                        </button>
                    </div>
                `;
            } else {
                // 其他人创建的费用：只显示关闭按钮
                actionsContainer.innerHTML = `
                    <div class="w-full flex justify-end">
                        <button type="button" onclick="handleDetailCancel()"
                            class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                            关闭
                        </button>
                    </div>
                `;
            }
        }

        function renderDetailParticipantSelection() {
            const container = document.getElementById('detail-participants-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isSelf = member.id === CURRENT_USER_ID;
                const isChecked = detailSelectedParticipants.has(member.id);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200 hover:bg-gray-50 transition duration-150';
                checkbox.innerHTML = `
                    <input type="checkbox" id="detail-participant-${member.id}" 
                           ${isChecked ? 'checked' : ''} 
                           ${isSelf ? 'disabled' : ''}
                           ${!isOwnExpense ? 'disabled' : ''}
                           onchange="handleDetailParticipantChange('${member.id}', this.checked)"
                           class="participant-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    <label for="detail-participant-${member.id}" class="flex items-center space-x-2 flex-1 cursor-pointer">
                        <div class="w-8 h-8 flex items-center justify-center bg-primary/10 text-primary rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${isSelf ? ' (您)' : ''}
                        </span>
                    </label>
                `;
                
                container.appendChild(checkbox);
            });
        }

        function handleDetailParticipantChange(memberId, isChecked) {
            if (!isOwnExpense) return; // 只有自己创建的费用才能修改参与者
            
            if (isChecked) {
                detailSelectedParticipants.add(memberId);
            } else {
                detailSelectedParticipants.delete(memberId);
            }
            
            // 重新计算分摊
            const amount = parseFloat(document.getElementById('detail-amount').value) || 0;
            initializeDetailSplits(amount);
            updateDetailSplitDetails();
        }

        function initializeDetailSplits(amount) {
            // 只包含选中的参与者
            const activeMembers = groupMembers.filter(m => detailSelectedParticipants.has(m.id));
            const memberCount = activeMembers.length;
            
            if (memberCount === 0) {
                detailMemberSplits = [];
                return;
            }
            
            const equalSplit = (amount / memberCount);
            let totalAllocated = 0;

            const existingSplitsValid = detailSplitMethod === 'exact' && detailMemberSplits.length === memberCount;
            
            detailMemberSplits = activeMembers.map((member, index) => {
                let splitAmount;

                if (existingSplitsValid) {
                    const oldSplit = detailMemberSplits.find(s => s.id === member.id);
                    splitAmount = parseFloat(oldSplit?.amount || '0.00');
                } else {
                    let calculatedSplit = Math.floor(equalSplit * 100) / 100;
                    
                    if (index === memberCount - 1) {
                        calculatedSplit = amount - totalAllocated;
                    } else {
                        totalAllocated += calculatedSplit;
                    }
                    splitAmount = calculatedSplit;
                }

                const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                return {
                    id: member.id,
                    name: member.id === CURRENT_USER_ID ? `您 (${displayName})` : displayName,
                    amount: splitAmount.toFixed(2),
                };
            });
        }

        function setDetailSplitMethod(method, triggerUpdate = true) {
            if (!isOwnExpense) return; // 只有自己创建的费用才能修改分摊方式
            
            detailSplitMethod = method;
            const methods = ['equal', 'exact'];
            
            methods.forEach(m => {
                const btn = document.getElementById(`detail-split-${m}`);
                if (btn) {
                    if (m === method) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
            
            if (triggerUpdate) {
                const amountInput = document.getElementById('detail-amount');
                const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
                initializeDetailSplits(amount);
                updateDetailSplitDetails();
            }
        }

        function handleDetailSplitInputChange(memberId, type, value) {
            if (!isOwnExpense) return; // 只有自己创建的费用才能修改分摊详情
            
            if (type !== 'amount') return;

            const index = detailMemberSplits.findIndex(s => s.id === memberId);
            if (index !== -1) {
                detailMemberSplits[index].amount = parseFloat(value).toFixed(2);
            }
            updateDetailSplitSummary();
        }

        function handleDetailAmountChange() {
            if (!isOwnExpense) return; // 只有自己创建的费用才能修改金额
            
            const amountInput = document.getElementById('detail-amount');
            const newAmount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            initializeDetailSplits(newAmount);
            updateDetailSplitDetails();
        }

        function updateDetailSplitDetails() {
            const splitList = document.getElementById('detail-split-list');
            const amountInput = document.getElementById('detail-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!splitList) return;
            
            splitList.innerHTML = '';
            
            const sectionTitle = document.querySelector('#detail-split-details-section h4');
            if (sectionTitle) {
                sectionTitle.textContent = `分摊详情 (${getSplitMethodName(detailSplitMethod)})`;
            }

            if (detailSplitMethod === 'equal') {
                initializeDetailSplits(amount);

                detailMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    listItem.innerHTML = `
                        <span>${split.name}</span>
                        <span class="font-medium text-gray-900">$ ${split.amount}</span>
                    `;
                    splitList.appendChild(listItem);
                });

            } else {
                const inputType = 'amount';
                const inputUnit = '$';
                const inputPlaceholder = '0.00';

                detailMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    
                    listItem.innerHTML = `
                        <label for="detail-split-${split.id}" class="w-1/3 text-gray-700">${split.name}</label>
                        <div class="relative w-2/3">
                            <input type="number" id="detail-split-${split.id}" 
                                   value="${split.amount}"
                                   min="0" step="0.01" required
                                   oninput="handleDetailSplitInputChange('${split.id}', '${inputType}', this.value)"
                                   class="block w-full pr-10 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm ${!isOwnExpense ? 'readonly-field' : ''}"
                                   placeholder="${inputPlaceholder}" ${!isOwnExpense ? 'readonly' : ''}>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">${inputUnit}</span>
                            </div>
                        </div>
                    `;
                    splitList.appendChild(listItem);
                });
            }
            updateDetailSplitSummary();
        }

        function updateDetailSplitSummary() {
            const summaryDiv = document.getElementById('detail-split-summary');
            const amountInput = document.getElementById('detail-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!summaryDiv) return;
            
            let totalSplit = 0;
            let isBalanced = true;

            totalSplit = detailMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            isBalanced = Math.abs(totalSplit - amount) < 0.01;
            
            const remaining = (amount - totalSplit).toFixed(2);
            
            summaryDiv.innerHTML = `
                <p class="text-sm flex justify-between">
                    <span class="font-medium text-gray-700">总分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${totalSplit.toFixed(2)}</span>
                </p>
                <p class="text-sm flex justify-between mt-1">
                    <span class="font-medium text-gray-700">待分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${remaining}</span>
                </p>
                ${!isBalanced ? `<p class="text-xs text-unbalanced mt-1">**警告:** 分摊总额 $${totalSplit.toFixed(2)} 与费用总额 $${amount.toFixed(2)} 不匹配。</p>` : ''}
            `;

            const submitButton = document.querySelector('#expense-detail-modal button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = !isBalanced;
                submitButton.classList.toggle('opacity-50', !isBalanced);
                submitButton.classList.toggle('cursor-not-allowed', !isBalanced);
            }
        }

        function handleUpdateExpense(event) {
            event.preventDefault();
            
            if (!isOwnExpense) {
                customAlert('权限错误', '您只能更新自己创建的费用');
                return;
            }
            
            const amountInput = document.getElementById('detail-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            let totalSplit = detailMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            if (Math.abs(totalSplit - amount) > 0.01) {
                customAlert('提交失败', '分摊总额与费用总额不匹配，请调整分摊详情。');
                return;
            }
            
            if (!currentEditingExpense) {
                customAlert('错误', '未找到要更新的费用');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            // 更新费用数据
            currentEditingExpense.description = data['detail-description'];
            currentEditingExpense.amount = parseFloat(data['detail-amount']);
            currentEditingExpense.date = data['detail-date'];
            currentEditingExpense.participants = Array.from(detailSelectedParticipants);
            currentEditingExpense.splitMethod = detailSplitMethod;
            currentEditingExpense.splits = [...detailMemberSplits];

            let transactionSummary = `交易类型: 更新费用\n`;
            transactionSummary += `描述: ${data['detail-description']}\n`;
            transactionSummary += `金额: $${parseFloat(data['detail-amount']).toFixed(2)}\n`;
            transactionSummary += `付款人: ${CURRENT_USER_NAME}\n`;
            transactionSummary += `参与者: ${Array.from(detailSelectedParticipants).map(id => groupMembers.find(m => m.id === id)?.name).join(', ')}\n`;
            transactionSummary += `日期: ${data['detail-date']}\n`;
            transactionSummary += `分摊方式: ${getSplitMethodName(detailSplitMethod)}\n`;
            transactionSummary += `分摊详情: ${JSON.stringify(detailMemberSplits.map(s => ({ id: s.id, amount: s.amount })))}`;

            customAlert('费用已更新', transactionSummary);

            // 关闭模态框并刷新费用列表
            handleDetailCancel();
            refreshExpensesList();
        }

        function handleDeleteExpense() {
            if (!isOwnExpense) {
                customAlert('权限错误', '您只能删除自己创建的费用');
                return;
            }
            
            if (!currentEditingExpense) {
                customAlert('错误', '未找到要删除的费用');
                return;
            }
            
            // 使用自定义弹窗替代浏览器 confirm
            showDeleteConfirm(currentEditingExpense.description);
        }

        function handleDetailCancel() {
            const modal = document.getElementById('expense-detail-modal');
            if (modal) modal.classList.add('hidden');
            currentEditingExpense = null;
            isOwnExpense = false;
        }
        // --- 定期费用列表功能 ---
        function refreshRecurringList() {
            const recurringListContainer = document.getElementById('recurring-list');
            const recurringCountElement = document.getElementById('recurring-count');
            
            if (!recurringListContainer) return;
            
            if (recurringCountElement) {
                recurringCountElement.textContent = recurringExpensesList.length;
            }
            
            recurringListContainer.innerHTML = '';
            
            recurringExpensesList.forEach(expense => {
                const isOwnExpense = expense.payer === CURRENT_USER_ID;
                const frequencyText = getFrequencyDisplayName(expense.frequency);
                const statusText = expense.isActive ? '启用' : '禁用';
                const statusClass = expense.isActive ? 'bg-success/10 text-success' : 'bg-gray-100 text-gray-800';
                
                const expenseItem = document.createElement('div');
                expenseItem.className = `expense-item flex items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-150 cursor-pointer ${isOwnExpense ? 'border-l-4 border-l-warning' : ''}`;
                expenseItem.onclick = () => viewRecurringDetail(expense.id);
                
                const payerName = groupMembers.find(m => m.id === expense.payer)?.name || expense.payer;
                
                expenseItem.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-warning/10 text-warning rounded-full flex items-center justify-center text-lg font-bold mr-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800 truncate">${expense.description}</p>
                        <p class="text-xs text-gray-500">频率: ${frequencyText} | 付款人: ${payerName}</p>
                        <div class="mt-2 flex items-center space-x-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-warning">$${expense.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${isOwnExpense ? '您创建的' : '其他成员创建'}</p>
                    </div>
                `;
                
                recurringListContainer.appendChild(expenseItem);
            });
        }

        function viewRecurringDetail(expenseId) {
            const expense = recurringExpensesList.find(e => e.id === expenseId);
            if (!expense) {
                customAlert('错误', '未找到定期费用信息');
                return;
            }
            
            currentEditingRecurringExpense = expense;
            
            const modal = document.getElementById('recurring-detail-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeRecurringDetailForm(expense);
            }
        }

        function initializeRecurringDetailForm(expense) {
            document.getElementById('recurring-detail-description').textContent = expense.description;
            document.getElementById('recurring-detail-amount').textContent = `$${expense.amount.toFixed(2)}`;
            document.getElementById('recurring-detail-payer').textContent = groupMembers.find(m => m.id === expense.payer)?.name || expense.payer;
            document.getElementById('recurring-detail-frequency').textContent = getFrequencyDisplayName(expense.frequency);
            document.getElementById('recurring-detail-start-date').textContent = expense.startDate;
            
            if (expense.endDate) {
                document.getElementById('recurring-detail-end-date').textContent = expense.endDate;
                document.getElementById('recurring-detail-end-date-container').classList.remove('hidden');
            } else {
                document.getElementById('recurring-detail-end-date-container').classList.add('hidden');
            }
            
            // 设置状态
            const statusElement = document.getElementById('recurring-detail-status');
            const disableBtn = document.getElementById('disable-recurring-btn');
            const enableBtn = document.getElementById('enable-recurring-btn');
            
            if (expense.isActive) {
                statusElement.textContent = '启用';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success/10 text-success';
                disableBtn.classList.remove('hidden');
                enableBtn.classList.add('hidden');
            } else {
                statusElement.textContent = '禁用';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                disableBtn.classList.add('hidden');
                enableBtn.classList.remove('hidden');
            }
            
            // 设置参与者
            const participantsContainer = document.getElementById('recurring-detail-participants-container');
            participantsContainer.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isParticipant = expense.participants.includes(member.id);
                if (isParticipant) {
                    const participantElement = document.createElement('div');
                    participantElement.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200';
                    participantElement.innerHTML = `
                        <div class="w-8 h-8 flex items-center justify-center bg-primary/10 text-primary rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${member.id === CURRENT_USER_ID ? ' (您)' : ''}
                        </span>
                    `;
                    participantsContainer.appendChild(participantElement);
                }
            });
            
            // 设置分摊方式
            document.getElementById('recurring-detail-split-method').textContent = getSplitMethodName(expense.splitMethod);
            
            // 设置分摊详情
            const splitList = document.getElementById('recurring-detail-split-list');
            splitList.innerHTML = '';
            
            expense.splits.forEach(split => {
                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center py-1';
                listItem.innerHTML = `
                    <span>${split.name}</span>
                    <span class="font-medium text-gray-900">$ ${split.amount}</span>
                `;
                splitList.appendChild(listItem);
            });
        }

        function handleDisableRecurringExpense() {
            if (!currentEditingRecurringExpense) return;
            
            currentEditingRecurringExpense.isActive = false;
            refreshRecurringList();
            initializeRecurringDetailForm(currentEditingRecurringExpense);
            customAlert('定期费用已禁用', `定期费用 "${currentEditingRecurringExpense.description}" 已禁用`);
        }

        function handleEnableRecurringExpense() {
            if (!currentEditingRecurringExpense) return;
            
            currentEditingRecurringExpense.isActive = true;
            refreshRecurringList();
            initializeRecurringDetailForm(currentEditingRecurringExpense);
            customAlert('定期费用已启用', `定期费用 "${currentEditingRecurringExpense.description}" 已启用`);
        }

        function handleDeleteRecurringExpense() {
            if (!currentEditingRecurringExpense) {
                customAlert('错误', '未找到要删除的定期费用');
                return;
            }
            
            showDeleteRecurringConfirm(currentEditingRecurringExpense.description);
        }

        function handleEditRecurringExpense() {
            if (!currentEditingRecurringExpense) {
                customAlert('错误', '未找到要编辑的定期费用');
                return;
            }
            
            // 这里可以添加编辑定期费用的逻辑
            customAlert('编辑功能', '定期费用编辑功能待实现');
        }

        function handleRecurringDetailCancel() {
            const modal = document.getElementById('recurring-detail-modal');
            if (modal) modal.classList.add('hidden');
            currentEditingRecurringExpense = null;
        }

        function getFrequencyDisplayName(frequency) {
            const names = {
                'daily': '每日',
                'weekly': '每周',
                'monthly': '每月',
                'yearly': '每年'
            };
            return names[frequency] || frequency;
        }

        // --- 支付详情功能 ---
        function viewPaymentDetail(paymentId) {
            // 查找支付数据
            const payment = paymentsList.find(p => p.id === paymentId);
            if (!payment) {
                customAlert('错误', '未找到支付信息');
                return;
            }
            
            currentEditingPayment = payment;
            isOwnPayment = payment.payer === CURRENT_USER_ID; // 检查是否为自己创建的支付
            
            // 打开模态框
            const modal = document.getElementById('payment-detail-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializePaymentDetailForm(payment);
            }
        }

        function initializePaymentDetailForm(payment) {
            // 更新标题
            const titleElement = document.getElementById('payment-detail-title');
            if (titleElement) {
                titleElement.textContent = isOwnPayment ? '支付详情 (可编辑)' : '支付详情 (只读)';
            }
            
            // 填充基本信息
            document.getElementById('payment-detail-description').value = payment.description;
            document.getElementById('payment-detail-amount').value = payment.amount;
            document.getElementById('payment-detail-date').value = payment.date;
            
            // 显示付款人信息
            const payerElement = document.getElementById('payment-detail-payer');
            if (payerElement) {
                const payerName = groupMembers.find(m => m.id === payment.payer)?.name || payment.payer;
                payerElement.textContent = payment.payer === CURRENT_USER_ID ? `您 (${payerName})` : payerName;
            }
            
            // 初始化收款人选择
            const payeeSelect = document.getElementById('payment-detail-to');
            if (payeeSelect) {
                payeeSelect.innerHTML = '<option value="">请选择收款人</option>';
                groupMembers.forEach(member => {
                    if (member.id !== CURRENT_USER_ID) { // 排除自己
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.name;
                        if (member.id === payment.payee) {
                            option.selected = true;
                        }
                        payeeSelect.appendChild(option);
                    }
                });
            }
            
            // 初始化费用选择
            const expenseSelect = document.getElementById('payment-detail-for-expense');
            if (expenseSelect) {
                expenseSelect.innerHTML = '<option value="">请选择费用</option>';
                expensesList.forEach(expense => {
                    const option = document.createElement('option');
                    option.value = expense.id;
                    option.textContent = `${expense.description} - $${expense.amount} (${expense.date})`;
                    if (expense.id === payment.expenseId) {
                        option.selected = true;
                    }
                    expenseSelect.appendChild(option);
                });
            }
            
            // 根据权限设置表单状态
            setPaymentDetailFormEditable(isOwnPayment);
            
            // 更新操作按钮
            updatePaymentDetailActions();
        }

        function setPaymentDetailFormEditable(editable) {
            const form = document.getElementById('payment-detail-form');
            if (!form) return;
            
            // 获取所有输入字段
            const inputs = form.querySelectorAll('input, select, button');
            inputs.forEach(input => {
                if (editable) {
                    input.classList.remove('readonly-field');
                    input.removeAttribute('readonly');
                    input.disabled = false;
                } else {
                    input.classList.add('readonly-field');
                    input.setAttribute('readonly', 'readonly');
                    input.disabled = true;
                }
            });
            
            // 特殊处理文件上传
            const fileInput = document.getElementById('payment-detail-receipt-file');
            const fileLabel = document.querySelector('#payment-detail-receipt-upload-section label');
            if (fileInput && fileLabel) {
                if (editable) {
                    fileInput.disabled = false;
                    fileLabel.classList.remove('readonly-field');
                } else {
                    fileInput.disabled = true;
                    fileLabel.classList.add('readonly-field');
                }
            }
        }

        function updatePaymentDetailActions() {
            const actionsContainer = document.getElementById('payment-detail-actions');
            if (!actionsContainer) return;
            
            if (isOwnPayment) {
                // 自己创建的支付：显示删除和更新按钮
                actionsContainer.innerHTML = `
                    <button type="button" onclick="handleDeletePayment()"
                        class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                        删除支付
                    </button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="handlePaymentDetailCancel()"
                            class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                            取消
                        </button>
                        <button type="submit"
                            class="py-3 px-6 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200">
                            更新支付
                        </button>
                    </div>
                `;
            } else {
                // 其他人创建的支付：只显示关闭按钮
                actionsContainer.innerHTML = `
                    <div class="w-full flex justify-end">
                        <button type="button" onclick="handlePaymentDetailCancel()"
                            class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                            关闭
                        </button>
                    </div>
                `;
            }
        }

        function handleUpdatePayment(event) {
            event.preventDefault();
            
            if (!isOwnPayment) {
                customAlert('权限错误', '您只能更新自己创建的支付');
                return;
            }
            
            if (!currentEditingPayment) {
                customAlert('错误', '未找到要更新的支付');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            // 更新支付数据
            currentEditingPayment.description = data['payment-detail-description'];
            currentEditingPayment.amount = parseFloat(data['payment-detail-amount']);
            currentEditingPayment.date = data['payment-detail-date'];
            currentEditingPayment.payee = data['payment-detail-to'];
            currentEditingPayment.expenseId = data['payment-detail-for-expense'];

            let transactionSummary = `交易类型: 更新支付\n`;
            transactionSummary += `描述: ${data['payment-detail-description']}\n`;
            transactionSummary += `金额: $${parseFloat(data['payment-detail-amount']).toFixed(2)}\n`;
            transactionSummary += `收款人: ${groupMembers.find(m => m.id === data['payment-detail-to'])?.name || data['payment-detail-to']}\n`;
            transactionSummary += `支付费用: ${expensesList.find(e => e.id === data['payment-detail-for-expense'])?.description || data['payment-detail-for-expense']}\n`;
            transactionSummary += `付款人: ${CURRENT_USER_NAME}\n`;
            transactionSummary += `日期: ${data['payment-detail-date']}\n`;

            customAlert('支付已更新', transactionSummary);

            // 关闭模态框并刷新支付列表
            handlePaymentDetailCancel();
            refreshPaymentsList();
        }

        function handleDeletePayment() {
            if (!isOwnPayment) {
                customAlert('权限错误', '您只能删除自己创建的支付');
                return;
            }
            
            if (!currentEditingPayment) {
                customAlert('错误', '未找到要删除的支付');
                return;
            }
            
            // 使用自定义弹窗
            showDeletePaymentConfirm(currentEditingPayment.description);
        }

        function handlePaymentDetailCancel() {
            const modal = document.getElementById('payment-detail-modal');
            if (modal) modal.classList.add('hidden');
            currentEditingPayment = null;
            isOwnPayment = false;
        }

        function updatePaymentDetailFileNameDisplay(input) {
            const display = document.getElementById('payment-detail-file-name-display');
            if (display) {
                if (input.files.length > 0) {
                    display.textContent = input.files[0].name;
                } else {
                    display.textContent = '点击上传支付凭证图片 (最大 1MB)';
                }
            }
        }

        function refreshExpensesList() {
            initializeExpensesList();
        }

        function refreshPaymentsList() {
            initializePaymentsList();
        }

        // 初始化费用列表显示
        function initializeExpensesList() {
            const expensesListContainer = document.getElementById('expenses-list');
            const expenseCountElement = document.getElementById('expense-count');
            
            if (!expensesListContainer) return;
            
            // 更新费用计数
            if (expenseCountElement) {
                expenseCountElement.textContent = expensesList.length;
            }
            
            // 清空现有内容
            expensesListContainer.innerHTML = '';
            
            // 为每个费用添加点击事件
            expensesList.forEach(expense => {
                const isOwnExpense = expense.payer === CURRENT_USER_ID;
                
                const expenseItem = document.createElement('div');
                expenseItem.className = `expense-item flex items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-150 cursor-pointer ${isOwnExpense ? 'border-l-4 border-l-primary' : ''}`;
                expenseItem.onclick = () => viewExpenseDetail(expense.id);
                
                // 根据费用类型设置图标和颜色
                const isPositive = expense.amount > 0;
                const iconClass = isPositive ? 'bg-primary/10 text-primary' : 'bg-success/10 text-success';
                const amountClass = isPositive ? 'text-danger' : 'text-success';
                
                expenseItem.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 ${iconClass} rounded-full flex items-center justify-center text-lg font-bold mr-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5h6"></path>
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800 truncate">${expense.description}</p>
                        <p class="text-xs text-gray-500">日期: ${expense.date} | 付款人: ${groupMembers.find(m => m.id === expense.payer)?.name || expense.payer}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold ${amountClass}">$${expense.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${isOwnExpense ? '您创建的' : '其他成员创建'}</p>
                    </div>
                `;
                
                expensesListContainer.appendChild(expenseItem);
            });
        }

        // 初始化支付列表显示
        function initializePaymentsList() {
            const paymentsListContainer = document.getElementById('payments-list');
            const paymentCountElement = document.getElementById('payment-count');
            
            if (!paymentsListContainer) return;
            
            // 更新支付计数
            if (paymentCountElement) {
                // 只计算自己创建的支付
                const ownPaymentsCount = paymentsList.filter(p => p.payer === CURRENT_USER_ID).length;
                paymentCountElement.textContent = ownPaymentsCount;
            }
            
            // 清空现有内容
            paymentsListContainer.innerHTML = '';
            
            // 为每个支付添加点击事件（只显示自己创建的支付）
            const ownPayments = paymentsList.filter(payment => payment.payer === CURRENT_USER_ID);
            
            ownPayments.forEach(payment => {
                const isOwnPayment = payment.payer === CURRENT_USER_ID;
                
                const paymentItem = document.createElement('div');
                paymentItem.className = `expense-item flex items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-150 cursor-pointer ${isOwnPayment ? 'border-l-4 border-l-success' : ''}`;
                paymentItem.onclick = () => viewPaymentDetail(payment.id);
                
                const payeeName = groupMembers.find(m => m.id === payment.payee)?.name || payment.payee;
                const expenseDescription = expensesList.find(e => e.id === payment.expenseId)?.description || '未知费用';
                
                paymentItem.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-success/10 text-success rounded-full flex items-center justify-center text-lg font-bold mr-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800 truncate">${payment.description}</p>
                        <p class="text-xs text-gray-500">日期: ${payment.date} | 收款人: ${payeeName}</p>
                        <p class="text-xs text-gray-500">费用: ${expenseDescription}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-success">$${payment.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">您创建的</p>
                    </div>
                `;
                
                paymentsListContainer.appendChild(paymentItem);
            });
            
            // 如果没有自己创建的支付，显示提示信息
            if (ownPayments.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center p-6 text-gray-500';
                emptyMessage.innerHTML = `
                    <p>您还没有创建任何支付记录</p>
                    <p class="text-sm mt-2">点击"添加支付"按钮创建您的第一笔支付</p>
                `;
                paymentsListContainer.appendChild(emptyMessage);
            }
        }

        // --- 参与者选择功能 ---
        function renderParticipantSelection() {
            const container = document.querySelector('#participants-section .grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isSelf = member.id === CURRENT_USER_ID;
                const isChecked = selectedParticipants.has(member.id);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200 hover:bg-gray-50 transition duration-150';
                checkbox.innerHTML = `
                    <input type="checkbox" id="participant-${member.id}" 
                           ${isChecked ? 'checked' : ''} 
                           ${isSelf ? 'disabled' : ''}
                           onchange="handleParticipantChange('${member.id}', this.checked)"
                           class="participant-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    <label for="participant-${member.id}" class="flex items-center space-x-2 flex-1 cursor-pointer">
                        <div class="w-8 h-8 flex items-center justify-center bg-primary/10 text-primary rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${isSelf ? ' (您)' : ''}
                        </span>
                    </label>
                `;
                
                container.appendChild(checkbox);
            });
        }

        function handleParticipantChange(memberId, isChecked) {
            if (isChecked) {
                selectedParticipants.add(memberId);
            } else {
                selectedParticipants.delete(memberId);
            }
            
            // 重新计算分摊
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            initializeSplits(amount);
            updateSplitDetails();
        }

        // --- 定期费用功能 ---
        function toggleRecurringExpense() {
            recurringExpenseState.isRecurring = !recurringExpenseState.isRecurring;
            const options = document.getElementById('recurring-options');
            const toggle = document.querySelector('.recurring-toggle');
            const toggleSpan = toggle.querySelector('span:last-child');
            
            if (recurringExpenseState.isRecurring) {
                options.classList.add('expanded');
                toggle.classList.add('bg-primary');
                toggle.classList.remove('bg-gray-200');
                toggleSpan.classList.add('translate-x-6');
                toggleSpan.classList.remove('translate-x-1');
                updateRecurringPreview();
            } else {
                options.classList.remove('expanded');
                toggle.classList.remove('bg-primary');
                toggle.classList.add('bg-gray-200');
                toggleSpan.classList.remove('translate-x-6');
                toggleSpan.classList.add('translate-x-1');
            }
        }

        function selectFrequency(frequency) {
            recurringExpenseState.frequency = frequency;
            
            // 更新UI选中状态
            document.querySelectorAll('.frequency-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateRecurringPreview();
        }

        function updateRecurringPreview() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const initialDate = document.getElementById('date').value;
            const previewList = document.getElementById('preview-list');
            const previewSummary = document.getElementById('preview-summary');
            
            if (!recurringExpenseState.isRecurring || !initialDate) {
                previewList.innerHTML = `
                    <div class="preview-item p-3 rounded">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">初始费用</span>
                            <span class="text-sm text-gray-600">${initialDate || '选择日期'}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">金额: $${amount.toFixed(2)}</div>
                    </div>
                `;
                previewSummary.textContent = '共 1 笔费用';
                return;
            }
            
            const previews = generateRecurringPreviews(initialDate, amount);
            previewList.innerHTML = previews.map(preview => `
                <div class="preview-item p-3 rounded">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${preview.title}</span>
                        <span class="text-sm text-gray-600">${preview.date}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">金额: $${preview.amount.toFixed(2)}</div>
                </div>
            `).join('');
            
            previewSummary.textContent = `共 ${previews.length} 笔费用`;
        }

        function generateRecurringPreviews(startDate, amount) {
            const previews = [{
                title: '初始费用',
                date: startDate,
                amount: amount
            }];
            
            const start = new Date(startDate);
            const maxPreviews = 4; // 最多显示4个预览
            
            for (let i = 1; i <= maxPreviews; i++) {
                const nextDate = calculateNextDate(start, i);
                previews.push({
                    title: `第 ${i + 1} 次`,
                    date: nextDate.toISOString().split('T')[0],
                    amount: amount
                });
            }
            
            return previews;
        }

        function calculateNextDate(startDate, interval) {
            const date = new Date(startDate);
            
            switch (recurringExpenseState.frequency) {
                case 'daily':
                    date.setDate(date.getDate() + interval);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + (interval * 7));
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + interval);
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + interval);
                    break;
            }
            
            return date;
        }

        function getFrequencyDisplayName(frequency) {
            const names = {
                'daily': '每日',
                'weekly': '每周', 
                'monthly': '每月',
                'yearly': '每年'
            };
            return names[frequency] || frequency;
        }

        function initializeRecurringSettings() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('repeat-start').value = today;
            
            // 设置默认频率为每日
            selectFrequency('daily');
        }
        
        // --- 定期费用表单功能 ---
        function handleAddNewRecurringExpense() {
            const modal = document.getElementById('add-recurring-expense-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeRecurringExpenseForm();
            }
        }

        function initializeRecurringExpenseForm() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('repeat-start');
            const amountInput = document.getElementById('recurring-amount');
            
            if (dateInput) dateInput.value = today;
            if (amountInput) amountInput.value = '';
            
            const payerSelect = document.getElementById('recurring-payer');
            if (payerSelect) {
                payerSelect.innerHTML = '<option value="">请选择付款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    payerSelect.appendChild(option);
                });
            }
            
            recurringSelectedParticipants = new Set([CURRENT_USER_ID]);
            renderRecurringParticipantSelection();
            
            setRecurringSplitMethod('equal', false);
            initializeRecurringSplits(0);
            updateRecurringSplitDetails();
            
            // 初始化定期费用设置
            initializeRecurringSettings();
        }

        function renderRecurringParticipantSelection() {
            const container = document.querySelector('#recurring-participants-section .grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isChecked = recurringSelectedParticipants.has(member.id);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200 hover:bg-gray-50 transition duration-150';
                checkbox.innerHTML = `
                    <input type="checkbox" id="recurring-participant-${member.id}" 
                           ${isChecked ? 'checked' : ''}
                           onchange="handleRecurringParticipantChange('${member.id}', this.checked)"
                           class="participant-checkbox h-4 w-4 text-warning focus:ring-warning border-gray-300 rounded">
                    <label for="recurring-participant-${member.id}" class="flex items-center space-x-2 flex-1 cursor-pointer">
                        <div class="w-8 h-8 flex items-center justify-center bg-warning/10 text-warning rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${member.id === CURRENT_USER_ID ? ' (您)' : ''}
                        </span>
                    </label>
                `;
                
                container.appendChild(checkbox);
            });
        }

        function handleRecurringParticipantChange(memberId, isChecked) {
            if (isChecked) {
                recurringSelectedParticipants.add(memberId);
            } else {
                recurringSelectedParticipants.delete(memberId);
            }
            
            const amount = parseFloat(document.getElementById('recurring-amount').value) || 0;
            initializeRecurringSplits(amount);
            updateRecurringSplitDetails();
        }

        function initializeRecurringSplits(amount) {
            const activeMembers = groupMembers.filter(m => recurringSelectedParticipants.has(m.id));
            const memberCount = activeMembers.length;
            
            if (memberCount === 0) {
                recurringMemberSplits = [];
                return;
            }
            
            const equalSplit = (amount / memberCount);
            let totalAllocated = 0;

            const existingSplitsValid = recurringSplitMethod === 'exact' && recurringMemberSplits.length === memberCount;
            
            recurringMemberSplits = activeMembers.map((member, index) => {
                let splitAmount;

                if (existingSplitsValid) {
                    const oldSplit = recurringMemberSplits.find(s => s.id === member.id);
                    splitAmount = parseFloat(oldSplit?.amount || '0.00');
                } else {
                    let calculatedSplit = Math.floor(equalSplit * 100) / 100;
                    
                    if (index === memberCount - 1) {
                        calculatedSplit = amount - totalAllocated;
                    } else {
                        totalAllocated += calculatedSplit;
                    }
                    splitAmount = calculatedSplit;
                }

                const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                return {
                    id: member.id,
                    name: member.id === CURRENT_USER_ID ? `您 (${displayName})` : displayName,
                    amount: splitAmount.toFixed(2),
                };
            });
        }

        function setRecurringSplitMethod(method, triggerUpdate = true) {
            recurringSplitMethod = method;
            const methods = ['equal', 'exact'];
            
            methods.forEach(m => {
                const btn = document.getElementById(`recurring-split-${m}`);
                if (btn) {
                    if (m === method) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
            
            if (triggerUpdate) {
                const amountInput = document.getElementById('recurring-amount');
                const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
                initializeRecurringSplits(amount);
                updateRecurringSplitDetails();
            }
        }

        function handleRecurringSplitInputChange(memberId, value) {
            const index = recurringMemberSplits.findIndex(s => s.id === memberId);
            if (index !== -1) {
                recurringMemberSplits[index].amount = parseFloat(value).toFixed(2);
            }
            updateRecurringSplitSummary();
        }

        function handleRecurringAmountChange() {
            const amountInput = document.getElementById('recurring-amount');
            const newAmount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            initializeRecurringSplits(newAmount);
            updateRecurringSplitDetails();
            updateRecurringPreview();
        }

        function updateRecurringSplitDetails() {
            const splitList = document.getElementById('recurring-split-list');
            const amountInput = document.getElementById('recurring-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!splitList) return;
            
            splitList.innerHTML = '';
            
            const sectionTitle = document.querySelector('#recurring-split-details-section h4');
            if (sectionTitle) {
                sectionTitle.textContent = `分摊详情 (${getSplitMethodName(recurringSplitMethod)})`;
            }

            if (recurringSplitMethod === 'equal') {
                initializeRecurringSplits(amount);

                recurringMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    listItem.innerHTML = `
                        <span>${split.name}</span>
                        <span class="font-medium text-gray-900">$ ${split.amount}</span>
                    `;
                    splitList.appendChild(listItem);
                });

            } else {
                recurringMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    
                    listItem.innerHTML = `
                        <label for="recurring-split-${split.id}" class="w-1/3 text-gray-700">${split.name}</label>
                        <div class="relative w-2/3">
                            <input type="number" id="recurring-split-${split.id}" 
                                   value="${split.amount}"
                                   min="0" step="0.01" required
                                   oninput="handleRecurringSplitInputChange('${split.id}', this.value)"
                                   class="block w-full pr-10 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                                   placeholder="0.00">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">$</span>
                            </div>
                        </div>
                    `;
                    splitList.appendChild(listItem);
                });
            }
            updateRecurringSplitSummary();
        }

        function updateRecurringSplitSummary() {
            const summaryDiv = document.getElementById('recurring-split-summary');
            const amountInput = document.getElementById('recurring-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!summaryDiv) return;
            
            let totalSplit = 0;
            let isBalanced = true;

            totalSplit = recurringMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            isBalanced = Math.abs(totalSplit - amount) < 0.01;
            
            const remaining = (amount - totalSplit).toFixed(2);
            
            summaryDiv.innerHTML = `
                <p class="text-sm flex justify-between">
                    <span class="font-medium text-gray-700">总分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${totalSplit.toFixed(2)}</span>
                </p>
                <p class="text-sm flex justify-between mt-1">
                    <span class="font-medium text-gray-700">待分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${remaining}</span>
                </p>
                ${!isBalanced ? `<p class="text-xs text-unbalanced mt-1">**警告:** 分摊总额 $${totalSplit.toFixed(2)} 与费用总额 $${amount.toFixed(2)} 不匹配。</p>` : ''}
            `;

            const submitButton = document.querySelector('#add-recurring-expense-modal button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = !isBalanced;
                submitButton.classList.toggle('opacity-50', !isBalanced);
                submitButton.classList.toggle('cursor-not-allowed', !isBalanced);
            }
        }

        function handleSaveRecurringExpense(event) {
            event.preventDefault();
            
            const amountInput = document.getElementById('recurring-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            let totalSplit = recurringMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            if (Math.abs(totalSplit - amount) > 0.01) {
                customAlert('提交失败', '分摊总额与费用总额不匹配，请调整分摊详情。');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            const newRecurringExpense = {
                id: 'recurring_' + Date.now(),
                description: data['recurring-description'],
                amount: parseFloat(data['recurring-amount']),
                startDate: data['repeat-start'],
                endDate: data['repeat-end'] || null,
                frequency: recurringExpenseState.frequency,
                payer: data['recurring-payer'],
                participants: Array.from(recurringSelectedParticipants),
                splitMethod: recurringSplitMethod,
                splits: [...recurringMemberSplits],
                isActive: true
            };
            
            recurringExpensesList.unshift(newRecurringExpense);
            customAlert('新定期费用已保存', `定期费用 "${data['recurring-description']}" 已成功创建`);

            const modal = document.getElementById('add-recurring-expense-modal');
            if (modal) modal.classList.add('hidden');
            
            refreshRecurringList();
        }

        function handleRecurringCancel() {
            const modal = document.getElementById('add-recurring-expense-modal');
            if (modal) modal.classList.add('hidden');
        }

        // --- 定期费用功能 ---
        function selectFrequency(frequency) {
            recurringExpenseState.frequency = frequency;
            
            // 更新UI选中状态
            document.querySelectorAll('.frequency-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateRecurringPreview();
        }

        function updateRecurringPreview() {
            const amount = parseFloat(document.getElementById('recurring-amount').value) || 0;
            const initialDate = document.getElementById('repeat-start').value;
            const previewList = document.getElementById('preview-list');
            const previewSummary = document.getElementById('preview-summary');
            
            if (!initialDate) {
                previewList.innerHTML = `
                    <div class="preview-item p-3 rounded">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">初始费用</span>
                            <span class="text-sm text-gray-600">${initialDate || '选择日期'}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">金额: $${amount.toFixed(2)}</div>
                    </div>
                `;
                previewSummary.textContent = '共 1 笔费用';
                return;
            }
            
            const previews = generateRecurringPreviews(initialDate, amount);
            previewList.innerHTML = previews.map(preview => `
                <div class="preview-item p-3 rounded">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${preview.title}</span>
                        <span class="text-sm text-gray-600">${preview.date}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">金额: $${preview.amount.toFixed(2)}</div>
                </div>
            `).join('');
            
            previewSummary.textContent = `共 ${previews.length} 笔费用`;
        }

        function generateRecurringPreviews(startDate, amount) {
            const previews = [{
                title: '初始费用',
                date: startDate,
                amount: amount
            }];
            
            const start = new Date(startDate);
            const maxPreviews = 4; // 最多显示4个预览
            
            for (let i = 1; i <= maxPreviews; i++) {
                const nextDate = calculateNextDate(start, i);
                previews.push({
                    title: `第 ${i + 1} 次`,
                    date: nextDate.toISOString().split('T')[0],
                    amount: amount
                });
            }
            
            return previews;
        }

        function calculateNextDate(startDate, interval) {
            const date = new Date(startDate);
            
            switch (recurringExpenseState.frequency) {
                case 'daily':
                    date.setDate(date.getDate() + interval);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + (interval * 7));
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + interval);
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + interval);
                    break;
            }
            
            return date;
        }

        function initializeRecurringSettings() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('repeat-start').value = today;
            
            // 设置默认频率为每日
            selectFrequency('daily');
        }

        // --- 删除确认功能 ---
        function showDeleteRecurringConfirm(expenseDescription) {
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            
            if (modal && message) {
                message.textContent = `您确定要删除定期费用 "${expenseDescription}" 吗？此操作无法撤销。`;
                modal.classList.remove('hidden');
            }
        }

        function confirmDeleteRecurringExpense() {
            if (!currentEditingRecurringExpense) {
                customAlert('错误', '未找到要删除的定期费用');
                closeDeleteConfirm();
                return;
            }
            
            const index = recurringExpensesList.findIndex(e => e.id === currentEditingRecurringExpense.id);
            if (index !== -1) {
                recurringExpensesList.splice(index, 1);
            }
            
            customAlert('定期费用已删除', `定期费用 "${currentEditingRecurringExpense.description}" 已被删除`);
            
            closeDeleteConfirm();
            handleRecurringDetailCancel();
            refreshRecurringList();
        }

        // --- 支付功能 ---
        function handleAddNewPayment() {
            const modal = document.getElementById('add-payment-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializePaymentForm();
            }
        }

        function initializePaymentForm() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('payment-date');
            const amountInput = document.getElementById('payment-amount');
            
            if (dateInput) dateInput.value = today;
            if (amountInput) amountInput.value = '';
            
            // 初始化收款人选择
            const paymentToSelect = document.getElementById('payment-to');
            if (paymentToSelect) {
                paymentToSelect.innerHTML = '<option value="">请选择收款人</option>';
                groupMembers.forEach(member => {
                    if (member.id !== CURRENT_USER_ID) { // 排除自己
                        const displayName = member.name.replace(/\s*\(.*\)/, '').trim();
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = displayName;
                        paymentToSelect.appendChild(option);
                    }
                });
            }
            
            // 初始化费用选择
            const paymentForExpenseSelect = document.getElementById('payment-for-expense');
            if (paymentForExpenseSelect) {
                paymentForExpenseSelect.innerHTML = '<option value="">请选择费用</option>';
                expensesList.forEach(expense => {
                    const option = document.createElement('option');
                    option.value = expense.id;
                    option.textContent = `${expense.description} - $${expense.amount} (${expense.date})`;
                    paymentForExpenseSelect.appendChild(option);
                });
            }
            
            const fileNameDisplay = document.getElementById('payment-file-name-display');
            if (fileNameDisplay) fileNameDisplay.textContent = '点击上传支付凭证图片 (最大 1MB)';
            
            const fileInput = document.getElementById('payment-receipt-file');
            if(fileInput) fileInput.value = null;
        }

        function handlePaymentCancel() {
            const modal = document.getElementById('add-payment-modal');
            if (modal) modal.classList.add('hidden');
        }

        function handleSavePayment(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            const paymentTo = groupMembers.find(m => m.id === data['payment-to'])?.name || data['payment-to'];
            const paymentForExpense = expensesList.find(e => e.id === data['payment-for-expense'])?.description || data['payment-for-expense'];

            // 创建新支付
            const newPayment = {
                id: 'payment_' + Date.now(),
                description: data['payment-description'],
                amount: parseFloat(data['payment-amount']),
                date: data['payment-date'],
                payer: CURRENT_USER_ID,
                payee: data['payment-to'],
                expenseId: data['payment-for-expense'],
                receipt: null
            };
            
            // 添加到支付列表
            paymentsList.unshift(newPayment);

            let paymentSummary = `交易类型: 支付 (Payment)\n`;
            paymentSummary += `描述: ${data['payment-description']}\n`;
            paymentSummary += `金额: $${parseFloat(data['payment-amount']).toFixed(2)}\n`;
            paymentSummary += `收款人: ${paymentTo}\n`;
            paymentSummary += `支付费用: ${paymentForExpense}\n`;
            paymentSummary += `付款人: ${CURRENT_USER_NAME}\n`;
            paymentSummary += `日期: ${data['payment-date']}\n`;
            
            const fileInput = document.getElementById('payment-receipt-file');
            paymentSummary += `支付凭证: ${fileInput && fileInput.files.length > 0 ? fileInput.files[0].name : '无'}\n`;

            customAlert('新支付已保存', paymentSummary);

            const modal = document.getElementById('add-payment-modal');
            if (modal) modal.classList.add('hidden');
            
            // 刷新支付列表
            refreshPaymentsList();
        }

        function updatePaymentFileNameDisplay(input) {
            const display = document.getElementById('payment-file-name-display');
            if (display) {
                if (input.files.length > 0) {
                    display.textContent = input.files[0].name;
                } else {
                    display.textContent = '点击上传支付凭证图片 (最大 1MB)';
                }
            }
        }

        function renderMemberList() {
            const container = document.getElementById('member-list-container');
            const activeMemberCount = document.getElementById('active-member-count');
            const memberCount = document.getElementById('member-count');
            
            if (container) container.innerHTML = '';
            
            if (activeMemberCount) activeMemberCount.textContent = groupMembers.length;
            if (memberCount) memberCount.textContent = groupMembers.length;

            groupMembers.forEach(member => {
                const isAdmin = member.isAdmin;
                const isSelf = member.id === CURRENT_USER_ID;
                const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                let balanceText;
                let balanceColorClass;

                if (member.balance > 0.01) {
                    balanceText = `应收 ¥${member.balance.toFixed(2)}`;
                    balanceColorClass = 'text-success font-semibold';
                } else if (member.balance < -0.01) {
                    balanceText = `欠款 ¥${Math.abs(member.balance).toFixed(2)}`;
                    balanceColorClass = 'text-danger font-semibold';
                } else {
                    balanceText = '已结算';
                    balanceColorClass = 'text-gray-500';
                }

                const memberCard = document.createElement('div');
                memberCard.className = 'flex items-center justify-between p-4 bg-white rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition duration-150';
                memberCard.innerHTML = `
                    <div class="flex items-center space-x-4 flex-1 min-w-0">
                        <div class="w-10 h-10 flex items-center justify-center bg-primary/10 text-primary rounded-full font-bold text-lg flex-shrink-0">
                            ${displayName[0]}
                        </div>
                        <div class="min-w-0">
                            <p class="text-base font-semibold text-gray-900 truncate flex items-center">
                                ${displayName}
                                ${isAdmin ? '<span class="ml-2 text-xs bg-primary text-white px-2 py-0.5 rounded-full font-medium">管理员</span>' : ''}
                                ${isSelf ? '<span class="ml-2 text-xs bg-gray-400 text-white px-2 py-0.5 rounded-full font-medium">您</span>' : ''}
                            </p>
                            <p class="text-sm text-gray-500 truncate">${member.email}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 flex-shrink-0">
                        <span class="text-right text-sm w-28 ${balanceColorClass}">
                            ${balanceText}
                        </span>
                    </div>
                `;

                container.appendChild(memberCard);
            });
        }

        // --- 邀请成员逻辑 ---
        function clearInviteForm() {
            const emailInput = document.getElementById('invite-user-email-input');
            if (emailInput) emailInput.value = '';
        }

        function inviteNewMember() {
            const emailInput = document.getElementById('invite-user-email-input');
            if (!emailInput) return;
            
            const email = emailInput.value.trim();

            if (!isValidEmail(email)) {
                customAlert('输入错误', '请输入一个有效的电子邮件地址。');
                return;
            }
            
            const inviteLoadingMessage = document.getElementById('invite-loading-message');
            const inviteSubmitButton = document.getElementById('invite-submit-button');
            
            if (inviteLoadingMessage) inviteLoadingMessage.classList.remove('hidden');
            if (inviteSubmitButton) inviteSubmitButton.disabled = true;

            setTimeout(() => {
                if (inviteLoadingMessage) inviteLoadingMessage.classList.add('hidden');
                if (inviteSubmitButton) inviteSubmitButton.disabled = false;
                
                if (groupMembers.some(m => m.email === email)) {
                     customAlert('邀请失败', `邮箱 ${email} 已是群组成员。`);
                     return;
                }

                // 成员版只能发送邀请，不能直接添加
                customAlert('邀请已发送', `已向 ${email} 发送邀请！等待管理员批准。`);
                clearInviteForm();
            }, 1500);
        }

        // --- 费用表单相关函数 ---
        function initializeSplits(amount) {
             // 只包含选中的参与者
             const activeMembers = groupMembers.filter(m => selectedParticipants.has(m.id));
             const memberCount = activeMembers.length;
             
             if (memberCount === 0) {
                 memberSplits = [];
                 return;
             }
             
             const equalSplit = (amount / memberCount);
             let totalAllocated = 0;

             const existingSplitsValid = currentSplitMethod === 'exact' && memberSplits.length === memberCount;
             
             memberSplits = activeMembers.map((member, index) => {
                 let splitAmount;

                 if (existingSplitsValid) {
                     const oldSplit = memberSplits.find(s => s.id === member.id);
                     splitAmount = parseFloat(oldSplit?.amount || '0.00');
                 } else {
                     let calculatedSplit = Math.floor(equalSplit * 100) / 100;
                     
                     if (index === memberCount - 1) {
                         calculatedSplit = amount - totalAllocated;
                     } else {
                         totalAllocated += calculatedSplit;
                     }
                     splitAmount = calculatedSplit;
                 }

                 const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                 return {
                     id: member.id,
                     name: member.id === CURRENT_USER_ID ? `您 (${displayName})` : displayName,
                     amount: splitAmount.toFixed(2),
                 };
             });
        }
        
        function setSplitMethod(method, triggerUpdate = true) {
            currentSplitMethod = method;
            const methods = ['equal', 'exact'];
            
            methods.forEach(m => {
                const btn = document.getElementById(`split-${m}`);
                if (btn) {
                    if (m === method) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
            
            if (triggerUpdate) {
                const amountInput = document.getElementById('amount');
                const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
                initializeSplits(amount);
                updateSplitDetails();
            }
        }

        function handleSplitInputChange(memberId, type, value) {
            if (type !== 'amount') return;

            const index = memberSplits.findIndex(s => s.id === memberId);
            if (index !== -1) {
                memberSplits[index].amount = parseFloat(value).toFixed(2);
            }
            updateSplitSummary();
        }
        
        function handleAmountChange() {
            const amountInput = document.getElementById('amount');
            const newAmount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            initializeSplits(newAmount);
            updateSplitDetails();
            updateRecurringPreview(); // 同时更新定期费用预览
        }

        function updateSplitDetails() {
            const splitList = document.getElementById('split-list');
            const amountInput = document.getElementById('amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!splitList) return;
            
            splitList.innerHTML = '';
            
            const sectionTitle = document.querySelector('#split-details-section h4');
            if (sectionTitle) {
                sectionTitle.textContent = `分摊详情 (${getSplitMethodName(currentSplitMethod)})`;
            }

            if (currentSplitMethod === 'equal') {
                 initializeSplits(amount);

                 memberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    listItem.innerHTML = `
                        <span>${split.name}</span>
                        <span class="font-medium text-gray-900">$ ${split.amount}</span>
                    `;
                    splitList.appendChild(listItem);
                });

            } else {
                const inputType = 'amount';
                const inputUnit = '$';
                const inputPlaceholder = '0.00';

                memberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    
                    listItem.innerHTML = `
                        <label for="split-${split.id}" class="w-1/3 text-gray-700">${split.name}</label>
                        <div class="relative w-2/3">
                            <input type="number" id="split-${split.id}" 
                                   value="${split.amount}"
                                   min="0" step="0.01" required
                                   oninput="handleSplitInputChange('${split.id}', '${inputType}', this.value)"
                                   class="block w-full pr-10 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                   placeholder="${inputPlaceholder}">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">${inputUnit}</span>
                            </div>
                        </div>
                    `;
                    splitList.appendChild(listItem);
                });
            }
            updateSplitSummary();
        }

        function updateSplitSummary() {
            const summaryDiv = document.getElementById('split-summary');
            const amountInput = document.getElementById('amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!summaryDiv) return;
            
            let totalSplit = 0;
            let isBalanced = true;

            totalSplit = memberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            isBalanced = Math.abs(totalSplit - amount) < 0.01;
            
            const remaining = (amount - totalSplit).toFixed(2);
            
            summaryDiv.innerHTML = `
                <p class="text-sm flex justify-between">
                    <span class="font-medium text-gray-700">总分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${totalSplit.toFixed(2)}</span>
                </p>
                <p class="text-sm flex justify-between mt-1">
                    <span class="font-medium text-gray-700">待分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${remaining}</span>
                </p>
                ${!isBalanced ? `<p class="text-xs text-unbalanced mt-1">**警告:** 分摊总额 $${totalSplit.toFixed(2)} 与费用总额 $${amount.toFixed(2)} 不匹配。</p>` : ''}
            `;

            const submitButton = document.querySelector('#add-expense-modal button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = !isBalanced;
                submitButton.classList.toggle('opacity-50', !isBalanced);
                submitButton.classList.toggle('cursor-not-allowed', !isBalanced);
            }
        }
        
        function getSplitMethodName(method) {
            switch (method) {
                case 'equal': return 'Equally Split';
                case 'exact': return 'Custom Amount';
                default: return '未知分摊';
            }
        }
        
        function updateFileNameDisplay(input) {
            const display = document.getElementById('file-name-display');
            if (display) {
                if (input.files.length > 0) {
                    display.textContent = input.files[0].name;
                } else {
                    display.textContent = '点击上传收据图片 (最大 1MB)';
                }
            }
        }
        
        // --- 费用表单初始化/提交/取消逻辑 ---
        function initializeExpenseForm() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            const amountInput = document.getElementById('amount');
            
            if (dateInput) dateInput.value = today;
            if (amountInput) amountInput.value = 100.00;
            
            // 重置参与者选择（包含自己）
            selectedParticipants = new Set([CURRENT_USER_ID]);
            renderParticipantSelection();
            
            setSplitMethod('equal', false);
            initializeSplits(100.00);
            updateSplitDetails();
            
            // 初始化定期费用设置
            initializeRecurringSettings();
            updateRecurringPreview();
            
            const fileNameDisplay = document.getElementById('file-name-display');
            if (fileNameDisplay) fileNameDisplay.textContent = '点击上传收据图片 (最大 1MB)';
            
            const fileInput = document.getElementById('receipt-file');
            if(fileInput) fileInput.value = null;
        }

        function handleAddNewExpense() {
            const modal = document.getElementById('add-expense-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeExpenseForm();
            }
        }
        
        function handleCancel() {
            const modal = document.getElementById('add-expense-modal');
            if (modal) modal.classList.add('hidden');
        }

        function handleSaveExpense(event) {
            event.preventDefault();
            
            const amountInput = document.getElementById('amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            let totalSplit = memberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            if (Math.abs(totalSplit - amount) > 0.01) {
                customAlert('提交失败', '分摊总额与费用总额不匹配，请调整分摊详情。');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            // 创建新费用
            const newExpense = {
                id: 'expense_' + Date.now(),
                description: data.description,
                amount: parseFloat(data.amount),
                date: data.date,
                payer: CURRENT_USER_ID,
                participants: Array.from(selectedParticipants),
                splitMethod: currentSplitMethod,
                splits: [...memberSplits]
            };
            
            // 添加到费用列表
            expensesList.unshift(newExpense);

            let transactionSummary = `交易类型: 费用 (Expense)\n`;
            transactionSummary += `描述: ${data.description}\n`;
            transactionSummary += `金额: $${parseFloat(data.amount).toFixed(2)}\n`;
            transactionSummary += `付款人: ${CURRENT_USER_NAME}\n`;
            transactionSummary += `参与者: ${Array.from(selectedParticipants).map(id => groupMembers.find(m => m.id === id)?.name).join(', ')}\n`;
            transactionSummary += `日期: ${data.date}\n`;
            transactionSummary += `分摊方式: ${getSplitMethodName(currentSplitMethod)}\n`;
            transactionSummary += `分摊详情: ${JSON.stringify(memberSplits.map(s => ({ id: s.id, amount: s.amount })))}`;
            
            // 添加定期费用信息
            if (recurringExpenseState.isRecurring) {
                transactionSummary += `\n定期费用: 是`;
                transactionSummary += `\n频率: ${getFrequencyDisplayName(recurringExpenseState.frequency)}`;
            }
            
            const fileInput = document.getElementById('receipt-file');
            transactionSummary += `\n收据文件: ${fileInput && fileInput.files.length > 0 ? fileInput.files[0].name : '无'}\n`;

            customAlert('新费用已保存', transactionSummary);

            const modal = document.getElementById('add-expense-modal');
            if (modal) modal.classList.add('hidden');
            
            // 刷新费用列表
            refreshExpensesList();
        }

        // --- 占位处理函数 ---
        let isMenuOpen = false;

        function toggleUserMenu() {
            const dropdown = document.getElementById('logout-dropdown');
            const caret = document.getElementById('caret-icon');
            if (dropdown && caret) {
                isMenuOpen = !isMenuOpen;
                dropdown.classList.toggle('hidden', !isMenuOpen);
                caret.classList.toggle('rotate-180', isMenuOpen);
            }
        }

        function handleBackToPreviousPage() {
            customAlert('导航', '返回上一页 (占位)');
        }

        function handleBackToDashboard() {
            customAlert('导航', '返回主页 (占位)');
        }

        function handleSettleUp() {
            customAlert('结算', '开始结算所有欠款流程 (占位)');
        }
        
        function handleMyProfile() {
             customAlert('导航', '查看我的资料 (占位)');
        }
        
        function handleLogout() {
             customAlert('导航', '执行退出登录操作 (占位)');
        }

        // 临时自定义 Alert 函数
        function closeCustomAlert() {
            const alertModal = document.getElementById('custom-alert-modal');
            if (alertModal) alertModal.classList.add('hidden');
        }

        function customAlert(title, message) {
            const alertModal = document.getElementById('custom-alert-modal');
            const alertMessage = document.getElementById('alert-message');
            
            if (!alertModal || !alertMessage) return;

            const existingDetails = alertModal.querySelector('pre');
            if (existingDetails) existingDetails.remove();
            
            if (message && typeof message === 'string' && message.includes('\n')) {
                const details = message.split('\n').join('<br>');
                const detailElement = document.createElement('pre');
                detailElement.className = 'text-xs text-left bg-gray-100 p-3 rounded-lg mt-2 overflow-x-auto';
                detailElement.innerHTML = details;
                alertMessage.parentNode.insertBefore(detailElement, alertMessage.nextSibling);
                alertMessage.textContent = title;
            } else {
                 alertMessage.textContent = `${title}: ${message || ''}`;
            }

            alertModal.classList.remove('hidden');
        }

        // --- 页面初始化和全局事件监听 ---
        document.addEventListener('DOMContentLoaded', () => {
            setActiveTab('expenses');

            const userDisplayElement = document.getElementById('user-display');
            if (userDisplayElement) {
                userDisplayElement.textContent = CURRENT_USER_NAME.replace(/\s*\(.*\)/, '').trim();
            }
            
            // 初始化渲染
            renderMemberList();
            initializeExpensesList();
            initializePaymentsList();
            
            // 添加定期费用相关事件监听
            document.getElementById('amount').addEventListener('input', updateRecurringPreview);
            document.getElementById('date').addEventListener('change', updateRecurringPreview);
            document.getElementById('repeat-start').addEventListener('change', updateRecurringPreview);
            document.getElementById('repeat-end').addEventListener('change', updateRecurringPreview);
        });
        
        window.addEventListener('click', (event) => {
            // 点击外部关闭用户菜单
            const userMenuContainer = document.getElementById('user-menu-container');
            if (isMenuOpen && userMenuContainer && !userMenuContainer.contains(event.target)) {
                toggleUserMenu();
            }
        });

        // 暴露所有函数到全局作用域
        window.toggleUserMenu = toggleUserMenu;
        window.handleBackToPreviousPage = handleBackToPreviousPage;
        window.handleBackToDashboard = handleBackToDashboard;
        window.handleAddNewExpense = handleAddNewExpense;
        window.handleAddNewPayment = handleAddNewPayment;
        window.handleSettleUp = handleSettleUp;
        window.handleMyProfile = handleMyProfile;
        window.handleLogout = handleLogout;
        window.customAlert = customAlert;
        window.closeCustomAlert = closeCustomAlert;
        window.setActiveTab = setActiveTab;
        window.clearInviteForm = clearInviteForm;
        window.inviteNewMember = inviteNewMember;
        window.handleCancel = handleCancel;
        window.handlePaymentCancel = handlePaymentCancel;
        window.handleSaveExpense = handleSaveExpense;
        window.handleSavePayment = handleSavePayment;
        window.setSplitMethod = setSplitMethod;
        window.handleSplitInputChange = handleSplitInputChange;
        window.updateFileNameDisplay = updateFileNameDisplay;
        window.updatePaymentFileNameDisplay = updatePaymentFileNameDisplay;
        window.handleAmountChange = handleAmountChange;
        // 暴露定期费用相关函数
        window.toggleRecurringExpense = toggleRecurringExpense;
        window.selectFrequency = selectFrequency;
        // 暴露参与者选择函数
        window.handleParticipantChange = handleParticipantChange;
        // 暴露费用详情相关函数
        window.viewExpenseDetail = viewExpenseDetail;
        window.setDetailSplitMethod = setDetailSplitMethod;
        window.handleDetailSplitInputChange = handleDetailSplitInputChange;
        window.handleDetailAmountChange = handleDetailAmountChange;
        window.handleDetailParticipantChange = handleDetailParticipantChange;
        window.handleUpdateExpense = handleUpdateExpense;
        window.handleDeleteExpense = handleDeleteExpense;
        window.handleDetailCancel = handleDetailCancel;
        // 暴露删除确认相关函数
        window.showDeleteConfirm = showDeleteConfirm;
        window.closeDeleteConfirm = closeDeleteConfirm;
        window.confirmDeleteExpense = confirmDeleteExpense;
        // 暴露支付详情相关函数
        window.viewPaymentDetail = viewPaymentDetail;
        window.handleUpdatePayment = handleUpdatePayment;
        window.handleDeletePayment = handleDeletePayment;
        window.handlePaymentDetailCancel = handlePaymentDetailCancel;
        window.updatePaymentDetailFileNameDisplay = updatePaymentDetailFileNameDisplay;
        window.showDeletePaymentConfirm = showDeletePaymentConfirm;
        window.closeDeletePaymentConfirm = closeDeletePaymentConfirm;
        window.confirmDeletePayment = confirmDeletePayment;
        // 定期费用相关函数

        window.viewRecurringDetail = viewRecurringDetail;
    </script>

</body>
</html>

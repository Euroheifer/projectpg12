{% extends "menu.html" %}

{% block content %}
<main>
    <div class="content-wrapper">
        <div class="space-y-6">

            <!-- å¾…å¤„ç†é‚€è¯·å¡ç‰‡ -->
            <div class="dashboard-card bg-white shadow-xl rounded-xl p-6 border-t-4 border-indigo-500 fade-in">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fa-solid fa-envelope-open-text text-indigo-500 mr-2"></i>
                        å¾…å¤„ç†çš„ç¾¤ç»„é‚€è¯·
                    </h2>
                </div>

                <!-- ä¿®æ”¹é‚€è¯·éƒ¨åˆ† -->
                <div id="invitation-list-container" class="min-h-[150px]">
                    <!-- é‚€è¯·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-center p-6 text-gray-500">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>åŠ è½½é‚€è¯·ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„ç¾¤ç»„å¡ç‰‡ -->
        <div class="dashboard-card bg-white shadow-xl rounded-xl p-6 border-t-4 border-indigo-500 fade-in">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fa-solid fa-list-check text-indigo-500 mr-2"></i>
                    æˆ‘çš„ç¾¤ç»„
                </h2>
                <div class="flex space-x-3">
                    <button onclick="handleCreateGroup()"
                        class="flex items-center space-x-1 py-1 px-3 rounded-lg text-white bg-emerald-500 hover:bg-emerald-600 transition duration-150 text-sm shadow-md">
                        <i class="fa-solid fa-plus w-3 h-3"></i>
                        <span>åˆ›å»ºç¾¤ç»„</span>
                    </button>
                </div>
            </div>


            <!-- ä¿®æ”¹ç¾¤ç»„éƒ¨åˆ† -->
            <div id="my-groups-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[100px]">
                <!-- ç¾¤ç»„åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                <div class="col-span-full text-center p-6 text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                    <p>åŠ è½½ç¾¤ç»„ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç¾¤ç»„å¼¹çª— -->
    <div id="create-group-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full transform transition duration-300 scale-100">
            <h3 class="text-xl font-bold mb-4 text-center">åˆ›å»ºæ–°ç¾¤ç»„</h3>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2" for="group-name">
                    ç¾¤ç»„åç§°
                </label>
                <input id="group-name" type="text"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="è¾“å…¥ç¾¤ç»„åç§°">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2" for="group-description">
                    ç¾¤ç»„æè¿°
                </label>
                <textarea id="group-description"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 h-24 resize-none"
                    placeholder="è¾“å…¥ç¾¤ç»„æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeCreateGroupModal()"
                    class="flex-1 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-150">å–æ¶ˆ</button>
                <button onclick="createNewGroup()"
                    class="flex-1 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition duration-150">åˆ›å»º</button>
            </div>
        </div>
    </div>
    </div>
    </div>
</main>
{% endblock %}

<style>
    /* ç®¡ç†å‘˜å¾½ç« æ ·å¼ */
    .admin-badge {
        background: #FEE2E2;
        color: #DC2626;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-left: 8px;
    }

    /* ç¾¤ç»„å¡ç‰‡æ‚¬åœæ•ˆæœ */
    .group-card {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }

    .group-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
</style>

{% block extra_js %}
<!-- ä¼ ç»Ÿæ¨¡å¼åŠ è½½ - é¿å…ES6æ¨¡å—å…¼å®¹æ€§é—®é¢˜å’Œé‡å¤åŠ è½½ -->
<script>
    console.log('ğŸ”§ å¯ç”¨ä¼ ç»Ÿæ¨¡å¼åŠ è½½...');
    
    // åŸºç¡€åŠŸèƒ½ç«‹å³å¯ç”¨
    window.handleCreateGroup = function() {
        console.log('handleCreateGroup called');
        const modal = document.getElementById('create-group-modal');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            alert('åˆ›å»ºç¾¤ç»„åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    };
    
    window.closeCreateGroupModal = function() {
        console.log('closeCreateGroupModal called');
        const modal = document.getElementById('create-group-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    };
    
    window.createNewGroup = function() {
        console.log('createNewGroup called');
        const groupName = document.getElementById('group-name').value.trim();
        const groupDescription = document.getElementById('group-description').value.trim();
        
        if (!groupName) {
            alert('è¯·è¾“å…¥ç¾¤ç»„åç§°');
            return;
        }
        
        // è¿™é‡Œåº”è¯¥è°ƒç”¨APIåˆ›å»ºç¾¤ç»„
        // æš‚æ—¶æ¨¡æ‹ŸæˆåŠŸ
        alert('ç¾¤ç»„åˆ›å»ºåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
        window.closeCreateGroupModal();
    };
    
    // è®¤è¯æ£€æŸ¥å‡½æ•°
    window.getAuthToken = function() {
        return localStorage.getItem('access_token');
    };

    window.checkAuth = function() {
        const token = window.getAuthToken();
        if (!token) {
            console.warn('æœªæ‰¾åˆ°è®¤è¯token');
            window.location.href = '/login';
            return false;
        }
        return true;
    };
    
    console.log('âœ… ä¸»é¡µä¼ ç»Ÿæ¨¡å¼åŸºç¡€åŠŸèƒ½å·²åŠ è½½');
</script>

<!-- æ¡ä»¶åŠ è½½ï¼šæ£€æŸ¥åŠŸèƒ½çŠ¶æ€ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ä¸»é¡µDOMåŠ è½½å®Œæˆï¼Œæ£€æŸ¥åŠŸèƒ½çŠ¶æ€...');
    
    // æ£€æŸ¥è®¤è¯
    if (!window.checkAuth()) return;
    
    // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
    const functionsToCheck = [
        'handleCreateGroup',
        'closeCreateGroupModal', 
        'createNewGroup'
    ];
    
    let allFunctionsReady = true;
    functionsToCheck.forEach(funcName => {
        if (typeof window[funcName] !== 'function') {
            console.warn(`å‡½æ•° ${funcName} æœªå®šä¹‰`);
            allFunctionsReady = false;
        }
    });
    
    if (allFunctionsReady) {
        console.log('âœ… ä¸»é¡µæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸');
        
        // åˆå§‹åŒ–é¡µé¢å†…å®¹
        initializeHomePage();
    } else {
        console.warn('âš ï¸ æ£€æµ‹åˆ°ä¸»é¡µåŠŸèƒ½ç¼ºå¤±');
        alert('æ£€æµ‹åˆ°é¡µé¢åŠŸèƒ½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
});

function initializeHomePage() {
    console.log('åˆå§‹åŒ–ä¸»é¡µå†…å®¹...');
    
    // åŠ è½½é‚€è¯·åˆ—è¡¨
    loadInvitations();
    
    // åŠ è½½ç¾¤ç»„åˆ—è¡¨
    loadMyGroups();
}

function loadInvitations() {
    // æ¨¡æ‹ŸåŠ è½½é‚€è¯·
    const container = document.getElementById('invitation-list-container');
    if (container) {
        container.innerHTML = `
            <div class="text-center p-6 text-gray-500">
                <i class="fa-solid fa-inbox text-3xl mb-3"></i>
                <p>æš‚æ— å¾…å¤„ç†çš„é‚€è¯·</p>
            </div>
        `;
    }
}

function loadMyGroups() {
    // æ¨¡æ‹ŸåŠ è½½ç¾¤ç»„
    const container = document.getElementById('my-groups-list');
    if (container) {
        container.innerHTML = `
            <div class="col-span-full text-center p-6 text-gray-500">
                <i class="fa-solid fa-users text-3xl mb-3"></i>
                <p>æš‚æ— ç¾¤ç»„ï¼Œç‚¹å‡»"åˆ›å»ºç¾¤ç»„"å¼€å§‹</p>
            </div>
        `;
    }
}
</script>

{% endblock %}
{% extends "menu.html" %}

{% block content %}
<main>
    <div class="content-wrapper">
        <div class="space-y-6">

            <!-- å¾…å¤„ç†é‚€è¯·å¡ç‰‡ -->
            <div class="dashboard-card bg-white shadow-xl rounded-xl p-6 border-t-4 border-indigo-500 fade-in">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fa-solid fa-envelope-open-text text-indigo-500 mr-2"></i>
                        å¾…å¤„ç†çš„ç¾¤ç»„é‚€è¯·
                    </h2>
                </div>

                <!-- ä¿®æ”¹é‚€è¯·éƒ¨åˆ† -->
                <div id="invitation-list-container" class="min-h-[150px]">
                    <!-- é‚€è¯·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-center p-6 text-gray-500">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>åŠ è½½é‚€è¯·ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„ç¾¤ç»„å¡ç‰‡ -->
        <div class="dashboard-card bg-white shadow-xl rounded-xl p-6 border-t-4 border-indigo-500 fade-in">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fa-solid fa-list-check text-indigo-500 mr-2"></i>
                    æˆ‘çš„ç¾¤ç»„
                </h2>
                <div class="flex space-x-3">
                    <button onclick="handleCreateGroup()"
                        class="flex items-center space-x-1 py-1 px-3 rounded-lg text-white bg-emerald-500 hover:bg-emerald-600 transition duration-150 text-sm shadow-md">
                        <i class="fa-solid fa-plus w-3 h-3"></i>
                        <span>åˆ›å»ºç¾¤ç»„</span>
                    </button>
                </div>
            </div>


            <!-- ä¿®æ”¹ç¾¤ç»„éƒ¨åˆ† -->
            <div id="my-groups-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[100px]">
                <!-- ç¾¤ç»„åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                <div class="col-span-full text-center p-6 text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                    <p>åŠ è½½ç¾¤ç»„ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç¾¤ç»„å¼¹çª— -->
    <div id="create-group-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full transform transition duration-300 scale-100">
            <h3 class="text-xl font-bold mb-4 text-center">åˆ›å»ºæ–°ç¾¤ç»„</h3>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2" for="group-name">
                    ç¾¤ç»„åç§°
                </label>
                <input id="group-name" type="text"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="è¾“å…¥ç¾¤ç»„åç§°">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2" for="group-description">
                    ç¾¤ç»„æè¿°
                </label>
                <textarea id="group-description"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 h-24 resize-none"
                    placeholder="è¾“å…¥ç¾¤ç»„æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeCreateGroupModal()"
                    class="flex-1 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-150">å–æ¶ˆ</button>
                <button onclick="createNewGroup()"
                    class="flex-1 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition duration-150">åˆ›å»º</button>
            </div>
        </div>
    </div>
    </div>
    </div>
</main>
{% endblock %}

<style>
    /* ç®¡ç†å‘˜å¾½ç« æ ·å¼ */
    .admin-badge {
        background: #FEE2E2;
        color: #DC2626;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-left: 8px;
    }

    /* ç¾¤ç»„å¡ç‰‡æ‚¬åœæ•ˆæœ */
    .group-card {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }

    .group-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
</style>

{% block extra_js %}
<!-- ä¼ ç»Ÿæ¨¡å¼åŠ è½½ - é¿å…ES6æ¨¡å—å…¼å®¹æ€§é—®é¢˜å’Œé‡å¤åŠ è½½ -->
<script>
    console.log('ğŸ”§ å¯ç”¨ä¼ ç»Ÿæ¨¡å¼åŠ è½½...');
    
    // åŸºç¡€åŠŸèƒ½ç«‹å³å¯ç”¨
    window.handleCreateGroup = function() {
        console.log('handleCreateGroup called');
        const modal = document.getElementById('create-group-modal');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            alert('åˆ›å»ºç¾¤ç»„åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    };
    
    window.closeCreateGroupModal = function() {
        console.log('closeCreateGroupModal called');
        const modal = document.getElementById('create-group-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    };
    
    window.createNewGroup = function() {
        console.log('createNewGroup called');
        const groupName = document.getElementById('group-name').value.trim();
        const groupDescription = document.getElementById('group-description').value.trim();
        
        if (!groupName) {
            alert('è¯·è¾“å…¥ç¾¤ç»„åç§°');
            return;
        }
        
        const token = getAuthToken();
        if (!token) {
            alert('è¯·å…ˆç™»å½•');
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const createButton = document.querySelector('[onclick="createNewGroup()"]');
        if (createButton) {
            createButton.textContent = 'åˆ›å»ºä¸­...';
            createButton.disabled = true;
        }
        
        // è°ƒç”¨åç«¯APIåˆ›å»ºç¾¤ç»„
        fetch('/groups/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                name: groupName,
                description: groupDescription
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(error => {
                    throw new Error(error.detail || 'åˆ›å»ºç¾¤ç»„å¤±è´¥');
                });
            }
        })
        .then(data => {
            alert('ç¾¤ç»„åˆ›å»ºæˆåŠŸï¼');
            window.closeCreateGroupModal();
            // åˆ·æ–°ç¾¤ç»„åˆ—è¡¨è€Œä¸æ˜¯æ•´ä¸ªé¡µé¢
            loadMyGroups();
        })
        .catch(error => {
            console.error('åˆ›å»ºç¾¤ç»„é”™è¯¯:', error);
            alert(`åˆ›å»ºç¾¤ç»„å¤±è´¥: ${error.message}`);
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (createButton) {
                createButton.textContent = 'åˆ›å»ºç¾¤ç»„';
                createButton.disabled = false;
            }
        });
    };
    
    // è®¤è¯æ£€æŸ¥å‡½æ•°
    window.getAuthToken = function() {
        return localStorage.getItem('access_token');
    };

    window.checkAuth = function() {
        const token = window.getAuthToken();
        if (!token) {
            console.warn('æœªæ‰¾åˆ°è®¤è¯token');
            window.location.href = '/login';
            return false;
        }
        return true;
    };
    
    console.log('âœ… ä¸»é¡µä¼ ç»Ÿæ¨¡å¼åŸºç¡€åŠŸèƒ½å·²åŠ è½½');
</script>

<!-- æ¡ä»¶åŠ è½½ï¼šæ£€æŸ¥åŠŸèƒ½çŠ¶æ€ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ä¸»é¡µDOMåŠ è½½å®Œæˆï¼Œæ£€æŸ¥åŠŸèƒ½çŠ¶æ€...');
    
    // æ£€æŸ¥è®¤è¯
    if (!window.checkAuth()) return;
    
    // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
    const functionsToCheck = [
        'handleCreateGroup',
        'closeCreateGroupModal', 
        'createNewGroup'
    ];
    
    let allFunctionsReady = true;
    functionsToCheck.forEach(funcName => {
        if (typeof window[funcName] !== 'function') {
            console.warn(`å‡½æ•° ${funcName} æœªå®šä¹‰`);
            allFunctionsReady = false;
        }
    });
    
    if (allFunctionsReady) {
        console.log('âœ… ä¸»é¡µæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸');
        
        // åˆå§‹åŒ–é¡µé¢å†…å®¹
        initializeHomePage();
    } else {
        console.warn('âš ï¸ æ£€æµ‹åˆ°ä¸»é¡µåŠŸèƒ½ç¼ºå¤±');
        alert('æ£€æµ‹åˆ°é¡µé¢åŠŸèƒ½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
});

function initializeHomePage() {
    console.log('åˆå§‹åŒ–ä¸»é¡µå†…å®¹...');
    
    // åŠ è½½é‚€è¯·åˆ—è¡¨
    loadInvitations();
    
    // åŠ è½½ç¾¤ç»„åˆ—è¡¨
    loadMyGroups();
}

async function loadInvitations() {
    const token = getAuthToken();
    if (!token) {
        console.warn('æœªæ‰¾åˆ°è®¤è¯tokenï¼Œæ— æ³•åŠ è½½é‚€è¯·');
        const container = document.getElementById('invitation-list-container');
        if (container) {
            container.innerHTML = `
                <div class="text-center p-6 text-gray-500">
                    <i class="fa-solid fa-exclamation-triangle text-3xl mb-3"></i>
                    <p>è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹é‚€è¯·</p>
                </div>
            `;
        }
        return;
    }

    const container = document.getElementById('invitation-list-container');
    if (!container) {
        console.warn('æ‰¾ä¸åˆ°é‚€è¯·åˆ—è¡¨å®¹å™¨');
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = `
        <div class="text-center p-6 text-gray-500">
            <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
            <p>åŠ è½½é‚€è¯·ä¸­...</p>
        </div>
    `;

    try {
        // è°ƒç”¨åç«¯APIè·å–é‚€è¯·åˆ—è¡¨
        const response = await fetch('/invitations/me', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const invitations = await response.json();
            displayInvitations(invitations);
        } else {
            throw new Error('è·å–é‚€è¯·åˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½é‚€è¯·é”™è¯¯:', error);
        container.innerHTML = `
            <div class="text-center p-6 text-red-500">
                <i class="fa-solid fa-exclamation-triangle text-3xl mb-3"></i>
                <p>åŠ è½½é‚€è¯·å¤±è´¥: ${error.message}</p>
                <button onclick="loadInvitations()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    é‡æ–°åŠ è½½</button>
            </div>
        `;
    }
}

function displayInvitations(invitations) {
    const container = document.getElementById('invitation-list-container');
    if (!container) return;

    if (!invitations || invitations.length === 0) {
        container.innerHTML = `
            <div class="text-center p-6 text-gray-500">
                <i class="fa-solid fa-inbox text-3xl mb-3"></i>
                <p>æš‚æ— å¾…å¤„ç†çš„é‚€è¯·</p>
            </div>
        `;
        return;
    }

    const invitationsHtml = invitations.map(invitation => `
        <div class="bg-white rounded-lg shadow-md p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(invitation.group_name)}</h3>
                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">
                    ${invitation.invited_by_name} é‚€è¯·
                </span>
            </div>
            <p class="text-gray-600 text-sm mb-4">${escapeHtml(invitation.message || 'é‚€è¯·æ‚¨åŠ å…¥ç¾¤ç»„')}</p>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-500">
                    é‚€è¯·æ—¶é—´: ${new Date(invitation.created_at).toLocaleDateString()}
                </span>
                <div class="flex space-x-2">
                    <button onclick="acceptInvitation('${invitation.id}')" 
                            class="px-3 py-1 bg-emerald-500 text-white text-sm rounded hover:bg-emerald-600 transition-colors duration-200">
                        <i class="fa-solid fa-check mr-1"></i>æ¥å—
                    </button>
                    <button onclick="rejectInvitation('${invitation.id}')" 
                            class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors duration-200">
                        <i class="fa-solid fa-times mr-1"></i>æ‹’ç»
                    </button>
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = invitationsHtml;
}

async function acceptInvitation(invitationId) {
    const token = getAuthToken();
    if (!token) {
        alert('è¯·å…ˆç™»å½•');
        return;
    }

    try {
        const response = await fetch(`/invitations/${invitationId}/respond`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                action: 'accept'
            })
        });

        if (response.ok) {
            showMessage('å·²æˆåŠŸåŠ å…¥ç¾¤ç»„ï¼', 'success');
            // åˆ·æ–°é‚€è¯·åˆ—è¡¨å’Œç¾¤ç»„åˆ—è¡¨
            loadInvitations();
            loadMyGroups();
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'æ¥å—é‚€è¯·å¤±è´¥');
        }
    } catch (error) {
        console.error('æ¥å—é‚€è¯·é”™è¯¯:', error);
        showMessage(`æ¥å—é‚€è¯·å¤±è´¥: ${error.message}`, 'error');
    }
}

async function rejectInvitation(invitationId) {
    const token = getAuthToken();
    if (!token) {
        alert('è¯·å…ˆç™»å½•');
        return;
    }

    try {
        const response = await fetch(`/invitations/${invitationId}/respond`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                action: 'reject'
            })
        });

        if (response.ok) {
            showMessage('å·²æ‹’ç»é‚€è¯·', 'success');
            // åˆ·æ–°é‚€è¯·åˆ—è¡¨
            loadInvitations();
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'æ‹’ç»é‚€è¯·å¤±è´¥');
        }
    } catch (error) {
        console.error('æ‹’ç»é‚€è¯·é”™è¯¯:', error);
        showMessage(`æ‹’ç»é‚€è¯·å¤±è´¥: ${error.message}`, 'error');
    }
}

function loadMyGroups() {
    const token = getAuthToken();
    if (!token) {
        console.warn('æœªæ‰¾åˆ°è®¤è¯tokenï¼Œæ— æ³•åŠ è½½ç¾¤ç»„');
        return;
    }

    const container = document.getElementById('my-groups-list');
    if (!container) {
        console.warn('æ‰¾ä¸åˆ°ç¾¤ç»„åˆ—è¡¨å®¹å™¨');
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = `
        <div class="col-span-full text-center p-6 text-gray-500">
            <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
            <p>åŠ è½½ç¾¤ç»„ä¸­...</p>
        </div>
    `;

    // è°ƒç”¨åç«¯APIè·å–ç¾¤ç»„åˆ—è¡¨
    fetch('/groups/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(error => {
                throw new Error(error.detail || 'è·å–ç¾¤ç»„åˆ—è¡¨å¤±è´¥');
            });
        }
    })
    .then(groups => {
        displayGroups(groups);
    })
    .catch(error => {
        console.error('è·å–ç¾¤ç»„åˆ—è¡¨é”™è¯¯:', error);
        container.innerHTML = `
            <div class="col-span-full text-center p-6 text-red-500">
                <i class="fa-solid fa-exclamation-triangle text-3xl mb-3"></i>
                <p>åŠ è½½ç¾¤ç»„å¤±è´¥: ${error.message}</p>
                <button onclick="loadMyGroups()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    é‡æ–°åŠ è½½
                </button>
            </div>
        `;
    });
}

function displayGroups(groups) {
    const container = document.getElementById('my-groups-list');
    if (!container) return;

    if (!groups || groups.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center p-6 text-gray-500">
                <i class="fa-solid fa-users text-3xl mb-3"></i>
                <p>æš‚æ— ç¾¤ç»„ï¼Œç‚¹å‡»"åˆ›å»ºç¾¤ç»„"å¼€å§‹</p>
            </div>
        `;
        return;
    }

    // ç”Ÿæˆç¾¤ç»„å¡ç‰‡HTML
    const groupsHtml = groups.map(group => `
        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(group.name)}</h3>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                    ${group.id}
                </span>
            </div>
            <p class="text-gray-600 text-sm mb-4">${escapeHtml(group.description || 'æš‚æ— æè¿°')}</p>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-500">
                    ç®¡ç†å‘˜ID: ${group.admin_id}
                </span>
                <button onclick="enterGroup(${group.id})" 
                        class="px-4 py-2 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors duration-200">
                    è¿›å…¥ç¾¤ç»„
                </button>
            </div>
        </div>
    `).join('');

    container.innerHTML = groupsHtml;
}

// ç®€å•çš„HTMLè½¬ä¹‰å‡½æ•° - å…¨å±€å¯ç”¨
window.escapeHtml = function(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
};

// è¿›å…¥ç¾¤ç»„å‡½æ•°
function enterGroup(groupId) {
    console.log('è¿›å…¥ç¾¤ç»„:', groupId);
    window.location.href = `/groups/${groupId}`;
}

// æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•° - å…¨å±€å¯ç”¨
window.showMessage = function(message, type = 'info') {
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white max-w-sm transform transition-all duration-300 translate-x-full`;
    
    // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
    if (type === 'success') {
        messageDiv.classList.add('bg-emerald-500');
    } else if (type === 'error') {
        messageDiv.classList.add('bg-red-500');
    } else {
        messageDiv.classList.add('bg-blue-500');
    }
    
    // æ·»åŠ å›¾æ ‡
    let icon = '';
    if (type === 'success') {
        icon = '<i class="fa-solid fa-check-circle mr-2"></i>';
    } else if (type === 'error') {
        icon = '<i class="fa-solid fa-exclamation-circle mr-2"></i>';
    } else {
        icon = '<i class="fa-solid fa-info-circle mr-2"></i>';
    }
    
    messageDiv.innerHTML = `
        <div class="flex items-center">
            ${icon}
            <span>${escapeHtml(message)}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(messageDiv);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        messageDiv.classList.remove('translate-x-full');
    }, 100);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        messageDiv.classList.add('translate-x-full');
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 4000);
};
</script>

{% endblock %}
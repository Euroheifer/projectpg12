<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群组详情 | Project PG12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5', // Indigo-600
                        'primary-dark': '#4338CA', // Indigo-700
                        success: '#10B981', // Emerald-500
                        danger: '#F87171', // Red-400
                        warning: '#FBBF24', // Amber-400
                        balance: '#10B981', 
                        unbalanced: '#F87171', 
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F9FAFB;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .balance-card {
            transition: all 0.2s ease-in-out;
        }

        .tab-button.active {
            border-bottom: 3px solid #4F46E5;
            color: #4F46E5;
            font-weight: 600;
        }
        
        #add-expense-modal input[type="file"],
        #add-payment-modal input[type="file"],
        #expense-detail-modal input[type="file"],
        #payment-detail-modal input[type="file"] {
            display: none;
        }

        .split-toggle-btn {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-weight: 700;
            color: #4F46E5;
            background-color: white;
            transition-duration: 0.2s;
            border: none;
            border-right: 1px solid #4F46E5;
        }

        .split-toggle-btn:hover {
            background-color: #4F46E51A;
        }
        
        .split-toggle-btn.active {
            background-color: #4F46E5 !important; 
            color: white !important;
        }
        
        .split-toggle-btn:last-child {
            border-right: none;
        }
        
        .recurring-toggle {
            transition: all 0.2s ease-in-out;
        }
        
        .recurring-options {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .recurring-options.expanded {
            max-height: 500px;
        }
        
        .frequency-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .frequency-option:hover {
            border-color: #4F46E5;
            background-color: #f8faff;
        }
        
        .frequency-option.selected {
            border-color: #4F46E5;
            background-color: #4F46E5;
            color: white;
        }
        
        .preview-item {
            border-left: 3px solid #4F46E5;
            background-color: #f8faff;
        }
        
        .participant-checkbox {
            accent-color: #4F46E5;
        }
        
        .expense-item {
            transition: all 0.2s ease-in-out;
        }
        
        .expense-item:hover {
            transform: translateY(-2px);
        }
        
        .readonly-field {
            background-color: #f9fafb;
            cursor: not-allowed;
        }

        .management-menu-active {
            display: block !important;
        }
        
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-3 items-center h-16">

                <div class="flex items-center justify-start">
                    <button onclick="handleBackToPreviousPage()"
                        class="flex items-center space-x-1 text-gray-700 hover:text-primary transition duration-150 text-sm font-medium p-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span class="hidden sm:block">Back</span>
                    </button>
                </div>

                <div class="flex items-center justify-center">
                    <span class="text-xl font-bold text-gray-900 truncate">Project PG12 记账本</span>
                </div>

                <div class="flex items-center relative justify-end" id="user-menu-container">

                    <button id="user-display-button" onclick="toggleUserMenu()"
                        class="flex items-center space-x-1 p-2 rounded-lg text-gray-700 font-medium text-sm hover:bg-gray-100 transition duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                        <span id="user-display">张三</span>
                        <svg id="caret-icon" class="w-4 h-4 ml-1 transform transition-transform duration-200" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="logout-dropdown"
                        class="absolute right-0 top-full mt-2 w-40 bg-white rounded-lg shadow-xl py-1 z-10 hidden border border-gray-100">

                        <button onclick="handleMyProfile(); toggleUserMenu();"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-150 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>我的资料</span>
                        </button>

                        <button onclick="handleBackToDashboard(); toggleUserMenu();"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-150 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7m0 0l7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                            <span>主页</span>
                        </button>

                        <button onclick="handleLogout()"
                            class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition duration-150 flex items-center space-x-2 border-t border-gray-100 mt-1 pt-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-3m0-6V7a3 3 0 013-3h4"></path>
                            </svg>
                            <span>退出登录</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl border border-gray-100">

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
                <div class="flex items-center">
                    <h2 id="group-name-display" class="text-3xl font-extrabold text-gray-900 mb-4 sm:mb-0">
                        正在加载群组信息... <span class="text-sm font-normal text-gray-500">(ID: <span id="group-id-display">-</span>)</span>
                    </h2>
                    <span class="ml-3 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        <span id="user-role-display">加载中...</span>
                    </span>
                </div>
                <div class="flex flex-wrap gap-3 mt-4 sm:mt-0"> 
                    <button onclick="handleAddNewExpense()"
                        class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-primary hover:bg-primary-dark transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>添加费用</span>
                    </button>
                    
                    <button onclick="handleAddNewPayment()"
                        class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-success hover:bg-emerald-600 transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        <span>添加支付</span>
                    </button>
                </div>
            </div>

            <div id="group-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="balance-card bg-white p-6 rounded-xl border border-danger/20 shadow-lg">
                    <p class="text-sm font-medium text-danger">您欠款 (应付)</p>
                    <p class="text-3xl font-bold text-danger mt-1" id="balance-owed">¥0.00</p>
                    <p class="text-xs text-gray-500 mt-2">给 <span id="balance-owed-count">0</span> 位成员</p>
                </div>

                <div class="balance-card bg-white p-6 rounded-xl border border-success/20 shadow-lg">
                    <p class="text-sm font-medium text-success">被欠款 (应收)</p>
                    <p class="text-3xl font-bold text-success mt-1" id="balance-owing-me">¥0.00</p>
                    <p class="text-xs text-gray-500 mt-2">从 <span id="balance-owing-count">0</span> 位成员</p>
                </div>

                <div class="balance-card bg-white p-6 rounded-xl border border-warning/20 shadow-lg flex flex-col justify-between">
                    <div>
                        <p class="text-sm font-medium text-warning">建议结算</p>
                        <p class="text-xl font-bold text-gray-900 mt-1">总计 2 笔待清算</p>
                    </div>
                    <button onclick="handleSettleUp()"
                        class="w-full py-2 bg-warning/80 text-white rounded-lg hover:bg-warning transition duration-150 shadow-md transform hover:scale-[1.01] active:scale-[0.99] text-sm mt-3">
                        <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0012 4.499c-3.562 0-6.84 1.838-8.683 4.887m17.566 2h-5.545m-4.021 0h-5.545M5.636 12A8.001 8.001 0 0012 19.5c3.562 0 6.84-1.838 8.683-4.887"></path></svg>
                        <span>结算所有欠款</span>
                    </button>
                </div>
            </div>

            <!-- 导航栏 - 添加定期费用标签页 -->
            <div class="border-b border-gray-200 mb-6">
                <div class="flex space-x-8 overflow-x-auto">
                    <button id="tab-expenses" onclick="setActiveTab('expenses')"
                        class="tab-button active pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        费用 (<span id="expense-count">3</span>)
                    </button>
                    <button id="tab-recurring" onclick="setActiveTab('recurring')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        定期费用 (<span id="recurring-count">2</span>)
                    </button>
                    <button id="tab-payments" onclick="setActiveTab('payments')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        支付 (<span id="payment-count">2</span>)
                    </button>
                    <button id="tab-members" onclick="setActiveTab('members')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        成员 (<span id="member-count">4</span>)
                    </button>
                    
                    <button id="tab-invite" onclick="setActiveTab('invite')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        邀请成员
                    </button>
                    
                    <button id="tab-manage" onclick="setActiveTab('manage')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        管理群组
                    </button>

                    <button id="tab-audit" onclick="setActiveTab('audit')"
                        class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                        审计日志
                    </button>
                </div>
            </div>

            <!-- 费用内容 -->
            <div id="tab-content-expenses">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">最近的费用列表</h3>
                <div id="expenses-list" class="space-y-4">
                    <!-- 费用列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 定期费用内容 -->
            <div id="tab-content-recurring" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">定期费用列表</h3>
                    <button onclick="handleAddNewRecurringExpense()"
                        class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-warning hover:bg-amber-500 transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>添加定期费用</span>
                    </button>
                </div>
                <div id="recurring-list" class="space-y-4">
                    <!-- 定期费用列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 支付内容 -->
            <div id="tab-content-payments" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">最近的支付列表</h3>
                <div id="payments-list" class="space-y-4">
                    <!-- 支付列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 成员内容 -->
            <div id="tab-content-members" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center border-b pb-2">
                    群组成员 (<span id="active-member-count">4</span> 人)
                </h3>
                <div id="member-list-container" class="space-y-3">
                    <!-- 成员列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 邀请成员内容 -->
            <div id="tab-content-invite" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">邀请成员</h3>
                <div class="bg-white p-6 rounded-lg border border-gray-200 max-w-lg mx-auto">
                    <div class="space-y-4">
                        <p class="text-sm text-gray-600">请输入您希望邀请的用户的 **注册邮箱 (Email Address)**。系统将向该邮箱发送邀请链接。</p>
                        <label for="invite-user-email-input" class="block text-sm font-medium text-gray-700">要邀请的邮箱</label>
                        <input type="email" id="invite-user-email-input"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="例如: user@example.com">
                        <p id="invite-loading-message" class="text-sm text-warning hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-warning inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            正在发送邀请...
                        </p>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="clearInviteForm()"
                            class="py-2 px-4 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150 text-sm font-medium">
                            取消
                        </button>
                        <button onclick="inviteNewMember()" id="invite-submit-button"
                            class="py-2 px-4 rounded-lg text-white bg-success hover:bg-emerald-600 transition duration-150 shadow-md text-sm font-medium">
                            发送邀请
                        </button>
                    </div>
                </div>
            </div>

            <!-- 管理群组内容 -->
            <div id="tab-content-manage" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">群组管理</h3>
                <div class="bg-white p-6 rounded-lg border border-gray-200">
                    <div class="space-y-6">
                        <!-- 群组基本信息设置 -->
                        <div class="p-4 bg-gray-50 rounded-lg border">
                            <h4 class="font-medium mb-4 text-lg">群组基本信息</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="group-name-input" class="block text-sm font-medium text-gray-700 mb-1">
                                        群组名称
                                    </label>
                                    <input type="text" id="group-name-input" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                                        placeholder="输入群组名称" value="">
                                    <p class="text-xs text-gray-500 mt-1">群组名称将显示在所有成员界面中</p>
                                </div>
                                
                                <div>
                                    <label for="group-description-input" class="block text-sm font-medium text-gray-700 mb-1">
                                        群组描述 (可选)
                                    </label>
                                    <textarea id="group-description-input" rows="3"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                                        placeholder="描述这个群组的用途...">用于记录周末旅行相关费用</textarea>
                                </div>
                                
                                <div class="flex justify-end space-x-3 pt-2">
                                    <button type="button" onclick="resetGroupSettings()"
                                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                                        重置
                                    </button>
                                    <button type="button" onclick="saveGroupSettings()"
                                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition duration-150 shadow-md">
                                        保存更改
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- 审计日志内容 -->
            <div id="tab-content-audit" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">审计日志</h3>
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <p class="text-gray-600 text-center">审计日志功能页面</p>
                    <div class="mt-4 space-y-3">
                        <div class="p-3 bg-white rounded border">
                            <p class="font-medium">2025-10-27 15:30</p>
                            <p class="text-sm text-gray-600">用户 张三 添加了费用 "周末聚餐费用"</p>
                        </div>
                        <div class="p-3 bg-white rounded border">
                            <p class="font-medium">2025-10-26 10:15</p>
                            <p class="text-sm text-gray-600">用户 小明 添加了费用 "机场交通费"</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <!-- 模态框 -->
    <div id="custom-alert-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
            <p id="alert-message" class="text-lg font-medium mb-4 text-center"></p>
            <button onclick="closeCustomAlert()"
                class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition duration-150">确定</button>
        </div>
    </div>

    <div id="delete-confirm-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
            <div class="text-center">
                <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
                <p class="text-sm text-gray-600 mb-6" id="delete-confirm-message">您确定要删除这个费用吗？此操作无法撤销。</p>
                
                <div class="flex space-x-3">
                    <button onclick="closeDeleteConfirm()"
                        class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                        取消
                    </button>
                    <button onclick="confirmDeleteExpense()"
                        class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-payment-confirm-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
            <div class="text-center">
                <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
                <p class="text-sm text-gray-600 mb-6" id="delete-payment-confirm-message">您确定要删除这个支付吗？此操作无法撤销。</p>
                
                <div class="flex space-x-3">
                    <button onclick="closeDeletePaymentConfirm()"
                        class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                        取消
                    </button>
                    <button onclick="confirmDeletePayment()"
                        class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 角色更新模态框 -->
    <div id="role-update-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="w-12 h-12 bg-primary/20 text-primary rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">确认角色更新</h3>
                <p class="text-sm text-gray-600 mb-6" id="role-update-message">确定要将成员 "小明" 设为管理员吗？</p>
                
                <div class="flex space-x-3">
                    <button onclick="cancelUpdateRole()"
                        class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                        取消
                    </button>
                    <button onclick="confirmUpdateRole()"
                        class="flex-1 py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary-dark transition duration-150 text-sm font-medium">
                        确认更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 移除成员模态框 -->
    <div id="remove-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">确认移除</h3>
                <p class="text-sm text-gray-600 mb-6" id="remove-message">确定要将成员 "小明" 从群组中移除吗？</p>
                
                <div class="flex space-x-3">
                    <button onclick="cancelRemoveMember()"
                        class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                        取消
                    </button>
                    <button onclick="confirmRemoveMember()"
                        class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                        确认移除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加费用弹窗 -->
    <div id="add-expense-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加新费用</h2>

            <form id="expense-form" onsubmit="handleSaveExpense(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                        <input type="text" id="description" name="description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="例如：晚餐、酒店费用、杂货">
                    </div>

                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="amount" name="amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                placeholder="0.00" oninput="handleAmountChange()">
                        </div>
                    </div>

                    <div>
                        <label for="payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <select id="payer" name="payer" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="">请选择付款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="date" name="date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>

                    <div id="participants-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <!-- 参与者复选框将通过JavaScript动态生成 -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                    </div>

                    <!-- 移除了定期费用设置部分 -->
                    

                    <div id="receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">收据 / 证明 (可选)</label>
                        <label for="receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary hover:bg-primary/5 transition duration-150">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="file-name-display" class="text-gray-700">点击上传收据图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="receipt-file" name="receipt-file" accept="image/*" onchange="updateFileNameDisplay(this)">
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>

                    <div id="split-method-selection" class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>
                        
                        <div class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-primary">
                            <button type="button" onclick="setSplitMethod('equal')" id="split-equal"
                                class="split-toggle-btn active flex-1">
                                Equally Split
                            </button>
                            <button type="button" onclick="setSplitMethod('exact')" id="split-exact"
                                class="split-toggle-btn flex-1">
                                Custom Amount
                            </button>
                        </div>
                    </div>
                    
                    <div id="split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>
                        
                        <div id="split-list" class="space-y-3">
                            <!-- 分摊详情将通过JavaScript动态生成 -->
                        </div>

                        <div id="split-summary" class="mt-4 pt-3 border-t">
                            <!-- 分摊摘要将通过JavaScript动态生成 -->
                        </div>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6">
                    <button type="submit"
                        class="w-full py-3 bg-primary text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-primary-dark transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                        保存费用
                    </button>
                    <button type="button" onclick="handleCancel()"
                        class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
                </div>

            </form>
        </div>
    </div>

    <!-- 添加支付弹窗 -->
    <div id="add-payment-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加新支付</h2>

            <form id="payment-form" onsubmit="handleSavePayment(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="payment-description" class="block text-sm font-medium text-gray-700">支付描述</label>
                        <input type="text" id="payment-description" name="payment-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                            placeholder="例如：还款给小明、结算交通费">
                    </div>

                    <div>
                        <label for="payment-amount" class="block text-sm font-medium text-gray-700">支付金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="payment-amount" name="payment-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                                placeholder="0.00">
                        </div>
                    </div>

                    <div>
                        <label for="payment-to" class="block text-sm font-medium text-gray-700">支付给谁?</label>
                        <select id="payment-to" name="payment-to" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择收款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="payment-for-expense" class="block text-sm font-medium text-gray-700">为哪个费用支付?</label>
                        <select id="payment-for-expense" name="payment-for-expense" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择费用</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="payment-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <select id="payment-payer" name="payment-payer" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择付款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="payment-date" class="block text-sm font-medium text-gray-700">支付日期</label>
                        <input type="date" id="payment-date" name="payment-date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                    </div>
                    
                    <div id="payment-receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">支付凭证 (可选)</label>
                        <label for="payment-receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-success hover:bg-success/5 transition duration-150">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="payment-file-name-display" class="text-gray-700">点击上传支付凭证图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="payment-receipt-file" name="payment-receipt-file" accept="image/*" onchange="updatePaymentFileNameDisplay(this)">
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6">
                    <button type="submit"
                        class="w-full py-3 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                        保存支付
                    </button>
                    <button type="button" onclick="handlePaymentCancel()"
                        class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
                </div>

            </form>
        </div>
    </div>
    <!-- 费用详情弹窗 -->
    <div id="expense-detail-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="expense-detail-title">费用详情</h2>

            <form id="expense-detail-form" onsubmit="handleUpdateExpense(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="detail-description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                        <input type="text" id="detail-description" name="detail-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="例如：晚餐、酒店费用、杂货">
                    </div>

                    <div>
                        <label for="detail-amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="detail-amount" name="detail-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                placeholder="0.00" oninput="handleDetailAmountChange()">
                        </div>
                    </div>

                    <div>
                        <label for="detail-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <select id="detail-payer" name="detail-payer" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="">请选择付款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="detail-date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="detail-date" name="detail-date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                    </div>

                    <div id="detail-participants-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200" id="detail-participants-container">
                            <!-- 参与者复选框将通过JavaScript动态生成 -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                    </div>
                    
                    <div id="receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">收据 / 证明 (可选)</label>
                        <label for="receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary hover:bg-primary/5 transition duration-150">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="file-name-display" class="text-gray-700">点击上传收据图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="receipt-file" name="receipt-file" accept="image/*" onchange="updateFileNameDisplay(this)">
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>
                    
                    <!-- 分摊方式 -->
                    <div id="detail-split-method-selection" class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>
                        
                        <div class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-primary">
                            <button type="button" onclick="setDetailSplitMethod('equal')" id="detail-split-equal"
                                class="split-toggle-btn active flex-1">
                                Equally Split
                            </button>
                            <button type="button" onclick="setDetailSplitMethod('exact')" id="detail-split-exact"
                                class="split-toggle-btn flex-1">
                                Custom Amount
                            </button>
                        </div>
                    </div>
                    
                    <div id="detail-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>
                        
                        <div id="detail-split-list" class="space-y-3">
                            <!-- 分摊详情将通过JavaScript动态生成 -->
                        </div>

                        <div id="detail-split-summary" class="mt-4 pt-3 border-t">
                            <!-- 分摊摘要将通过JavaScript动态生成 -->
                        </div>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6 flex justify-between">
                    <button type="button" onclick="handleDeleteExpense()"
                        class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                        删除费用
                    </button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="handleDetailCancel()"
                            class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                            取消
                        </button>
                        <button type="submit"
                            class="py-3 px-6 bg-primary text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-primary-dark transition duration-200">
                            更新费用
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
    
    <!-- 添加定期费用弹窗 -->
    <div id="add-recurring-expense-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加定期费用</h2>

            <form id="recurring-expense-form" onsubmit="handleSaveRecurringExpense(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="recurring-description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                        <input type="text" id="recurring-description" name="recurring-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                            placeholder="例如：每月房租、每周清洁费">
                    </div>

                    <div>
                        <label for="recurring-amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="recurring-amount" name="recurring-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                                placeholder="0.00" oninput="handleRecurringAmountChange()">
                        </div>
                    </div>

                    <div>
                        <label for="recurring-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <select id="recurring-payer" name="recurring-payer" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                            <option value="">请选择付款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <!-- 定期费用设置 -->
                    <div id="recurring-section" class="border-t pt-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">定期费用设置</label>
                        </div>
                        
                        <div id="recurring-options" class="recurring-options expanded">
                            <!-- 频率选择 -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-3">重复频率</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="frequency-option selected" onclick="selectFrequency('daily')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每日</div>
                                            <div class="text-xs opacity-75">每天重复</div>
                                        </div>
                                    </div>
                                    <div class="frequency-option" onclick="selectFrequency('weekly')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每周</div>
                                            <div class="text-xs opacity-75">每周同一天</div>
                                        </div>
                                    </div>
                                    <div class="frequency-option" onclick="selectFrequency('monthly')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每月</div>
                                            <div class="text-xs opacity-75">每月同一天</div>
                                        </div>
                                    </div>
                                    <div class="frequency-option" onclick="selectFrequency('yearly')">
                                        <div class="text-center">
                                            <div class="text-lg font-semibold">每年</div>
                                            <div class="text-xs opacity-75">每年同一天</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 重复设置 -->
                            <div id="recurring-settings" class="space-y-4 mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="repeat-start" class="block text-sm font-medium text-gray-700">开始日期</label>
                                        <input type="date" id="repeat-start" name="repeat-start" required
                                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="repeat-end" class="block text-sm font-medium text-gray-700">结束日期 (可选)</label>
                                        <input type="date" id="repeat-end" name="repeat-end"
                                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                                    </div>
                                </div>
                            </div>

                            <!-- 预览区域 -->
                            <div id="recurring-preview" class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-900 mb-3">费用预览</h4>
                                <div id="preview-list" class="space-y-2">
                                    <div class="preview-item p-3 rounded">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">初始费用</span>
                                            <span class="text-sm text-gray-600" id="preview-initial-date">2025-10-28</span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1" id="preview-initial-amount">金额: $0.00</div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2" id="preview-summary">共 1 笔费用</p>
                            </div>
                        </div>
                    </div>

                    <div id="recurring-participants-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <!-- 参与者复选框将通过JavaScript动态生成 -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                    </div>

                    <div id="recurring-split-method-selection" class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>
                        
                        <div class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-warning">
                            <button type="button" onclick="setRecurringSplitMethod('equal')" id="recurring-split-equal"
                                class="split-toggle-btn active flex-1">
                                Equally Split
                            </button>
                            <button type="button" onclick="setRecurringSplitMethod('exact')" id="recurring-split-exact"
                                class="split-toggle-btn flex-1">
                                Custom Amount
                            </button>
                        </div>
                    </div>
                    
                    <div id="recurring-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>
                        
                        <div id="recurring-split-list" class="space-y-3">
                            <!-- 分摊详情将通过JavaScript动态生成 -->
                        </div>

                        <div id="recurring-split-summary" class="mt-4 pt-3 border-t">
                            <!-- 分摊摘要将通过JavaScript动态生成 -->
                        </div>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6">
                    <button type="submit"
                        class="w-full py-3 bg-warning text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-amber-500 transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                        保存定期费用
                    </button>
                    <button type="button" onclick="handleRecurringCancel()"
                        class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
                </div>

            </form>
        </div>
    </div>

    <!-- 定期费用详情弹窗 -->
    <div id="recurring-detail-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="recurring-detail-title">定期费用详情</h2>

            <div class="space-y-6">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                    <p class="mt-1 text-gray-900 font-medium" id="recurring-detail-description">每月房租</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">金额 ($)</label>
                    <p class="mt-1 text-gray-900 font-medium" id="recurring-detail-amount">$1500.00</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">谁支付了?</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-payer">张三</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">频率</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-frequency">每月</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">开始日期</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-start-date">2025-11-01</p>
                </div>

                <div id="recurring-detail-end-date-container">
                    <label class="block text-sm font-medium text-gray-700">结束日期</label>
                    <p class="mt-1 text-gray-900" id="recurring-detail-end-date">2026-10-31</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">状态</label>
                    <div class="mt-1">
                        <span id="recurring-detail-status" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success/10 text-success">
                            启用
                        </span>
                    </div>
                </div>

                <div id="recurring-detail-participants-section">
                    <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200" id="recurring-detail-participants-container">
                        <!-- 参与者列表将通过JavaScript动态生成 -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">分摊方式</label>
                    <p class="text-gray-900" id="recurring-detail-split-method">Equally Split</p>
                </div>
                
                <div id="recurring-detail-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold mb-2">分摊详情</h4>
                    
                    <div id="recurring-detail-split-list" class="space-y-3">
                        <!-- 分摊详情将通过JavaScript动态生成 -->
                    </div>
                </div>

            </div>

            <div class="mt-8 border-t pt-6 flex justify-between">
                <div class="flex space-x-3">
                    <button onclick="handleDisableRecurringExpense()" id="disable-recurring-btn"
                        class="py-3 px-6 bg-gray-600 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-gray-700 transition duration-200">
                        禁用
                    </button>
                    <button onclick="handleEnableRecurringExpense()" id="enable-recurring-btn" class="hidden"
                        class="py-3 px-6 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200">
                        启用
                    </button>
                    <button onclick="handleDeleteRecurringExpense()"
                        class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                        删除定期费用
                    </button>
                </div>
                <div class="flex space-x-3">
                    <button onclick="handleRecurringDetailCancel()"
                        class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        关闭
                    </button>
                    <button onclick="handleEditRecurringExpense()"
                        class="py-3 px-6 bg-warning text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-amber-500 transition duration-200">
                        编辑定期费用
                    </button>
                </div>
            </div>

        </div>
    </div>
 
 

    <!-- 支付详情弹窗 -->
    <div id="payment-detail-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">
            
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="payment-detail-title">支付详情</h2>

            <form id="payment-detail-form" onsubmit="handleUpdatePayment(event)">

                <div class="space-y-6">
                    
                    <div>
                        <label for="payment-detail-description" class="block text-sm font-medium text-gray-700">支付描述</label>
                        <input type="text" id="payment-detail-description" name="payment-detail-description" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                            placeholder="例如：还款给小明、结算交通费">
                    </div>

                    <div>
                        <label for="payment-detail-amount" class="block text-sm font-medium text-gray-700">支付金额 ($)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> $ </span>
                            </div>
                            <input type="number" id="payment-detail-amount" name="payment-detail-amount" required step="0.01" min="0.01"
                                class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                                placeholder="0.00">
                        </div>
                    </div>

                    <div>
                        <label for="payment-detail-to" class="block text-sm font-medium text-gray-700">支付给谁?</label>
                        <select id="payment-detail-to" name="payment-detail-to" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择收款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="payment-detail-for-expense" class="block text-sm font-medium text-gray-700">为哪个费用支付?</label>
                        <select id="payment-detail-for-expense" name="payment-detail-for-expense" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择费用</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="payment-detail-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                        <select id="payment-detail-payer" name="payment-detail-payer" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                            <option value="">请选择付款人</option>
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="payment-detail-date" class="block text-sm font-medium text-gray-700">支付日期</label>
                        <input type="date" id="payment-detail-date" name="payment-detail-date" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                    </div>
                    
                    <div id="payment-detail-receipt-upload-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">支付凭证 (可选)</label>
                        <label for="payment-detail-receipt-file"
                            class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-success hover:bg-success/5 transition duration-150">
                            <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span id="payment-detail-file-name-display" class="text-gray-700">点击上传支付凭证图片 (最大 1MB)</span>
                        </label>
                        <input type="file" id="payment-detail-receipt-file" name="payment-detail-receipt-file" accept="image/*" onchange="updatePaymentDetailFileNameDisplay(this)">
                        <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                    </div>

                </div>

                <div class="mt-8 border-t pt-6 flex justify-between">
                    <button type="button" onclick="handleDeletePayment()"
                        class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                        删除支付
                    </button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="handlePaymentDetailCancel()"
                            class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                            取消
                        </button>
                        <button type="submit"
                            class="py-3 px-6 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200">
                            更新支付
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <script>
        // --- 全局状态和数据 ---
        const CURRENT_USER_ID = 'user_self';
        const CURRENT_USER_NAME = '张三 (管理员)';
        const IS_CURRENT_USER_ADMIN = true;

        let memberToRemove = null;
        let memberToUpdateRole = null;
        
        // Mock 成员列表
        let groupMembers = [
            { id: 'user_self', name: CURRENT_USER_NAME, email: 'admin@example.com', isAdmin: true, balance: 0.00 },
            { id: 'user_2', name: '小明', email: 'xiaoming@example.com', isAdmin: false, balance: -15.50 },
            { id: 'user_3', name: '小红', email: 'xiaohong@example.com', isAdmin: true, balance: 30.00 },
            { id: 'user_4', name: '老王', email: 'laowang@example.com', isAdmin: false, balance: 0.00 }
        ];

        // Mock 费用列表
        let expensesList = [
            { 
                id: 'expense_1', 
                description: '周末聚餐费用', 
                amount: 225.00, 
                date: '2025-10-27', 
                payer: 'user_self',
                participants: ['user_self', 'user_2', 'user_3'],
                splitMethod: 'equal',
                splits: [
                    { id: 'user_self', name: '您 (张三)', amount: '75.00' },
                    { id: 'user_2', name: '小明', amount: '75.00' },
                    { id: 'user_3', name: '小红', amount: '75.00' }
                ]
            },
            { 
                id: 'expense_2', 
                description: '机场交通费', 
                amount: 60.00, 
                date: '2025-10-26', 
                payer: 'user_2',
                participants: ['user_self', 'user_2', 'user_3'],
                splitMethod: 'equal',
                splits: [
                    { id: 'user_self', name: '您 (张三)', amount: '20.00' },
                    { id: 'user_2', name: '小明', amount: '20.00' },
                    { id: 'user_3', name: '小红', amount: '20.00' }
                ]
            }
        ];

        // Mock 支付列表
        let paymentsList = [
            { 
                id: 'payment_1', 
                description: '还款给小明', 
                amount: 75.00, 
                date: '2025-10-28', 
                payer: 'user_self',
                payee: 'user_2',
                expenseId: 'expense_1',
                receipt: null
            },
            { 
                id: 'payment_2', 
                description: '结算交通费', 
                amount: 20.00, 
                date: '2025-10-27', 
                payer: 'user_self',
                payee: 'user_3',
                expenseId: 'expense_2',
                receipt: null
            }
        ];

        // Mock 定期费用列表
        let recurringExpensesList = [
            { 
                id: 'recurring_1', 
                description: '每月房租', 
                amount: 1500.00, 
                startDate: '2025-10-01',
                frequency: 'monthly',
                payer: 'user_self',
                participants: ['user_self', 'user_2', 'user_3'],
                splitMethod: 'equal',
                splits: [
                    { id: 'user_self', name: '您 (张三)', amount: '500.00' },
                    { id: 'user_2', name: '小明', amount: '500.00' },
                    { id: 'user_3', name: '小红', amount: '500.00' }
                ],
                isActive: true
            },
           
        ];

        // 费用相关状态
        let selectedParticipants = new Set([CURRENT_USER_ID]);
        let currentSplitMethod = 'equal';
        let memberSplits = [];
        let currentEditingExpense = null;
        let detailSelectedParticipants = new Set();
        let detailMemberSplits = [];
        let detailSplitMethod = 'equal';

        // 支付相关状态
        let currentEditingPayment = null;

        // 定期费用相关状态
        let recurringExpenseState = {
            isRecurring: false,
            frequency: 'daily',
            startDate: '',
            endDate: '',
        };
        let recurringSelectedParticipants = new Set([CURRENT_USER_ID]);
        let recurringSplitMethod = 'equal';
        let recurringMemberSplits = [];
        let currentEditingRecurringExpense = null;

        // --- 工具函数 ---
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // --- Tab 切换逻辑 ---
        let activeTab = 'expenses';
        
        function setActiveTab(tabName) {
            if (activeTab === tabName) return;

            const allTabs = ['expenses', 'recurring', 'payments', 'members', 'invite', 'manage', 'audit'];
            allTabs.forEach(tab => {
                const tabElement = document.getElementById(`tab-${tab}`);
                const contentElement = document.getElementById(`tab-content-${tab}`);
                
                if (tabElement) tabElement.classList.remove('active');
                if (contentElement) contentElement.classList.add('hidden');
            });

            const currentTab = document.getElementById(`tab-${tabName}`);
            const currentContent = document.getElementById(`tab-content-${tabName}`);
            
            if (currentTab) currentTab.classList.add('active');
            if (currentContent) currentContent.classList.remove('hidden');
            
            if (tabName === 'members') {
                renderMemberList();
            }
            else if (tabName === 'payments') {
                refreshPaymentsList();
            }
            else if (tabName === 'expenses') {
                refreshExpensesList();
            }
            else if (tabName === 'recurring') {
                refreshRecurringList();
            }
            else if (tabName === 'manage') {
                loadGroupSettings(); // 切换到管理标签时加载设置
            }
            
            activeTab = tabName;
        }

        // --- 群组管理逻辑 ---
        function loadGroupSettings() {
            // 从页面显示的群组名称获取数据
            const groupNameElement = document.getElementById('group-name-display');
            if (groupNameElement && !groupNameElement.textContent.includes('正在加载')) {
                const currentGroupName = groupNameElement.textContent.split(' (ID:')[0].trim();
                document.getElementById('group-name-input').value = currentGroupName;
            }
        }

        function saveGroupSettings() {
            const newName = document.getElementById('group-name-input').value.trim();
            const newDescription = document.getElementById('group-description-input').value.trim();
            
            if (!newName) {
                customAlert('错误', '群组名称不能为空');
                return;
            }
            
            // 更新群组名称显示
            const groupNameDisplay = document.getElementById('group-name-display');
            const groupIdText = groupNameDisplay.innerHTML.match(/\(ID:.*\)/)?.[0] || '(ID: 1)';
            groupNameDisplay.innerHTML = `${newName} <span class="text-sm font-normal text-gray-500">${groupIdText}</span>`;
            
            // 这里可以添加API调用保存到后端
            
            customAlert('保存成功', '群组设置已更新');
        }

        function resetGroupSettings() {
            loadGroupSettings();
            customAlert('已重置', '设置已恢复为原始值');
        }

        // --- 成员管理逻辑 ---
        function toggleMemberManagementMenu(event, memberId) {
            event.stopPropagation();
            document.querySelectorAll('.management-menu-active').forEach(menu => {
                if (menu.id !== `menu-${memberId}`) {
                    menu.classList.remove('management-menu-active');
                    menu.classList.add('hidden');
                }
            });

            const menu = document.getElementById(`menu-${memberId}`);
            if (menu) {
                menu.classList.toggle('hidden');
                menu.classList.toggle('management-menu-active');
            }
        }

        function renderMemberList() {
            const container = document.getElementById('member-list-container');
            const activeMemberCount = document.getElementById('active-member-count');
            const memberCount = document.getElementById('member-count');
            
            if (container) container.innerHTML = '';
            
            if (activeMemberCount) activeMemberCount.textContent = groupMembers.length;
            if (memberCount) memberCount.textContent = groupMembers.length;

            groupMembers.forEach(member => {
                const isAdmin = member.isAdmin;
                const isSelf = member.id === CURRENT_USER_ID;
                const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                let balanceText;
                let balanceColorClass;

                if (member.balance > 0.01) {
                    balanceText = `应收 ¥${member.balance.toFixed(2)}`;
                    balanceColorClass = 'text-success font-semibold';
                } else if (member.balance < -0.01) {
                    balanceText = `欠款 ¥${Math.abs(member.balance).toFixed(2)}`;
                    balanceColorClass = 'text-danger font-semibold';
                } else {
                    balanceText = '已结算';
                    balanceColorClass = 'text-gray-500';
                }

                const memberCard = document.createElement('div');
                memberCard.className = 'flex items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-150';
                memberCard.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-primary/10 text-primary rounded-full flex items-center justify-center text-lg font-bold mr-4">
                        ${displayName.charAt(0)}
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center">
                            <p class="font-medium text-gray-800">${member.name}</p>
                            ${isAdmin ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">管理员</span>' : ''}
                        </div>
                        <p class="text-xs text-gray-500">${member.email}</p>
                    </div>
                    <div class="text-right mr-4">
                        <p class="text-sm ${balanceColorClass}">${balanceText}</p>
                    </div>
                    ${!isSelf ? `
                    <div class="relative">
                        <button onclick="toggleMemberManagementMenu(event, '${member.id}')"
                            class="p-2 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                        </button>
                        <div id="menu-${member.id}" class="hidden absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-xl py-1 z-10 border border-gray-100">
                            <button onclick="handleUpdateRole('${member.id}'); toggleMemberManagementMenu(event, '${member.id}')"
                                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-150 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span>${isAdmin ? '移除管理员' : '设为管理员'}</span>
                            </button>
                            <button onclick="handleRemoveMember('${member.id}'); toggleMemberManagementMenu(event, '${member.id}')"
                                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition duration-150 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                <span>移除成员</span>
                            </button>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                if (container) container.appendChild(memberCard);
            });
        }

        // --- 角色更新逻辑 ---
        function handleUpdateRole(memberId) {
            memberToUpdateRole = groupMembers.find(m => m.id === memberId);
            if (!memberToUpdateRole) return;
            
            const modal = document.getElementById('role-update-modal');
            const messageElement = document.getElementById('role-update-message');
            
            if (messageElement) {
                const action = memberToUpdateRole.isAdmin ? '移除管理员' : '设为管理员';
                messageElement.textContent = `确定要将成员 "${memberToUpdateRole.name}" ${action} 吗？`;
            }
            
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function confirmUpdateRole() {
            if (!memberToUpdateRole) return;
            
            memberToUpdateRole.isAdmin = !memberToUpdateRole.isAdmin;
            
            renderMemberList();
            
            document.getElementById('role-update-modal').classList.add('hidden');
            
            const action = memberToUpdateRole.isAdmin ? '设为管理员' : '移除管理员';
            customAlert(`已成功将 "${memberToUpdateRole.name}" ${action}`);
            
            memberToUpdateRole = null;
        }

        function cancelUpdateRole() {
            document.getElementById('role-update-modal').classList.add('hidden');
            memberToUpdateRole = null;
        }

        // --- 移除成员逻辑 ---
        function handleRemoveMember(memberId) {
            memberToRemove = groupMembers.find(m => m.id === memberId);
            if (!memberToRemove) return;
            
            const modal = document.getElementById('remove-modal');
            const messageElement = document.getElementById('remove-message');
            
            if (messageElement) {
                messageElement.textContent = `确定要将成员 "${memberToRemove.name}" 从群组中移除吗？`;
            }
            
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function confirmRemoveMember() {
            if (!memberToRemove) return;
            
            groupMembers = groupMembers.filter(m => m.id !== memberToRemove.id);
            
            document.getElementById('member-count').textContent = groupMembers.length;
            
            renderMemberList();
            
            document.getElementById('remove-modal').classList.add('hidden');
            
            customAlert(`已成功将 "${memberToRemove.name}" 从群组中移除`);
            
            memberToRemove = null;
        }

        function cancelRemoveMember() {
            document.getElementById('remove-modal').classList.add('hidden');
            memberToRemove = null;
        }

        // --- 邀请成员逻辑 ---
        function inviteNewMember() {
            const emailInput = document.getElementById('invite-user-email-input');
            const loadingMessage = document.getElementById('invite-loading-message');
            const submitButton = document.getElementById('invite-submit-button');
            
            const email = emailInput.value.trim();
            
            if (!email) {
                customAlert('请输入要邀请的邮箱地址');
                return;
            }
            
            if (!isValidEmail(email)) {
                customAlert('请输入有效的邮箱地址');
                return;
            }
            
            const isAlreadyMember = groupMembers.some(member => member.email.toLowerCase() === email.toLowerCase());
            if (isAlreadyMember) {
                customAlert('该邮箱地址已经是群组成员');
                return;
            }
            
            loadingMessage.classList.remove('hidden');
            submitButton.disabled = true;
            
            setTimeout(() => {
                loadingMessage.classList.add('hidden');
                submitButton.disabled = false;
                
                customAlert(`邀请已发送至 ${email}`);
                
                emailInput.value = '';
            }, 1500);
        }

        function clearInviteForm() {
            document.getElementById('invite-user-email-input').value = '';
        }

        // --- 费用列表功能 ---
        function refreshExpensesList() {
            const expensesListContainer = document.getElementById('expenses-list');
            const expenseCountElement = document.getElementById('expense-count');
            
            if (!expensesListContainer) return;
            
            if (expenseCountElement) {
                expenseCountElement.textContent = expensesList.length;
            }
            
            expensesListContainer.innerHTML = '';
            
            expensesList.forEach(expense => {
                const isOwnExpense = expense.payer === CURRENT_USER_ID;
                
                const expenseItem = document.createElement('div');
                expenseItem.className = `expense-item flex items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-150 cursor-pointer ${isOwnExpense ? 'border-l-4 border-l-primary' : ''}`;
                expenseItem.onclick = () => viewExpenseDetail(expense.id);
                
                const payerName = groupMembers.find(m => m.id === expense.payer)?.name || expense.payer;
                
                expenseItem.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-primary/10 text-primary rounded-full flex items-center justify-center text-lg font-bold mr-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5h6"></path>
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800 truncate">${expense.description}</p>
                        <p class="text-xs text-gray-500">日期: ${expense.date} | 付款人: ${payerName}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-danger">$${expense.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${isOwnExpense ? '您创建的' : '其他成员创建'}</p>
                    </div>
                `;
                
                expensesListContainer.appendChild(expenseItem);
            });
        }

        // --- 定期费用列表功能 ---
        function refreshRecurringList() {
            const recurringListContainer = document.getElementById('recurring-list');
            const recurringCountElement = document.getElementById('recurring-count');
            
            if (!recurringListContainer) return;
            
            if (recurringCountElement) {
                recurringCountElement.textContent = recurringExpensesList.length;
            }
            
            recurringListContainer.innerHTML = '';
            
            recurringExpensesList.forEach(expense => {
                const isOwnExpense = expense.payer === CURRENT_USER_ID;
                const frequencyText = getFrequencyDisplayName(expense.frequency);
                const statusText = expense.isActive ? '启用' : '禁用';
                const statusClass = expense.isActive ? 'bg-success/10 text-success' : 'bg-gray-100 text-gray-800';
                
                const expenseItem = document.createElement('div');
                expenseItem.className = `expense-item flex items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-150 cursor-pointer ${isOwnExpense ? 'border-l-4 border-l-warning' : ''}`;
                expenseItem.onclick = () => viewRecurringDetail(expense.id);
                
                const payerName = groupMembers.find(m => m.id === expense.payer)?.name || expense.payer;
                
                expenseItem.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-warning/10 text-warning rounded-full flex items-center justify-center text-lg font-bold mr-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800 truncate">${expense.description}</p>
                        <p class="text-xs text-gray-500">频率: ${frequencyText} | 付款人: ${payerName}</p>
                        <div class="mt-2 flex items-center space-x-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-warning">$${expense.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${isOwnExpense ? '您创建的' : '其他成员创建'}</p>
                    </div>
                `;
                
                recurringListContainer.appendChild(expenseItem);
            });
        }

        function viewRecurringDetail(expenseId) {
            const expense = recurringExpensesList.find(e => e.id === expenseId);
            if (!expense) {
                customAlert('错误', '未找到定期费用信息');
                return;
            }
            
            currentEditingRecurringExpense = expense;
            
            const modal = document.getElementById('recurring-detail-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeRecurringDetailForm(expense);
            }
        }

        function initializeRecurringDetailForm(expense) {
            document.getElementById('recurring-detail-description').textContent = expense.description;
            document.getElementById('recurring-detail-amount').textContent = `$${expense.amount.toFixed(2)}`;
            document.getElementById('recurring-detail-payer').textContent = groupMembers.find(m => m.id === expense.payer)?.name || expense.payer;
            document.getElementById('recurring-detail-frequency').textContent = getFrequencyDisplayName(expense.frequency);
            document.getElementById('recurring-detail-start-date').textContent = expense.startDate;
            
            if (expense.endDate) {
                document.getElementById('recurring-detail-end-date').textContent = expense.endDate;
                document.getElementById('recurring-detail-end-date-container').classList.remove('hidden');
            } else {
                document.getElementById('recurring-detail-end-date-container').classList.add('hidden');
            }
            
            // 设置状态
            const statusElement = document.getElementById('recurring-detail-status');
            const disableBtn = document.getElementById('disable-recurring-btn');
            const enableBtn = document.getElementById('enable-recurring-btn');
            
            if (expense.isActive) {
                statusElement.textContent = '启用';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success/10 text-success';
                disableBtn.classList.remove('hidden');
                enableBtn.classList.add('hidden');
            } else {
                statusElement.textContent = '禁用';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                disableBtn.classList.add('hidden');
                enableBtn.classList.remove('hidden');
            }
            
            // 设置参与者
            const participantsContainer = document.getElementById('recurring-detail-participants-container');
            participantsContainer.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isParticipant = expense.participants.includes(member.id);
                if (isParticipant) {
                    const participantElement = document.createElement('div');
                    participantElement.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200';
                    participantElement.innerHTML = `
                        <div class="w-8 h-8 flex items-center justify-center bg-primary/10 text-primary rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${member.id === CURRENT_USER_ID ? ' (您)' : ''}
                        </span>
                    `;
                    participantsContainer.appendChild(participantElement);
                }
            });
            
            // 设置分摊方式
            document.getElementById('recurring-detail-split-method').textContent = getSplitMethodName(expense.splitMethod);
            
            // 设置分摊详情
            const splitList = document.getElementById('recurring-detail-split-list');
            splitList.innerHTML = '';
            
            expense.splits.forEach(split => {
                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center py-1';
                listItem.innerHTML = `
                    <span>${split.name}</span>
                    <span class="font-medium text-gray-900">$ ${split.amount}</span>
                `;
                splitList.appendChild(listItem);
            });
        }

        function handleDisableRecurringExpense() {
            if (!currentEditingRecurringExpense) return;
            
            currentEditingRecurringExpense.isActive = false;
            refreshRecurringList();
            initializeRecurringDetailForm(currentEditingRecurringExpense);
            customAlert('定期费用已禁用', `定期费用 "${currentEditingRecurringExpense.description}" 已禁用`);
        }

        function handleEnableRecurringExpense() {
            if (!currentEditingRecurringExpense) return;
            
            currentEditingRecurringExpense.isActive = true;
            refreshRecurringList();
            initializeRecurringDetailForm(currentEditingRecurringExpense);
            customAlert('定期费用已启用', `定期费用 "${currentEditingRecurringExpense.description}" 已启用`);
        }

        function handleDeleteRecurringExpense() {
            if (!currentEditingRecurringExpense) {
                customAlert('错误', '未找到要删除的定期费用');
                return;
            }
            
            showDeleteRecurringConfirm(currentEditingRecurringExpense.description);
        }

        function handleEditRecurringExpense() {
            if (!currentEditingRecurringExpense) {
                customAlert('错误', '未找到要编辑的定期费用');
                return;
            }
            
            // 这里可以添加编辑定期费用的逻辑
            customAlert('编辑功能', '定期费用编辑功能待实现');
        }

        function handleRecurringDetailCancel() {
            const modal = document.getElementById('recurring-detail-modal');
            if (modal) modal.classList.add('hidden');
            currentEditingRecurringExpense = null;
        }

        function getFrequencyDisplayName(frequency) {
            const names = {
                'daily': '每日',
                'weekly': '每周',
                'monthly': '每月',
                'yearly': '每年'
            };
            return names[frequency] || frequency;
        }

        // --- 支付列表功能 ---
        function refreshPaymentsList() {
            const paymentsListContainer = document.getElementById('payments-list');
            const paymentCountElement = document.getElementById('payment-count');
            
            if (!paymentsListContainer) return;
            
            if (paymentCountElement) {
                paymentCountElement.textContent = paymentsList.length;
            }
            
            paymentsListContainer.innerHTML = '';
            
            paymentsList.forEach(payment => {
                const isOwnPayment = payment.payer === CURRENT_USER_ID;
                
                const paymentItem = document.createElement('div');
                paymentItem.className = `expense-item flex items-center p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-150 cursor-pointer ${isOwnPayment ? 'border-l-4 border-l-success' : ''}`;
                paymentItem.onclick = () => viewPaymentDetail(payment.id);
                
                const payerName = groupMembers.find(m => m.id === payment.payer)?.name || payment.payer;
                const payeeName = groupMembers.find(m => m.id === payment.payee)?.name || payment.payee;
                const expenseDescription = expensesList.find(e => e.id === payment.expenseId)?.description || '未知费用';
                
                paymentItem.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-success/10 text-success rounded-full flex items-center justify-center text-lg font-bold mr-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800 truncate">${payment.description}</p>
                        <p class="text-xs text-gray-500">日期: ${payment.date} | 付款人: ${payerName} → 收款人: ${payeeName}</p>
                        <p class="text-xs text-gray-500">费用: ${expenseDescription}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-success">$${payment.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${isOwnPayment ? '您创建的' : '其他成员创建'}</p>
                    </div>
                `;
                
                paymentsListContainer.appendChild(paymentItem);
            });
        }
        // --- 定期费用表单功能 ---
        function handleAddNewRecurringExpense() {
            const modal = document.getElementById('add-recurring-expense-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeRecurringExpenseForm();
            }
        }

        function initializeRecurringExpenseForm() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('repeat-start');
            const amountInput = document.getElementById('recurring-amount');
            
            if (dateInput) dateInput.value = today;
            if (amountInput) amountInput.value = '';
            
            const payerSelect = document.getElementById('recurring-payer');
            if (payerSelect) {
                payerSelect.innerHTML = '<option value="">请选择付款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    payerSelect.appendChild(option);
                });
            }
            
            recurringSelectedParticipants = new Set([CURRENT_USER_ID]);
            renderRecurringParticipantSelection();
            
            setRecurringSplitMethod('equal', false);
            initializeRecurringSplits(0);
            updateRecurringSplitDetails();
            
            // 初始化定期费用设置
            initializeRecurringSettings();
        }

        function renderRecurringParticipantSelection() {
            const container = document.querySelector('#recurring-participants-section .grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isChecked = recurringSelectedParticipants.has(member.id);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200 hover:bg-gray-50 transition duration-150';
                checkbox.innerHTML = `
                    <input type="checkbox" id="recurring-participant-${member.id}" 
                           ${isChecked ? 'checked' : ''}
                           onchange="handleRecurringParticipantChange('${member.id}', this.checked)"
                           class="participant-checkbox h-4 w-4 text-warning focus:ring-warning border-gray-300 rounded">
                    <label for="recurring-participant-${member.id}" class="flex items-center space-x-2 flex-1 cursor-pointer">
                        <div class="w-8 h-8 flex items-center justify-center bg-warning/10 text-warning rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${member.id === CURRENT_USER_ID ? ' (您)' : ''}
                        </span>
                    </label>
                `;
                
                container.appendChild(checkbox);
            });
        }

        function handleRecurringParticipantChange(memberId, isChecked) {
            if (isChecked) {
                recurringSelectedParticipants.add(memberId);
            } else {
                recurringSelectedParticipants.delete(memberId);
            }
            
            const amount = parseFloat(document.getElementById('recurring-amount').value) || 0;
            initializeRecurringSplits(amount);
            updateRecurringSplitDetails();
        }

        function initializeRecurringSplits(amount) {
            const activeMembers = groupMembers.filter(m => recurringSelectedParticipants.has(m.id));
            const memberCount = activeMembers.length;
            
            if (memberCount === 0) {
                recurringMemberSplits = [];
                return;
            }
            
            const equalSplit = (amount / memberCount);
            let totalAllocated = 0;

            const existingSplitsValid = recurringSplitMethod === 'exact' && recurringMemberSplits.length === memberCount;
            
            recurringMemberSplits = activeMembers.map((member, index) => {
                let splitAmount;

                if (existingSplitsValid) {
                    const oldSplit = recurringMemberSplits.find(s => s.id === member.id);
                    splitAmount = parseFloat(oldSplit?.amount || '0.00');
                } else {
                    let calculatedSplit = Math.floor(equalSplit * 100) / 100;
                    
                    if (index === memberCount - 1) {
                        calculatedSplit = amount - totalAllocated;
                    } else {
                        totalAllocated += calculatedSplit;
                    }
                    splitAmount = calculatedSplit;
                }

                const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                return {
                    id: member.id,
                    name: member.id === CURRENT_USER_ID ? `您 (${displayName})` : displayName,
                    amount: splitAmount.toFixed(2),
                };
            });
        }

        function setRecurringSplitMethod(method, triggerUpdate = true) {
            recurringSplitMethod = method;
            const methods = ['equal', 'exact'];
            
            methods.forEach(m => {
                const btn = document.getElementById(`recurring-split-${m}`);
                if (btn) {
                    if (m === method) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
            
            if (triggerUpdate) {
                const amountInput = document.getElementById('recurring-amount');
                const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
                initializeRecurringSplits(amount);
                updateRecurringSplitDetails();
            }
        }

        function handleRecurringSplitInputChange(memberId, value) {
            const index = recurringMemberSplits.findIndex(s => s.id === memberId);
            if (index !== -1) {
                recurringMemberSplits[index].amount = parseFloat(value).toFixed(2);
            }
            updateRecurringSplitSummary();
        }

        function handleRecurringAmountChange() {
            const amountInput = document.getElementById('recurring-amount');
            const newAmount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            initializeRecurringSplits(newAmount);
            updateRecurringSplitDetails();
            updateRecurringPreview();
        }

        function updateRecurringSplitDetails() {
            const splitList = document.getElementById('recurring-split-list');
            const amountInput = document.getElementById('recurring-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!splitList) return;
            
            splitList.innerHTML = '';
            
            const sectionTitle = document.querySelector('#recurring-split-details-section h4');
            if (sectionTitle) {
                sectionTitle.textContent = `分摊详情 (${getSplitMethodName(recurringSplitMethod)})`;
            }

            if (recurringSplitMethod === 'equal') {
                initializeRecurringSplits(amount);

                recurringMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    listItem.innerHTML = `
                        <span>${split.name}</span>
                        <span class="font-medium text-gray-900">$ ${split.amount}</span>
                    `;
                    splitList.appendChild(listItem);
                });

            } else {
                recurringMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    
                    listItem.innerHTML = `
                        <label for="recurring-split-${split.id}" class="w-1/3 text-gray-700">${split.name}</label>
                        <div class="relative w-2/3">
                            <input type="number" id="recurring-split-${split.id}" 
                                   value="${split.amount}"
                                   min="0" step="0.01" required
                                   oninput="handleRecurringSplitInputChange('${split.id}', this.value)"
                                   class="block w-full pr-10 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                                   placeholder="0.00">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">$</span>
                            </div>
                        </div>
                    `;
                    splitList.appendChild(listItem);
                });
            }
            updateRecurringSplitSummary();
        }

        function updateRecurringSplitSummary() {
            const summaryDiv = document.getElementById('recurring-split-summary');
            const amountInput = document.getElementById('recurring-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!summaryDiv) return;
            
            let totalSplit = 0;
            let isBalanced = true;

            totalSplit = recurringMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            isBalanced = Math.abs(totalSplit - amount) < 0.01;
            
            const remaining = (amount - totalSplit).toFixed(2);
            
            summaryDiv.innerHTML = `
                <p class="text-sm flex justify-between">
                    <span class="font-medium text-gray-700">总分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${totalSplit.toFixed(2)}</span>
                </p>
                <p class="text-sm flex justify-between mt-1">
                    <span class="font-medium text-gray-700">待分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${remaining}</span>
                </p>
                ${!isBalanced ? `<p class="text-xs text-unbalanced mt-1">**警告:** 分摊总额 $${totalSplit.toFixed(2)} 与费用总额 $${amount.toFixed(2)} 不匹配。</p>` : ''}
            `;

            const submitButton = document.querySelector('#add-recurring-expense-modal button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = !isBalanced;
                submitButton.classList.toggle('opacity-50', !isBalanced);
                submitButton.classList.toggle('cursor-not-allowed', !isBalanced);
            }
        }

        function handleSaveRecurringExpense(event) {
            event.preventDefault();
            
            const amountInput = document.getElementById('recurring-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            let totalSplit = recurringMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            if (Math.abs(totalSplit - amount) > 0.01) {
                customAlert('提交失败', '分摊总额与费用总额不匹配，请调整分摊详情。');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            const newRecurringExpense = {
                id: 'recurring_' + Date.now(),
                description: data['recurring-description'],
                amount: parseFloat(data['recurring-amount']),
                startDate: data['repeat-start'],
                endDate: data['repeat-end'] || null,
                frequency: recurringExpenseState.frequency,
                payer: data['recurring-payer'],
                participants: Array.from(recurringSelectedParticipants),
                splitMethod: recurringSplitMethod,
                splits: [...recurringMemberSplits],
                isActive: true
            };
            
            recurringExpensesList.unshift(newRecurringExpense);
            customAlert('新定期费用已保存', `定期费用 "${data['recurring-description']}" 已成功创建`);

            const modal = document.getElementById('add-recurring-expense-modal');
            if (modal) modal.classList.add('hidden');
            
            refreshRecurringList();
        }

        function handleRecurringCancel() {
            const modal = document.getElementById('add-recurring-expense-modal');
            if (modal) modal.classList.add('hidden');
        }

        // --- 定期费用功能 ---
        function selectFrequency(frequency) {
            recurringExpenseState.frequency = frequency;
            
            // 更新UI选中状态
            document.querySelectorAll('.frequency-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateRecurringPreview();
        }

        function updateRecurringPreview() {
            const amount = parseFloat(document.getElementById('recurring-amount').value) || 0;
            const initialDate = document.getElementById('repeat-start').value;
            const previewList = document.getElementById('preview-list');
            const previewSummary = document.getElementById('preview-summary');
            
            if (!initialDate) {
                previewList.innerHTML = `
                    <div class="preview-item p-3 rounded">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">初始费用</span>
                            <span class="text-sm text-gray-600">${initialDate || '选择日期'}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">金额: $${amount.toFixed(2)}</div>
                    </div>
                `;
                previewSummary.textContent = '共 1 笔费用';
                return;
            }
            
            const previews = generateRecurringPreviews(initialDate, amount);
            previewList.innerHTML = previews.map(preview => `
                <div class="preview-item p-3 rounded">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${preview.title}</span>
                        <span class="text-sm text-gray-600">${preview.date}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">金额: $${preview.amount.toFixed(2)}</div>
                </div>
            `).join('');
            
            previewSummary.textContent = `共 ${previews.length} 笔费用`;
        }

        function generateRecurringPreviews(startDate, amount) {
            const previews = [{
                title: '初始费用',
                date: startDate,
                amount: amount
            }];
            
            const start = new Date(startDate);
            const maxPreviews = 4; // 最多显示4个预览
            
            for (let i = 1; i <= maxPreviews; i++) {
                const nextDate = calculateNextDate(start, i);
                previews.push({
                    title: `第 ${i + 1} 次`,
                    date: nextDate.toISOString().split('T')[0],
                    amount: amount
                });
            }
            
            return previews;
        }

        function calculateNextDate(startDate, interval) {
            const date = new Date(startDate);
            
            switch (recurringExpenseState.frequency) {
                case 'daily':
                    date.setDate(date.getDate() + interval);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + (interval * 7));
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + interval);
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + interval);
                    break;
            }
            
            return date;
        }

        function initializeRecurringSettings() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('repeat-start').value = today;
            
            // 设置默认频率为每日
            selectFrequency('daily');
        }

        // --- 删除确认功能 ---
        function showDeleteRecurringConfirm(expenseDescription) {
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            
            if (modal && message) {
                message.textContent = `您确定要删除定期费用 "${expenseDescription}" 吗？此操作无法撤销。`;
                modal.classList.remove('hidden');
            }
        }

        function confirmDeleteRecurringExpense() {
            if (!currentEditingRecurringExpense) {
                customAlert('错误', '未找到要删除的定期费用');
                closeDeleteConfirm();
                return;
            }
            
            const index = recurringExpensesList.findIndex(e => e.id === currentEditingRecurringExpense.id);
            if (index !== -1) {
                recurringExpensesList.splice(index, 1);
            }
            
            customAlert('定期费用已删除', `定期费用 "${currentEditingRecurringExpense.description}" 已被删除`);
            
            closeDeleteConfirm();
            handleRecurringDetailCancel();
            refreshRecurringList();
        }

        // --- 费用详情功能 ---
        function viewExpenseDetail(expenseId) {
            const expense = expensesList.find(e => e.id === expenseId);
            if (!expense) {
                customAlert('错误', '未找到费用信息');
                return;
            }
            
            currentEditingExpense = expense;
            
            const modal = document.getElementById('expense-detail-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeExpenseDetailForm(expense);
            }
        }

        function initializeExpenseDetailForm(expense) {
            document.getElementById('detail-description').value = expense.description;
            document.getElementById('detail-amount').value = expense.amount;
            document.getElementById('detail-date').value = expense.date;
            
            const payerSelect = document.getElementById('detail-payer');
            if (payerSelect) {
                payerSelect.innerHTML = '<option value="">请选择付款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    if (member.id === expense.payer) {
                        option.selected = true;
                    }
                    payerSelect.appendChild(option);
                });
            }
            
            detailSelectedParticipants = new Set(expense.participants || [CURRENT_USER_ID]);
            renderDetailParticipantSelection();
            
            detailSplitMethod = expense.splitMethod || 'equal';
            setDetailSplitMethod(detailSplitMethod, false);
            
            detailMemberSplits = expense.splits || [];
            if (detailMemberSplits.length === 0) {
                const amount = parseFloat(expense.amount) || 0;
                initializeDetailSplits(amount);
            }
            
            updateDetailSplitDetails();
        }

        function renderDetailParticipantSelection() {
            const container = document.getElementById('detail-participants-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isChecked = detailSelectedParticipants.has(member.id);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200 hover:bg-gray-50 transition duration-150';
                checkbox.innerHTML = `
                    <input type="checkbox" id="detail-participant-${member.id}" 
                           ${isChecked ? 'checked' : ''}
                           onchange="handleDetailParticipantChange('${member.id}', this.checked)"
                           class="participant-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    <label for="detail-participant-${member.id}" class="flex items-center space-x-2 flex-1 cursor-pointer">
                        <div class="w-8 h-8 flex items-center justify-center bg-primary/10 text-primary rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${member.id === CURRENT_USER_ID ? ' (您)' : ''}
                        </span>
                    </label>
                `;
                
                container.appendChild(checkbox);
            });
        }

        function handleDetailParticipantChange(memberId, isChecked) {
            if (isChecked) {
                detailSelectedParticipants.add(memberId);
            } else {
                detailSelectedParticipants.delete(memberId);
            }
            
            const amount = parseFloat(document.getElementById('detail-amount').value) || 0;
            initializeDetailSplits(amount);
            updateDetailSplitDetails();
        }

        function initializeDetailSplits(amount) {
            const activeMembers = groupMembers.filter(m => detailSelectedParticipants.has(m.id));
            const memberCount = activeMembers.length;
            
            if (memberCount === 0) {
                detailMemberSplits = [];
                return;
            }
            
            const equalSplit = (amount / memberCount);
            let totalAllocated = 0;

            const existingSplitsValid = detailSplitMethod === 'exact' && detailMemberSplits.length === memberCount;
            
            detailMemberSplits = activeMembers.map((member, index) => {
                let splitAmount;

                if (existingSplitsValid) {
                    const oldSplit = detailMemberSplits.find(s => s.id === member.id);
                    splitAmount = parseFloat(oldSplit?.amount || '0.00');
                } else {
                    let calculatedSplit = Math.floor(equalSplit * 100) / 100;
                    
                    if (index === memberCount - 1) {
                        calculatedSplit = amount - totalAllocated;
                    } else {
                        totalAllocated += calculatedSplit;
                    }
                    splitAmount = calculatedSplit;
                }

                const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                return {
                    id: member.id,
                    name: member.id === CURRENT_USER_ID ? `您 (${displayName})` : displayName,
                    amount: splitAmount.toFixed(2),
                };
            });
        }

        function setDetailSplitMethod(method, triggerUpdate = true) {
            detailSplitMethod = method;
            const methods = ['equal', 'exact'];
            
            methods.forEach(m => {
                const btn = document.getElementById(`detail-split-${m}`);
                if (btn) {
                    if (m === method) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
            
            if (triggerUpdate) {
                const amountInput = document.getElementById('detail-amount');
                const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
                initializeDetailSplits(amount);
                updateDetailSplitDetails();
            }
        }

        function handleDetailSplitInputChange(memberId, value) {
            const index = detailMemberSplits.findIndex(s => s.id === memberId);
            if (index !== -1) {
                detailMemberSplits[index].amount = parseFloat(value).toFixed(2);
            }
            updateDetailSplitSummary();
        }

        function handleDetailAmountChange() {
            const amountInput = document.getElementById('detail-amount');
            const newAmount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            initializeDetailSplits(newAmount);
            updateDetailSplitDetails();
        }

        function updateDetailSplitDetails() {
            const splitList = document.getElementById('detail-split-list');
            const amountInput = document.getElementById('detail-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!splitList) return;
            
            splitList.innerHTML = '';
            
            const sectionTitle = document.querySelector('#detail-split-details-section h4');
            if (sectionTitle) {
                sectionTitle.textContent = `分摊详情 (${getSplitMethodName(detailSplitMethod)})`;
            }

            if (detailSplitMethod === 'equal') {
                initializeDetailSplits(amount);

                detailMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    listItem.innerHTML = `
                        <span>${split.name}</span>
                        <span class="font-medium text-gray-900">$ ${split.amount}</span>
                    `;
                    splitList.appendChild(listItem);
                });

            } else {
                detailMemberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    
                    listItem.innerHTML = `
                        <label for="detail-split-${split.id}" class="w-1/3 text-gray-700">${split.name}</label>
                        <div class="relative w-2/3">
                            <input type="number" id="detail-split-${split.id}" 
                                   value="${split.amount}"
                                   min="0" step="0.01" required
                                   oninput="handleDetailSplitInputChange('${split.id}', this.value)"
                                   class="block w-full pr-10 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                   placeholder="0.00">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">$</span>
                            </div>
                        </div>
                    `;
                    splitList.appendChild(listItem);
                });
            }
            updateDetailSplitSummary();
        }

        function updateDetailSplitSummary() {
            const summaryDiv = document.getElementById('detail-split-summary');
            const amountInput = document.getElementById('detail-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!summaryDiv) return;
            
            let totalSplit = 0;
            let isBalanced = true;

            totalSplit = detailMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            isBalanced = Math.abs(totalSplit - amount) < 0.01;
            
            const remaining = (amount - totalSplit).toFixed(2);
            
            summaryDiv.innerHTML = `
                <p class="text-sm flex justify-between">
                    <span class="font-medium text-gray-700">总分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${totalSplit.toFixed(2)}</span>
                </p>
                <p class="text-sm flex justify-between mt-1">
                    <span class="font-medium text-gray-700">待分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${remaining}</span>
                </p>
                ${!isBalanced ? `<p class="text-xs text-unbalanced mt-1">**警告:** 分摊总额 $${totalSplit.toFixed(2)} 与费用总额 $${amount.toFixed(2)} 不匹配。</p>` : ''}
            `;

            const submitButton = document.querySelector('#expense-detail-modal button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = !isBalanced;
                submitButton.classList.toggle('opacity-50', !isBalanced);
                submitButton.classList.toggle('cursor-not-allowed', !isBalanced);
            }
        }

        function handleUpdateExpense(event) {
            event.preventDefault();
            
            const amountInput = document.getElementById('detail-amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            let totalSplit = detailMemberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            if (Math.abs(totalSplit - amount) > 0.01) {
                customAlert('提交失败', '分摊总额与费用总额不匹配，请调整分摊详情。');
                return;
            }
            
            if (!currentEditingExpense) {
                customAlert('错误', '未找到要更新的费用');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            currentEditingExpense.description = data['detail-description'];
            currentEditingExpense.amount = parseFloat(data['detail-amount']);
            currentEditingExpense.date = data['detail-date'];
            currentEditingExpense.payer = data['detail-payer'];
            currentEditingExpense.participants = Array.from(detailSelectedParticipants);
            currentEditingExpense.splitMethod = detailSplitMethod;
            currentEditingExpense.splits = [...detailMemberSplits];

            customAlert('费用已更新', `费用 "${data['detail-description']}" 已成功更新`);

            handleDetailCancel();
            refreshExpensesList();
        }

        function handleDeleteExpense() {
            if (!currentEditingExpense) {
                customAlert('错误', '未找到要删除的费用');
                return;
            }
            
            showDeleteConfirm(currentEditingExpense.description);
        }

        function handleDetailCancel() {
            const modal = document.getElementById('expense-detail-modal');
            if (modal) modal.classList.add('hidden');
            currentEditingExpense = null;
        }

        // --- 支付详情功能 ---
        function viewPaymentDetail(paymentId) {
            const payment = paymentsList.find(p => p.id === paymentId);
            if (!payment) {
                customAlert('错误', '未找到支付信息');
                return;
            }
            
            currentEditingPayment = payment;
            
            const modal = document.getElementById('payment-detail-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializePaymentDetailForm(payment);
            }
        }

        function initializePaymentDetailForm(payment) {
            document.getElementById('payment-detail-description').value = payment.description;
            document.getElementById('payment-detail-amount').value = payment.amount;
            document.getElementById('payment-detail-date').value = payment.date;
            
            const payeeSelect = document.getElementById('payment-detail-to');
            if (payeeSelect) {
                payeeSelect.innerHTML = '<option value="">请选择收款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    if (member.id === payment.payee) {
                        option.selected = true;
                    }
                    payeeSelect.appendChild(option);
                });
            }
            
            const expenseSelect = document.getElementById('payment-detail-for-expense');
            if (expenseSelect) {
                expenseSelect.innerHTML = '<option value="">请选择费用</option>';
                expensesList.forEach(expense => {
                    const option = document.createElement('option');
                    option.value = expense.id;
                    option.textContent = `${expense.description} - $${expense.amount} (${expense.date})`;
                    if (expense.id === payment.expenseId) {
                        option.selected = true;
                    }
                    expenseSelect.appendChild(option);
                });
            }
            
            const payerSelect = document.getElementById('payment-detail-payer');
            if (payerSelect) {
                payerSelect.innerHTML = '<option value="">请选择付款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    if (member.id === payment.payer) {
                        option.selected = true;
                    }
                    payerSelect.appendChild(option);
                });
            }
        }

        function handleUpdatePayment(event) {
            event.preventDefault();
            
            if (!currentEditingPayment) {
                customAlert('错误', '未找到要更新的支付');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            currentEditingPayment.description = data['payment-detail-description'];
            currentEditingPayment.amount = parseFloat(data['payment-detail-amount']);
            currentEditingPayment.date = data['payment-detail-date'];
            currentEditingPayment.payee = data['payment-detail-to'];
            currentEditingPayment.expenseId = data['payment-detail-for-expense'];
            currentEditingPayment.payer = data['payment-detail-payer'];

            customAlert('支付已更新', `支付 "${data['payment-detail-description']}" 已成功更新`);

            handlePaymentDetailCancel();
            refreshPaymentsList();
        }

        function handleDeletePayment() {
            if (!currentEditingPayment) {
                customAlert('错误', '未找到要删除的支付');
                return;
            }
            
            showDeletePaymentConfirm(currentEditingPayment.description);
        }

        function handlePaymentDetailCancel() {
            const modal = document.getElementById('payment-detail-modal');
            if (modal) modal.classList.add('hidden');
            currentEditingPayment = null;
        }

        function updatePaymentDetailFileNameDisplay(input) {
            const display = document.getElementById('payment-detail-file-name-display');
            if (display) {
                if (input.files.length > 0) {
                    display.textContent = input.files[0].name;
                } else {
                    display.textContent = '点击上传支付凭证图片 (最大 1MB)';
                }
            }
        }

        // --- 删除确认功能 ---
        function showDeleteConfirm(expenseDescription) {
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            
            if (modal && message) {
                message.textContent = `您确定要删除费用 "${expenseDescription}" 吗？此操作无法撤销。`;
                modal.classList.remove('hidden');
            }
        }

        function closeDeleteConfirm() {
            const modal = document.getElementById('delete-confirm-modal');
            if (modal) modal.classList.add('hidden');
        }

        function confirmDeleteExpense() {
            if (!currentEditingExpense) {
                customAlert('错误', '未找到要删除的费用');
                closeDeleteConfirm();
                return;
            }
            
            const index = expensesList.findIndex(e => e.id === currentEditingExpense.id);
            if (index !== -1) {
                expensesList.splice(index, 1);
            }
            
            customAlert('费用已删除', `费用 "${currentEditingExpense.description}" 已被删除`);
            
            closeDeleteConfirm();
            handleDetailCancel();
            refreshExpensesList();
        }

        function showDeletePaymentConfirm(paymentDescription) {
            const modal = document.getElementById('delete-payment-confirm-modal');
            const message = document.getElementById('delete-payment-confirm-message');
            
            if (modal && message) {
                message.textContent = `您确定要删除支付 "${paymentDescription}" 吗？此操作无法撤销。`;
                modal.classList.remove('hidden');
            }
        }

        function closeDeletePaymentConfirm() {
            const modal = document.getElementById('delete-payment-confirm-modal');
            if (modal) modal.classList.add('hidden');
        }

        function confirmDeletePayment() {
            if (!currentEditingPayment) {
                customAlert('错误', '未找到要删除的支付');
                closeDeletePaymentConfirm();
                return;
            }
            
            const index = paymentsList.findIndex(p => p.id === currentEditingPayment.id);
            if (index !== -1) {
                paymentsList.splice(index, 1);
            }
            
            customAlert('支付已删除', `支付 "${currentEditingPayment.description}" 已被删除`);
            
            closeDeletePaymentConfirm();
            handlePaymentDetailCancel();
            refreshPaymentsList();
        }

        // --- 费用表单功能 ---
        function initializeExpenseForm() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            const amountInput = document.getElementById('amount');
            
            if (dateInput) dateInput.value = today;
            if (amountInput) amountInput.value = '';
            
            const payerSelect = document.getElementById('payer');
            if (payerSelect) {
                payerSelect.innerHTML = '<option value="">请选择付款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    payerSelect.appendChild(option);
                });
            }
            
            selectedParticipants = new Set([CURRENT_USER_ID]);
            renderParticipantSelection();
            
            setSplitMethod('equal', false);
            initializeSplits(0);
            updateSplitDetails();
            
            // 初始化定期费用设置
            initializeRecurringSettings();
            
            const fileNameDisplay = document.getElementById('file-name-display');
            if (fileNameDisplay) fileNameDisplay.textContent = '点击上传收据图片 (最大 1MB)';
            
            const fileInput = document.getElementById('receipt-file');
            if(fileInput) fileInput.value = null;
        }

        function renderParticipantSelection() {
            const container = document.querySelector('#participants-section .grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const isChecked = selectedParticipants.has(member.id);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center space-x-3 p-2 bg-white rounded border border-gray-200 hover:bg-gray-50 transition duration-150';
                checkbox.innerHTML = `
                    <input type="checkbox" id="participant-${member.id}" 
                           ${isChecked ? 'checked' : ''}
                           onchange="handleParticipantChange('${member.id}', this.checked)"
                           class="participant-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    <label for="participant-${member.id}" class="flex items-center space-x-2 flex-1 cursor-pointer">
                        <div class="w-8 h-8 flex items-center justify-center bg-primary/10 text-primary rounded-full font-bold text-sm">
                            ${member.name[0]}
                        </div>
                        <span class="text-sm font-medium text-gray-700">
                            ${member.name}
                            ${member.id === CURRENT_USER_ID ? ' (您)' : ''}
                        </span>
                    </label>
                `;
                
                container.appendChild(checkbox);
            });
        }

        function handleParticipantChange(memberId, isChecked) {
            if (isChecked) {
                selectedParticipants.add(memberId);
            } else {
                selectedParticipants.delete(memberId);
            }
            
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            initializeSplits(amount);
            updateSplitDetails();
        }

        function initializeSplits(amount) {
            const activeMembers = groupMembers.filter(m => selectedParticipants.has(m.id));
            const memberCount = activeMembers.length;
            
            if (memberCount === 0) {
                memberSplits = [];
                return;
            }
            
            const equalSplit = (amount / memberCount);
            let totalAllocated = 0;

            const existingSplitsValid = currentSplitMethod === 'exact' && memberSplits.length === memberCount;
            
            memberSplits = activeMembers.map((member, index) => {
                let splitAmount;

                if (existingSplitsValid) {
                    const oldSplit = memberSplits.find(s => s.id === member.id);
                    splitAmount = parseFloat(oldSplit?.amount || '0.00');
                } else {
                    let calculatedSplit = Math.floor(equalSplit * 100) / 100;
                    
                    if (index === memberCount - 1) {
                        calculatedSplit = amount - totalAllocated;
                    } else {
                        totalAllocated += calculatedSplit;
                    }
                    splitAmount = calculatedSplit;
                }

                const displayName = member.name.replace(/\s*\(.*\)/, '').trim();

                return {
                    id: member.id,
                    name: member.id === CURRENT_USER_ID ? `您 (${displayName})` : displayName,
                    amount: splitAmount.toFixed(2),
                };
            });
        }
        
        function setSplitMethod(method, triggerUpdate = true) {
            currentSplitMethod = method;
            const methods = ['equal', 'exact'];
            
            methods.forEach(m => {
                const btn = document.getElementById(`split-${m}`);
                if (btn) {
                    if (m === method) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
            
            if (triggerUpdate) {
                const amountInput = document.getElementById('amount');
                const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
                initializeSplits(amount);
                updateSplitDetails();
            }
        }

        function handleSplitInputChange(memberId, value) {
            const index = memberSplits.findIndex(s => s.id === memberId);
            if (index !== -1) {
                memberSplits[index].amount = parseFloat(value).toFixed(2);
            }
            updateSplitSummary();
        }
        
        function handleAmountChange() {
            const amountInput = document.getElementById('amount');
            const newAmount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            initializeSplits(newAmount);
            updateSplitDetails();
            updateRecurringPreview();
        }

        function updateSplitDetails() {
            const splitList = document.getElementById('split-list');
            const amountInput = document.getElementById('amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!splitList) return;
            
            splitList.innerHTML = '';
            
            const sectionTitle = document.querySelector('#split-details-section h4');
            if (sectionTitle) {
                sectionTitle.textContent = `分摊详情 (${getSplitMethodName(currentSplitMethod)})`;
            }

            if (currentSplitMethod === 'equal') {
                 initializeSplits(amount);

                 memberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    listItem.innerHTML = `
                        <span>${split.name}</span>
                        <span class="font-medium text-gray-900">$ ${split.amount}</span>
                    `;
                    splitList.appendChild(listItem);
                });

            } else {
                memberSplits.forEach(split => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center py-1';
                    
                    listItem.innerHTML = `
                        <label for="split-${split.id}" class="w-1/3 text-gray-700">${split.name}</label>
                        <div class="relative w-2/3">
                            <input type="number" id="split-${split.id}" 
                                   value="${split.amount}"
                                   min="0" step="0.01" required
                                   oninput="handleSplitInputChange('${split.id}', this.value)"
                                   class="block w-full pr-10 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                   placeholder="0.00">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">$</span>
                            </div>
                        </div>
                    `;
                    splitList.appendChild(listItem);
                });
            }
            updateSplitSummary();
        }

        function updateSplitSummary() {
            const summaryDiv = document.getElementById('split-summary');
            const amountInput = document.getElementById('amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            if (!summaryDiv) return;
            
            let totalSplit = 0;
            let isBalanced = true;

            totalSplit = memberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            isBalanced = Math.abs(totalSplit - amount) < 0.01;
            
            const remaining = (amount - totalSplit).toFixed(2);
            
            summaryDiv.innerHTML = `
                <p class="text-sm flex justify-between">
                    <span class="font-medium text-gray-700">总分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${totalSplit.toFixed(2)}</span>
                </p>
                <p class="text-sm flex justify-between mt-1">
                    <span class="font-medium text-gray-700">待分摊金额:</span>
                    <span class="font-bold ${isBalanced ? 'text-balance' : 'text-unbalanced'}">$ ${remaining}</span>
                </p>
                ${!isBalanced ? `<p class="text-xs text-unbalanced mt-1">**警告:** 分摊总额 $${totalSplit.toFixed(2)} 与费用总额 $${amount.toFixed(2)} 不匹配。</p>` : ''}
            `;

            const submitButton = document.querySelector('#add-expense-modal button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = !isBalanced;
                submitButton.classList.toggle('opacity-50', !isBalanced);
                submitButton.classList.toggle('cursor-not-allowed', !isBalanced);
            }
        }
        
        function getSplitMethodName(method) {
            switch (method) {
                case 'equal': return 'Equally Split';
                case 'exact': return 'Custom Amount';
                default: return '未知分摊';
            }
        }
        
        function updateFileNameDisplay(input) {
            const display = document.getElementById('file-name-display');
            if (display) {
                if (input.files.length > 0) {
                    display.textContent = input.files[0].name;
                } else {
                    display.textContent = '点击上传收据图片 (最大 1MB)';
                }
            }
        }

        function handleAddNewExpense() {
            const modal = document.getElementById('add-expense-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializeExpenseForm();
            }
        }
        
        function handleCancel() {
            const modal = document.getElementById('add-expense-modal');
            if (modal) modal.classList.add('hidden');
        }

        function handleSaveExpense(event) {
            event.preventDefault();
            
            const amountInput = document.getElementById('amount');
            const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
            
            let totalSplit = memberSplits.reduce((sum, split) => sum + parseFloat(split.amount), 0);
            if (Math.abs(totalSplit - amount) > 0.01) {
                customAlert('提交失败', '分摊总额与费用总额不匹配，请调整分摊详情。');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            const newExpense = {
                id: 'expense_' + Date.now(),
                description: data.description,
                amount: parseFloat(data.amount),
                date: data.date,
                payer: data.payer,
                participants: Array.from(selectedParticipants),
                splitMethod: currentSplitMethod,
                splits: [...memberSplits]
            };
            
            // 如果是定期费用，添加到定期费用列表
            if (recurringExpenseState.isRecurring) {
                const recurringExpense = {
                    ...newExpense,
                    id: 'recurring_' + Date.now(),
                    startDate: data.date,
                    frequency: recurringExpenseState.frequency,
                    isActive: true
                };
                recurringExpensesList.unshift(recurringExpense);
                customAlert('新定期费用已保存', `定期费用 "${data.description}" 已成功创建`);
            } else {
                expensesList.unshift(newExpense);
                customAlert('新费用已保存', `费用 "${data.description}" 已成功创建`);
            }

            const modal = document.getElementById('add-expense-modal');
            if (modal) modal.classList.add('hidden');
            
            // 刷新相应的列表
            refreshExpensesList();
            if (recurringExpenseState.isRecurring) {
                refreshRecurringList();
            }
        }

        // --- 定期费用功能 ---
        function toggleRecurringExpense() {
            recurringExpenseState.isRecurring = !recurringExpenseState.isRecurring;
            const options = document.getElementById('recurring-options');
            const toggle = document.querySelector('.recurring-toggle');
            const toggleSpan = toggle.querySelector('span:last-child');
            
            if (recurringExpenseState.isRecurring) {
                options.classList.add('expanded');
                toggle.classList.add('bg-primary');
                toggle.classList.remove('bg-gray-200');
                toggleSpan.classList.add('translate-x-6');
                toggleSpan.classList.remove('translate-x-1');
                updateRecurringPreview();
            } else {
                options.classList.remove('expanded');
                toggle.classList.remove('bg-primary');
                toggle.classList.add('bg-gray-200');
                toggleSpan.classList.remove('translate-x-6');
                toggleSpan.classList.add('translate-x-1');
            }
        }

        function selectFrequency(frequency) {
            recurringExpenseState.frequency = frequency;
            
            // 更新UI选中状态
            document.querySelectorAll('.frequency-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateRecurringPreview();
        }

        function updateRecurringPreview() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const initialDate = document.getElementById('date').value;
            const previewList = document.getElementById('preview-list');
            const previewSummary = document.getElementById('preview-summary');
            
            if (!recurringExpenseState.isRecurring || !initialDate) {
                previewList.innerHTML = `
                    <div class="preview-item p-3 rounded">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">初始费用</span>
                            <span class="text-sm text-gray-600">${initialDate || '选择日期'}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">金额: $${amount.toFixed(2)}</div>
                    </div>
                `;
                previewSummary.textContent = '共 1 笔费用';
                return;
            }
            
            const previews = generateRecurringPreviews(initialDate, amount);
            previewList.innerHTML = previews.map(preview => `
                <div class="preview-item p-3 rounded">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${preview.title}</span>
                        <span class="text-sm text-gray-600">${preview.date}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">金额: $${preview.amount.toFixed(2)}</div>
                </div>
            `).join('');
            
            previewSummary.textContent = `共 ${previews.length} 笔费用`;
        }

        function generateRecurringPreviews(startDate, amount) {
            const previews = [{
                title: '初始费用',
                date: startDate,
                amount: amount
            }];
            
            const start = new Date(startDate);
            const maxPreviews = 4; // 最多显示4个预览
            
            for (let i = 1; i <= maxPreviews; i++) {
                const nextDate = calculateNextDate(start, i);
                previews.push({
                    title: `第 ${i + 1} 次`,
                    date: nextDate.toISOString().split('T')[0],
                    amount: amount
                });
            }
            
            return previews;
        }

        function calculateNextDate(startDate, interval) {
            const date = new Date(startDate);
            
            switch (recurringExpenseState.frequency) {
                case 'daily':
                    date.setDate(date.getDate() + interval);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + (interval * 7));
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + interval);
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + interval);
                    break;
            }
            
            return date;
        }

        function initializeRecurringSettings() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('repeat-start').value = today;
            
            // 设置默认频率为每日
            selectFrequency('daily');
        }

        // --- 支付表单功能 ---
        function initializePaymentForm() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('payment-date');
            const amountInput = document.getElementById('payment-amount');
            
            if (dateInput) dateInput.value = today;
            if (amountInput) amountInput.value = '';
            
            const paymentToSelect = document.getElementById('payment-to');
            if (paymentToSelect) {
                paymentToSelect.innerHTML = '<option value="">请选择收款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    paymentToSelect.appendChild(option);
                });
            }
            
            const paymentForExpenseSelect = document.getElementById('payment-for-expense');
            if (paymentForExpenseSelect) {
                paymentForExpenseSelect.innerHTML = '<option value="">请选择费用</option>';
                expensesList.forEach(expense => {
                    const option = document.createElement('option');
                    option.value = expense.id;
                    option.textContent = `${expense.description} - $${expense.amount} (${expense.date})`;
                    paymentForExpenseSelect.appendChild(option);
                });
            }
            
            const paymentPayerSelect = document.getElementById('payment-payer');
            if (paymentPayerSelect) {
                paymentPayerSelect.innerHTML = '<option value="">请选择付款人</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    paymentPayerSelect.appendChild(option);
                });
            }
            
            const fileNameDisplay = document.getElementById('payment-file-name-display');
            if (fileNameDisplay) fileNameDisplay.textContent = '点击上传支付凭证图片 (最大 1MB)';
            
            const fileInput = document.getElementById('payment-receipt-file');
            if(fileInput) fileInput.value = null;
        }

        function handleAddNewPayment() {
            const modal = document.getElementById('add-payment-modal');
            if (modal) {
                modal.classList.remove('hidden');
                initializePaymentForm();
            }
        }

        function handlePaymentCancel() {
            const modal = document.getElementById('add-payment-modal');
            if (modal) modal.classList.add('hidden');
        }

        function handleSavePayment(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            const newPayment = {
                id: 'payment_' + Date.now(),
                description: data['payment-description'],
                amount: parseFloat(data['payment-amount']),
                date: data['payment-date'],
                payer: data['payment-payer'],
                payee: data['payment-to'],
                expenseId: data['payment-for-expense'],
                receipt: null
            };
            
            paymentsList.unshift(newPayment);

            customAlert('新支付已保存', `支付 "${data['payment-description']}" 已成功创建`);

            const modal = document.getElementById('add-payment-modal');
            if (modal) modal.classList.add('hidden');
            
            refreshPaymentsList();
        }

        function updatePaymentFileNameDisplay(input) {
            const display = document.getElementById('payment-file-name-display');
            if (display) {
                if (input.files.length > 0) {
                    display.textContent = input.files[0].name;
                } else {
                    display.textContent = '点击上传支付凭证图片 (最大 1MB)';
                }
            }
        }

        // --- 用户菜单逻辑 ---
        function toggleUserMenu() {
            const dropdown = document.getElementById('logout-dropdown');
            const caretIcon = document.getElementById('caret-icon');
            
            dropdown.classList.toggle('hidden');
            caretIcon.classList.toggle('rotate-180');
        }

        // --- 页面导航逻辑 ---
        function handleBackToPreviousPage() {
            customAlert('返回上一页');
        }

        function handleMyProfile() {
            customAlert('跳转到我的资料页面');
        }

        function handleBackToDashboard() {
            customAlert('返回主页');
        }

        function handleLogout() {
            customAlert('执行退出登录操作');
        }

        function handleSettleUp() {
            customAlert('执行结算所有欠款操作');
        }

        // --- 自定义弹窗逻辑 ---
        function customAlert(message, detail) {
            const modal = document.getElementById('custom-alert-modal');
            const messageElement = document.getElementById('alert-message');
            
            if (messageElement) {
                if (detail) {
                    messageElement.textContent = `${message}: ${detail}`;
                } else {
                    messageElement.textContent = message;
                }
            }
            
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').classList.add('hidden');
        }

        // 群组数据加载
        async function loadGroupData() {
            const path = window.location.pathname;
            const groupIdMatch = path.match(/\/groups\/(\d+)/);
            const groupId = groupIdMatch ? parseInt(groupIdMatch[1]) : 1;
            
            console.log('正在加载群组数据，群组ID:', groupId);
            
            try {
                // 获取群组详情
                const groupResponse = await fetch(`/api/groups/${groupId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!groupResponse.ok) {
                    throw new Error('无法获取群组信息');
                }
                
                const groupData = await groupResponse.json();
                console.log('获取到群组数据:', groupData);
                
                // 更新群组名称和ID显示
                document.getElementById('group-name-display').innerHTML = `
                    ${groupData.name} <span class="text-sm font-normal text-gray-500">(ID: ${groupData.id})</span>
                `;
                document.getElementById('group-id-display').textContent = groupData.id;
                
                // 更新群组编辑表单
                document.getElementById('group-name-input').value = groupData.name;
                
                // 获取群组成员
                await loadGroupMembers(groupId);
                
                // 获取群组余额
                await loadGroupBalance(groupId);
                
            } catch (error) {
                console.error('加载群组数据失败:', error);
                showCustomAlert('加载群组数据失败: ' + error.message, true);
            }
        }
        
        async function loadGroupMembers(groupId) {
            try {
                const response = await fetch(`/groups/${groupId}/members`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const members = await response.json();
                    console.log('获取到群组成员:', members);
                    groupMembers = members;
                    renderMemberList();
                }
            } catch (error) {
                console.error('加载群组成员失败:', error);
            }
        }
        
        async function loadGroupBalance(groupId) {
            try {
                const response = await fetch(`/groups/${groupId}/balance`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const balanceData = await response.json();
                    console.log('获取到余额数据:', balanceData);
                    
                    // 更新余额显示
                    const balanceOwed = document.getElementById('balance-owed');
                    const balanceOwedCount = document.getElementById('balance-owed-count');
                    const balanceOwingMe = document.getElementById('balance-owing-me');
                    const balanceOwingCount = document.getElementById('balance-owing-count');
                    
                    if (balanceData.total_owed) {
                        balanceOwed.textContent = `¥${balanceData.total_owed.toFixed(2)}`;
                    }
                    if (balanceData.owed_to_count) {
                        balanceOwedCount.textContent = balanceData.owed_to_count;
                    }
                    if (balanceData.total_owing) {
                        balanceOwingMe.textContent = `¥${balanceData.total_owing.toFixed(2)}`;
                    }
                    if (balanceData.owing_from_count) {
                        balanceOwingCount.textContent = balanceData.owing_from_count;
                    }
                }
            } catch (error) {
                console.error('加载余额数据失败:', error);
            }
        }

        // --- 页面加载初始化 ---
        document.addEventListener('DOMContentLoaded', function() {
            // 首先加载群组数据
            loadGroupData();
            
            renderMemberList();
            refreshExpensesList();
            refreshPaymentsList();
            refreshRecurringList();
            loadGroupSettings();
            
            document.getElementById('member-count').textContent = groupMembers.length;
            
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.management-menu-active') && !event.target.closest('button[onclick*="toggleMemberManagementMenu"]')) {
                    document.querySelectorAll('.management-menu-active').forEach(menu => {
                        menu.classList.remove('management-menu-active');
                        menu.classList.add('hidden');
                    });
                }
            });
        });

        // 暴露函数到全局作用域
        window.toggleUserMenu = toggleUserMenu;
        window.handleBackToPreviousPage = handleBackToPreviousPage;
        window.handleBackToDashboard = handleBackToDashboard;
        window.handleAddNewExpense = handleAddNewExpense;
        window.handleAddNewPayment = handleAddNewPayment;
        window.handleSettleUp = handleSettleUp;
        window.handleMyProfile = handleMyProfile;
        window.handleLogout = handleLogout;
        window.customAlert = customAlert;
        window.closeCustomAlert = closeCustomAlert;
        window.setActiveTab = setActiveTab;
        window.clearInviteForm = clearInviteForm;
        window.inviteNewMember = inviteNewMember;
        window.handleCancel = handleCancel;
        window.handlePaymentCancel = handlePaymentCancel;
        window.handleSaveExpense = handleSaveExpense;
        window.handleSavePayment = handleSavePayment;
        window.setSplitMethod = setSplitMethod;
        window.handleSplitInputChange = handleSplitInputChange;
        window.updateFileNameDisplay = updateFileNameDisplay;
        window.updatePaymentFileNameDisplay = updatePaymentFileNameDisplay;
        window.handleAmountChange = handleAmountChange;
        window.handleParticipantChange = handleParticipantChange;
        window.viewExpenseDetail = viewExpenseDetail;
        window.setDetailSplitMethod = setDetailSplitMethod;
        window.handleDetailSplitInputChange = handleDetailSplitInputChange;
        window.handleDetailAmountChange = handleDetailAmountChange;
        window.handleDetailParticipantChange = handleDetailParticipantChange;
        window.handleUpdateExpense = handleUpdateExpense;
        window.handleDeleteExpense = handleDeleteExpense;
        window.handleDetailCancel = handleDetailCancel;
        window.showDeleteConfirm = showDeleteConfirm;
        window.closeDeleteConfirm = closeDeleteConfirm;
        window.confirmDeleteExpense = confirmDeleteExpense;
        window.viewPaymentDetail = viewPaymentDetail;
        window.handleUpdatePayment = handleUpdatePayment;
        window.handleDeletePayment = handleDeletePayment;
        window.handlePaymentDetailCancel = handlePaymentDetailCancel;
        window.updatePaymentDetailFileNameDisplay = updatePaymentDetailFileNameDisplay;
        window.showDeletePaymentConfirm = showDeletePaymentConfirm;
        window.closeDeletePaymentConfirm = closeDeletePaymentConfirm;
        window.confirmDeletePayment = confirmDeletePayment;
        window.toggleMemberManagementMenu = toggleMemberManagementMenu;
        window.handleUpdateRole = handleUpdateRole;
        window.confirmUpdateRole = confirmUpdateRole;
        window.cancelUpdateRole = cancelUpdateRole;
        window.handleRemoveMember = handleRemoveMember;
        window.confirmRemoveMember = confirmRemoveMember;
        window.cancelRemoveMember = cancelRemoveMember;
        window.saveGroupSettings = saveGroupSettings;
        window.resetGroupSettings = resetGroupSettings;
        window.loadGroupSettings = loadGroupSettings;
        // 定期费用相关函数
        window.toggleRecurringExpense = toggleRecurringExpense;
        window.selectFrequency = selectFrequency;
        window.viewRecurringDetail = viewRecurringDetail;
    </script>
</body>
</html>

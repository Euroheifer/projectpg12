{% extends "menu.html" %}

{% block title %}群组详情 | Project PG12{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                },
                colors: {
                    primary: '#4F46E5', // Indigo-600
                    'primary-dark': '#4338CA', // Indigo-700
                    success: '#10B981', // Emerald-500
                    danger: '#F87171', // Red-400
                    warning: '#FBBF24', // Amber-400
                    balance: '#10B981',
                    unbalanced: '#F87171',
                }
            }
        }
    }
</script>
<style>
    body {
        background-color: #F9FAFB;
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
    }

    .balance-card {
        transition: all 0.2s ease-in-out;
    }

    .tab-button.active {
        border-bottom: 3px solid #4F46E5;
        color: #4F46E5;
        font-weight: 600;
    }

    #add-expense-modal input[type="file"],
    #add-payment-modal input[type="file"],
    #expense-detail-modal input[type="file"],
    #payment-detail-modal input[type="file"] {
        display: none;
    }

    .split-toggle-btn {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        font-weight: 700;
        color: #4F46E5;
        background-color: white;
        transition-duration: 0.2s;
        border: none;
        border-right: 1px solid #4F46E5;
    }

    .split-toggle-btn:hover {
        background-color: #4F46E51A;
    }

    .split-toggle-btn.active {
        background-color: #4F46E5 !important;
        color: white !important;
    }

    .split-toggle-btn:last-child {
        border-right: none;
    }

    .recurring-toggle {
        transition: all 0.2s ease-in-out;
    }

    .recurring-options {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
    }

    .recurring-options.expanded {
        max-height: 500px;
    }

    .frequency-option {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .frequency-option:hover {
        border-color: #4F46E5;
        background-color: #f8faff;
    }

    .frequency-option.selected {
        border-color: #4F46E5;
        background-color: #4F46E5;
        color: white;
    }

    .preview-item {
        border-left: 3px solid #4F46E5;
        background-color: #f8faff;
    }

    .participant-checkbox {
        accent-color: #4F46E5;
    }

    .expense-item {
        transition: all 0.2s ease-in-out;
    }

    .expense-item:hover {
        transform: translateY(-2px);
    }

    .readonly-field {
        background-color: #f9fafb;
        cursor: not-allowed;
    }

    .management-menu-active {
        display: block !important;
    }

    /* 权限控制样式 */
    .admin-only {
        display: none;
    }

    .is-admin .admin-only {
        display: block;
    }

    body.is-admin .admin-only {
        display: block;
    }

    .hidden {
        display: none;
    }

    /* 返回按钮样式 */
    .back-button-container {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        z-index: 20;
    }

    .back-button-container {
        position: fixed;
        left: 1rem;
        top: 1rem;
        /* 调整这个值来垂直居中 */
        z-index: 50;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }

    /* 确保主要内容不会与返回按钮重叠 */
    main {
        position: relative;
        z-index: 1;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}


<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl border border-gray-100">

        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
            <div class="flex items-center">
                <!-- 返回按钮放在群组名称左侧 -->
                <button onclick="goBackToHome()"
                    class="flex items-center space-x-1 p-2 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 mr-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                    <span>返回</span>
                </button>

                <h2 id="group-name-display" class="text-3xl font-extrabold text-gray-900 mb-4 sm:mb-0">
                    加载中... <span class="text-sm font-normal text-gray-500">(ID: -)</span>
                </h2>
                <!-- 添加的管理员徽章
                <span id="admin-badge" class="admin-only ml-3 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    管理员
                </span> -->
            </div>
            <div class="flex flex-wrap gap-3 mt-4 sm:mt-0">
                <button onclick="handleAddNewExpense()"
                    class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-primary hover:bg-primary-dark transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>添加费用</span>
                </button>

                <button onclick="handleAddNewPayment()"
                    class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-success hover:bg-emerald-600 transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1">
                        </path>
                    </svg>
                    <span>添加支付</span>
                </button>
            </div>
        </div>

        <div id="group-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="balance-card bg-white p-6 rounded-xl border border-danger/20 shadow-lg">
                <p class="text-sm font-medium text-danger">您欠款 (应付)</p>
                <p class="text-3xl font-bold text-danger mt-1" id="balance-owed">¥0.00</p>
                <p id="balance-owed-context" class="text-xs text-gray-500 mt-2">给 0 位成员</p>
            </div>

            <div class="balance-card bg-white p-6 rounded-xl border border-success/20 shadow-lg">
                <p class="text-sm font-medium text-success">被欠款 (应收)</p>
                <p class="text-3xl font-bold text-success mt-1" id="balance-owing-me">¥0.00</p>
                <p id="balance-owing-me-context" class="text-xs text-gray-500 mt-2">从 0 位成员</p>
            </div>

            <div
                class="balance-card bg-white p-6 rounded-xl border border-warning/20 shadow-lg flex flex-col justify-between">
                <div>
                    <p class="text-sm font-medium text-warning">建议结算</p>
                    <p id="settlement-summary-text" class="text-xl font-bold text-gray-900 mt-1">总计 0 笔待清算</p>
                </div>
                <button onclick="handleSettleUp()"
                    class="w-full py-2 bg-warning/80 text-white rounded-lg hover:bg-warning transition duration-150 shadow-md transform hover:scale-[1.01] active:scale-[0.99] text-sm mt-3">
                    <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 0012 4.499c-3.562 0-6.84 1.838-8.683 4.887m17.566 2h-5.545m-4.021 0h-5.545M5.636 12A8.001 8.001 0 0012 19.5c3.562 0 6.84-1.838 8.683-4.887">
                        </path>
                    </svg>
                    <span>结算所有欠款</span>
                </button>
            </div>
        </div>

        <!-- 导航栏 - 添加定期费用标签页 -->
        <div class="border-b border-gray-200 mb-6">
            <div class="flex space-x-8 overflow-x-auto">
                <button id="tab-expenses" onclick="setActiveTab('expenses')"
                    class="tab-button active pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                    费用 (<span id="expense-count">0</span>)
                </button>
                <button id="tab-recurring" onclick="setActiveTab('recurring')"
                    class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                    定期费用 (<span id="recurring-count">0</span>)
                </button>
                <button id="tab-payments" onclick="setActiveTab('payments')"
                    class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                    支付 (<span id="payment-count">0</span>)
                </button>
                <button id="tab-members" onclick="setActiveTab('members')"
                    class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                    成员 (<span id="member-count">0</span>)
                </button>

                <button id="tab-invite" onclick="setActiveTab('invite')"
                    class="tab-button pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                    邀请成员
                </button>

                <!-- 管理员专属标签页 -->
                <button id="tab-manage" onclick="setActiveTab('manage')"
                    class="tab-button admin-only pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                    管理群组
                </button>

                <button id="tab-audit" onclick="setActiveTab('audit')"
                    class="tab-button admin-only pb-3 px-1 text-gray-500 hover:text-primary transition duration-150 whitespace-nowrap">
                    审计日志
                </button>
            </div>
        </div>

        <!-- 费用内容 -->
        <div id="tab-content-expenses">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">最近的费用列表</h3>
            <div id="expenses-list" class="space-y-4">
                <!-- 费用列表将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 定期费用内容 -->
        <div id="tab-content-recurring" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">定期费用列表</h3>
                <button onclick="handleAddNewRecurringExpense()"
                    class="flex items-center space-x-1 py-2 px-4 rounded-lg text-white bg-warning hover:bg-amber-500 transition duration-150 shadow-md transform hover:scale-[1.02] active:scale-[0.98] text-sm font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>添加定期费用</span>
                </button>
            </div>
            <div id="recurring-list" class="space-y-4">
                <!-- 定期费用列表将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 支付内容 -->
        <div id="tab-content-payments" class="hidden">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">最近的支付列表</h3>
            <div id="payments-list" class="space-y-4">
                <!-- 支付列表将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 成员内容 -->
        <div id="tab-content-members" class="hidden">
            <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center border-b pb-2">
                群组成员 (<span id="active-member-count">0</span> 人)
            </h3>
            <div id="member-list-container" class="space-y-3">
                <!-- 成员列表将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 邀请成员内容 -->
        <div id="tab-content-invite" class="hidden">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">邀请成员</h3>
            <div class="bg-white p-6 rounded-lg border border-gray-200 max-w-lg mx-auto">
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">请输入您希望邀请的用户的 **注册邮箱 (Email Address)**。系统将向该邮箱发送邀请链接。</p>
                    <label for="invite-user-email-input" class="block text-sm font-medium text-gray-700">要邀请的邮箱</label>
                    <input type="email" id="invite-user-email-input"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                        placeholder="例如: user@example.com">
                    <p id="invite-loading-message" class="text-sm text-warning hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-warning inline-block"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        正在发送邀请...
                    </p>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="clearInviteForm()"
                        class="py-2 px-4 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150 text-sm font-medium">
                        取消
                    </button>
                    <button onclick="inviteNewMember()" id="invite-submit-button"
                        class="py-2 px-4 rounded-lg text-white bg-success hover:bg-emerald-600 transition duration-150 shadow-md text-sm font-medium">
                        发送邀请
                    </button>
                </div>
            </div>
        </div>

        <!-- 管理群组内容 - 管理员专属 -->
        <div id="tab-content-manage" class="hidden">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">群组管理</h3>
            <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="space-y-6">
                    <!-- 群组基本信息设置 -->
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-medium mb-4 text-lg">群组基本信息</h4>

                        <div class="space-y-4">
                            <div>
                                <label for="group-name-input" class="block text-sm font-medium text-gray-700 mb-1">
                                    群组名称
                                </label>
                                <input type="text" id="group-name-input"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                                    placeholder="输入群组名称" value="">
                                <p class="text-xs text-gray-500 mt-1">群组名称将显示在所有成员界面中</p>
                            </div>

                            <div>
                                <label for="group-description-input"
                                    class="block text-sm font-medium text-gray-700 mb-1">
                                    群组描述 (可选)
                                </label>
                                <textarea id="group-description-input" rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                                    placeholder="描述这个群组的用途..."></textarea>
                            </div>

                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" onclick="resetGroupSettings()"
                                    class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                                    重置
                                </button>
                                <button type="button" onclick="saveGroupSettings()"
                                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition duration-150 shadow-md">
                                    保存更改
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- 审计日志内容 - 管理员专属 -->
        <div id="tab-content-audit" class="hidden">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">审计日志</h3>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <p class="text-gray-600 text-center">审计日志功能页面</p>
                <div class="mt-4 space-y-3">
                    <div class="p-3 bg-white rounded border">
                        <p class="font-medium">2025-10-27 15:30</p>
                        <p class="text-sm text-gray-600">用户 张三 添加了费用 "周末聚餐费用"</p>
                    </div>
                    <div class="p-3 bg-white rounded border">
                        <p class="font-medium">2025-10-26 10:15</p>
                        <p class="text-sm text-gray-600">用户 小明 添加了费用 "机场交通费"</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- 模态框 -->
<div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
        <p id="alert-message" class="text-lg font-medium mb-4 text-center"></p>
        <button onclick="closeCustomAlert()"
            class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition duration-150">确定</button>
    </div>
</div>

<div id="delete-confirm-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
        <div class="text-center">
            <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
            <p class="text-sm text-gray-600 mb-6" id="delete-confirm-message">您确定要删除这个费用吗？此操作无法撤销。</p>

            <div class="flex space-x-3">
                <button onclick="closeDeleteConfirm()"
                    class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                    取消
                </button>
                <button onclick="confirmDeleteExpense()"
                    class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                    确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<div id="delete-payment-confirm-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition duration-300 scale-100">
        <div class="text-center">
            <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
            <p class="text-sm text-gray-600 mb-6" id="delete-payment-confirm-message">您确定要删除这个支付吗？此操作无法撤销。</p>

            <div class="flex space-x-3">
                <button onclick="closeDeletePaymentConfirm()"
                    class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                    取消
                </button>
                <button onclick="confirmDeletePayment()"
                    class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                    确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 角色更新模态框 -->
<div id="role-update-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
        <div class="text-center">
            <div
                class="w-12 h-12 bg-primary/20 text-primary rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">确认角色更新</h3>
            <p class="text-sm text-gray-600 mb-6" id="role-update-message">确定要将成员 "小明" 设为管理员吗？</p>

            <div class="flex space-x-3">
                <button onclick="cancelUpdateRole()"
                    class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                    取消
                </button>
                <button onclick="confirmUpdateRole()"
                    class="flex-1 py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary-dark transition duration-150 text-sm font-medium">
                    确认更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 移除成员模态框 -->
<div id="remove-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
        <div class="text-center">
            <div class="w-12 h-12 bg-danger/20 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">确认移除</h3>
            <p class="text-sm text-gray-600 mb-6" id="remove-message">确定要将成员 "小明" 从群组中移除吗？</p>

            <div class="flex space-x-3">
                <button onclick="cancelRemoveMember()"
                    class="flex-1 py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 text-sm font-medium">
                    取消
                </button>
                <button onclick="confirmRemoveMember()"
                    class="flex-1 py-2 px-4 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                    确认移除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 添加费用弹窗 -->
<div id="add-expense-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">

        <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加新费用</h2>

        <form id="expense-form" onsubmit="handleSaveExpense(event)">

            <div class="space-y-6">

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                    <input type="text" id="description" name="description" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                        placeholder="例如：晚餐、酒店费用、杂货">
                </div>

                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm"> $ </span>
                        </div>
                        <input type="number" id="amount" name="amount" required step="0.01" min="0.01"
                            class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="0.00" oninput="handleAmountChange()">
                    </div>
                </div>

                <div>
                    <label for="payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                    <select id="payer" name="payer" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                        <option value="">请选择付款人</option>
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">日期</label>
                    <input type="date" id="date" name="date" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>

                <div id="participants-section">
                    <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- 参与者复选框将通过JavaScript动态生成 -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                </div>

                <!-- 移除了定期费用设置部分 -->


                <div id="receipt-upload-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">收据 / 证明 (可选)</label>
                    <label for="receipt-file"
                        class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary hover:bg-primary/5 transition duration-150">
                        <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        <span id="file-name-display" class="text-gray-700">点击上传收据图片 (最大 1MB)</span>
                    </label>
                    <input type="file" id="receipt-file" name="receipt-file" accept="image/*"
                        onchange="updateFileNameDisplay(this)">
                    <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                </div>

                <div id="split-method-selection" class="border-t pt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>

                    <div
                        class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-primary">
                        <button type="button" onclick="setSplitMethod('equal')" id="split-equal"
                            class="split-toggle-btn active flex-1">
                            Equally Split
                        </button>
                        <button type="button" onclick="setSplitMethod('exact')" id="split-exact"
                            class="split-toggle-btn flex-1">
                            Custom Amount
                        </button>
                    </div>
                </div>

                <div id="split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>

                    <div id="split-list" class="space-y-3">
                        <!-- 分摊详情将通过JavaScript动态生成 -->
                    </div>

                    <div id="split-summary" class="mt-4 pt-3 border-t">
                        <!-- 分摊摘要将通过JavaScript动态生成 -->
                    </div>
                </div>

            </div>

            <div class="mt-8 border-t pt-6">
                <button type="submit"
                    class="w-full py-3 bg-primary text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-primary-dark transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                    保存费用
                </button>
                <button type="button" onclick="handleCancel()"
                    class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                    取消
                </button>
            </div>

        </form>
    </div>
</div>

<!-- 添加支付弹窗 -->
<div id="add-payment-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">

        <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加新支付</h2>

        <form id="payment-form" onsubmit="handleSavePayment(event)">

            <div class="space-y-6">

                <div>
                    <label for="payment-description" class="block text-sm font-medium text-gray-700">支付描述</label>
                    <input type="text" id="payment-description" name="payment-description" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                        placeholder="例如：还款给小明、结算交通费">
                </div>

                <div>
                    <label for="payment-amount" class="block text-sm font-medium text-gray-700">支付金额 ($)</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm"> $ </span>
                        </div>
                        <input type="number" id="payment-amount" name="payment-amount" required step="0.01" min="0.01"
                            class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                            placeholder="0.00">
                    </div>
                </div>

                <div>
                    <label for="payment-to" class="block text-sm font-medium text-gray-700">支付给谁?</label>
                    <select id="payment-to" name="payment-to" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                        <option value="">请选择收款人</option>
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

                <div>
                    <label for="payment-for-expense" class="block text-sm font-medium text-gray-700">为哪个费用支付?</label>
                    <select id="payment-for-expense" name="payment-for-expense" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                        <option value="">请选择费用</option>
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

                <div>
                    <label for="payment-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                    <select id="payment-payer" name="payment-payer" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                        <option value="">请选择付款人</option>
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

                <div>
                    <label for="payment-date" class="block text-sm font-medium text-gray-700">支付日期</label>
                    <input type="date" id="payment-date" name="payment-date" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                </div>

                <div id="payment-receipt-upload-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">支付凭证 (可选)</label>
                    <label for="payment-receipt-file"
                        class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-success hover:bg-success/5 transition duration-150">
                        <svg class="w-6 h-6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        <span id="payment-file-name-display" class="text-gray-700">点击上传支付凭证图片 (最大 1MB)</span>
                    </label>
                    <input type="file" id="payment-receipt-file" name="payment-receipt-file" accept="image/*"
                        onchange="updatePaymentFileNameDisplay(this)">
                    <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                </div>

            </div>

            <div class="mt-8 border-t pt-6">
                <button type="submit"
                    class="w-full py-3 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                    保存支付
                </button>
                <button type="button" onclick="handlePaymentCancel()"
                    class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                    取消
                </button>
            </div>

        </form>
    </div>
</div>
<!-- 费用详情弹窗 -->
<div id="expense-detail-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">

        <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="expense-detail-title">费用详情</h2>

        <form id="expense-detail-form" onsubmit="handleUpdateExpense(event)">

            <div class="space-y-6">

                <div>
                    <label for="detail-description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                    <input type="text" id="detail-description" name="detail-description" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                        placeholder="例如：晚餐、酒店费用、杂货">
                </div>

                <div>
                    <label for="detail-amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm"> $ </span>
                        </div>
                        <input type="number" id="detail-amount" name="detail-amount" required step="0.01" min="0.01"
                            class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="0.00" oninput="handleDetailAmountChange()">
                    </div>
                </div>

                <div>
                    <label for="detail-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                    <select id="detail-payer" name="detail-payer" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                        <option value="">请选择付款人</option>
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

                <div>
                    <label for="detail-date" class="block text-sm font-medium text-gray-700">日期</label>
                    <input type="date" id="detail-date" name="detail-date" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>

                <div id="detail-participants-section">
                    <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200"
                        id="detail-participants-container">
                        <!-- 参与者复选框将通过JavaScript动态生成 -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                </div>
				
				<!-- 添加看大图 04 Nov  -->
				<div id="detail-current-receipt-preview" class="hidden space-y-2">
                    <label class="block text-sm font-medium text-gray-700">当前收据</label>
                    <div class="mt-1 w-full p-2 border border-gray-200 rounded-lg bg-gray-50 flex justify-center">
                        <a id="detail-current-receipt-link" href="#" target="_blank" rel="noopener noreferrer">
                            <img id="detail-current-receipt-img" src="" alt="当前收据" 
                                 class="max-w-full h-auto max-h-48 rounded shadow-sm object-contain">
                        </a>
                    </div>
                    <p class="text-xs text-gray-500 text-center">点击图片在新标签页中打开大图</p>
                </div>  
				<!-- 添加看大图 04 Nov  -->


                <!-- 分摊方式 -->
                <div id="detail-split-method-selection" class="border-t pt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>

                    <div
                        class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-primary">
                        <button type="button" onclick="setDetailSplitMethod('equal')" id="detail-split-equal"
                            class="split-toggle-btn active flex-1">
                            Equally Split
                        </button>
                        <button type="button" onclick="setDetailSplitMethod('exact')" id="detail-split-exact"
                            class="split-toggle-btn flex-1">
                            Custom Amount
                        </button>
                    </div>
                </div>

                <div id="detail-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>

                    <div id="detail-split-list" class="space-y-3">
                        <!-- 分摊详情将通过JavaScript动态生成 -->
                    </div>

                    <div id="detail-split-summary" class="mt-4 pt-3 border-t">
                        <!-- 分摊摘要将通过JavaScript动态生成 -->
                    </div>
                </div>

            </div>

            <div class="mt-8 border-t pt-6 flex justify-between">
                <button type="button" onclick="handleDeleteExpense()"
                    class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                    删除费用
                </button>
                <div class="flex space-x-3">
                    <button type="button" onclick="handleDetailCancel()"
                        class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
                    <button type="submit"
                        class="py-3 px-6 bg-primary text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-primary-dark transition duration-200">
                        更新费用
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

<!-- 添加定期费用弹窗 -->
<div id="add-recurring-expense-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">

        <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">添加定期费用</h2>

        <form id="recurring-expense-form" onsubmit="handleSaveRecurringExpense(event)">

            <div class="space-y-6">

                <div>
                    <label for="recurring-description" class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                    <input type="text" id="recurring-description" name="recurring-description" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                        placeholder="例如：每月房租、每周清洁费">
                </div>

                <div>
                    <label for="recurring-amount" class="block text-sm font-medium text-gray-700">金额 ($)</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm"> $ </span>
                        </div>
                        <input mber" id="recurring-amount" name="recurring-amount" required step="0.01"
                            min="0.01"
                            class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm"
                            placeholder="0.00" oninput="handleRecurringAmountChange()">
                    </div>
                </div>

                <div>
                    <label for="recurring-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                    <select id="recurring-payer" name="recurring-payer" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                        <option value="">请选择付款人</option>
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

             - 定期费用设置 -->
                <div id="recurring-section" class="border-t pt-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">定期费用设置</label>
                    </div>

                    <div id="recurring-options" class="recurring-options expanded">
                        <!-- 频率选择 -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">重复频率</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="frequency-option selected" onclick="selectFrequency('daily')">
                                    <div class="text-center">
                                        <div class="text-lg font-semibold">每日</div>
                                        <div class="text-xs opacity-75">每天重复</div>
                                    </div>
                            </div>
                                <div class="frequency-option" onclick="selectFrequency('weekly')">
                                    <div class="text-center">
                                        <div class="text-lg font-semibold">每周</div>
                                        <div class="text-xs opacity-75">每周同一天</div>
                                    </div>
                                </div>
                                <div class="frequency-optielectFrequency('monthly')">
                                    <div class="text-center">
                                        <div class="text-lg font-semibold">每月</div>
                                        <div class="text-xs opacity-75">每月同一天</div>
                                    </div>
                                </div>
                                <div class="frequency-option" onclick="selectFrequency('yearly')">
                                    <div class="text-center                             <div class="text-lg font-semibold">每年</div>
                                        <div class="text-xs opacity-75">每年同一天</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 重复设置 -->
                        <div id="recurring-settings" class="space-y-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4">
                                <div>
                                    <label for="repeat-start"
                                        class="block text-sm font-medium text-gray-700">开始日期</label>
                                    <input type="date" id="repeat-start" name="repeat-start" required
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:text-sm">
                        </div>
                                <div>
                                    <label for="repeat-end" class="block text-sm font-medium text-gray-700">结束日期
                                        (可选)</label>
                                    <input type="date" id="repeat-end" name="repeat-end"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-warning focus:border-warning sm:                              </div>
                            </div>
                        </div>

                        <!-- 预览区域 -->
                        <div id="recurring-preview" class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-900 mb-3">费用预览</h4>
                            <div id="preview-list" class="space-y-2">
                                <div class="preview-item p-3 rounded">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">初始费用</span>
                                        <span class="text-sm text-gray-600" id="preview-initial-date">2025-10-28</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1" id="preview-initial-amount">金额: $0.00</div>
                                </div>
                            </div>
                        ="text-xs text-gray-500 mt-2" id="preview-summary">共 1 笔费用</p>
                        </div>
                    </div>
                </div>

                <div id="recurring-participants-section">
                    <label class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- 参与者复选框将é-->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">请选择需要分摊此费用的成员</p>
                </div>

                <div id="recurring-split-method-selection" class="border-t pt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-4">如何分摊费用?</label>

                    <div
                        class="flex w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg border border-warning">
                  <button type="button" onclick="setRecurringSplitMethod('equal')" id="recurring-split-equal"
                            class="split-toggle-btn active flex-1">
                            Equally Split
                        </button>
                        <button type="button" onclick="setRecurringSplitMethod('exact')" id="recurring-split-exact"
                            class="split-toggle-btn flex-1">
                            Custom Amount
                        </button>
                    </div>
                </div>

                <div id="recurring-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold mb-2">分摊详情 (Equally Split)</h4>

                    <div id="recurring-split-list" class="space-y-3">
                        <!-- 分摊详情将通过JavaScript动态生成 -->
                    </div>

                    <div id="recurring-split-summary" class="mt-4 pt-3 border-t">
                        <!-- 分摊将通过JavaScript动态生成 -->
                    </div>
                </div>

            </div>

            <div class="mt-8 border-t pt-6">
                <button type="submit"
                    class="w-full py-3 bg-warning text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-amber-500 transition duration-200 transform hover:scale-[1.005] active:scale-[0.99]">
                    保存定期费用
                </button>
                <button type="button" onclick="handleRecur()"
                    class="w-full py-2 mt-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                    取消
                </button>
            </div>

        </form>
    </div>
</div>

<!-- 定期费用详情弹窗 -->
<div id="recurring-detail-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mxg:mx-8">

        <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="recurring-detail-title">定期费用详情</h2>

        <div class="space-y-6">

            <div>
                <label class="block text-sm font-medium text-gray-700">描述 / 目的</label>
                <p class="mt-1 text-gray-900 font-medium" id="recurring-detail-description">每月房租</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">金额 ($)</label>
                <p class="mt-1 text-gray-900 font-medium" id="recurring-detail-amount">$1500.00</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">谁支付了?</label>
                <p class="mt-1 text-gray-900" id="recurring-detail-payer">张三</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">频率</label>
                <p class="mt-1 text-gray-900" id="recurring-detail-frequency">每月</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">开始日期</label>
                <p class="mt-1 text-gray-900" id="recurring-detail-start-date">2025-11-01</p>
            </div>

            <div id="recurring-detail-end-date-container">
                <label class="block text-sm font-medium text-gray-700">结束日期</label>
                <p class="mt-1 text-gray-900" id="recurring-detail-end-date">2026-10-31</p>
        </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">状态</label>
                <div class="mt-1">
                    <span id="recurring-detail-status"
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success/10 text-success">
                        启用
                    </span>
                </div>
            </div>

            <div id="recurring-detail-participants-section">
             l class="block text-sm font-medium text-gray-700 mb-3">参与者 (需要分摊费用的成员)</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200"
                    id="recurring-detail-participants-container">
                    <!-- 参与者列表将通过JavaScript动态生成 -->
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">分摊方式</               <p class="text-gray-900" id="recurring-detail-split-method">Equally Split</p>
            </div>

            <div id="recurring-detail-split-details-section" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                <h4 class="font-semibold mb-2">分摊详情</h4>

                <div id="recurring-detail-split-list" class="space-y-3">
                    <!-- 分摊详情将通过JavaScript动态生成 -->
                </div>
            </div>

        </div>

        <div class="pt-6 flex justify-between">
            <div class="flex space-x-3">
                <button onclick="handleDisableRecurringExpense()" id="disable-recurring-btn"
                    class="py-3 px-6 bg-gray-600 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-gray-700 transition duration-200">
                    禁用
                </button>
                <button onclick="handleEnableRecurringExpense()" id="enable-recurring-btn" class="hidden"
                    class="py-3 px-6 bg-succtext-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200">
                    启用
                </button>
                <button onclick="handleDeleteRecurringExpense()"
                    class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                    删除定期费用
                </button>
            </div>
            <div class="flex space-x-3">
                <button onclick="handleRecurringDetailCancel()"
                    class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                    关闭
                </button>
                <button onclick="handleEditRecurringExpense()"
                    class="py-3 px-6 bg-warning text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-amber-500 transition duration-200">
                    编辑定期费用
                </button>
            </div>
        </div>

    </div>
</div>



<!-- 支付详情弹窗 -->
<div id="payment-detail-modal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-40 hidden overflow-y-auto pt-10 pb-10">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl w-full mx-4 sm:mx-6 lg:mx-8">

        <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4" id="payment-detail-title">支付详情</h2>

        <form id="payment-detail-form" onsubmit="handleUpdatePayment(event)">

        <div class="space-y-6">

                <div>
                    <label for="payment-detail-description" class="block text-sm font-medium text-gray-700">支付描述</label>
                    <input type="text" id="payment-detail-description" name="payment-detail-description" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                        placeholder="例如ï                </div>

                <div>
                    <label for="payment-detail-amount" class="block text-sm font-medium text-gray-700">支付金额 ($)</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm"> $ </span>
                        </div>
                        <input type="number" id="payail-amount" name="payment-detail-amount" required
                            step="0.01" min="0.01"
                            class="block w-full pl-8 pr-12 border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-success focus:border-success sm:text-sm"
                            placeholder="0.00">
                    </div>
                </div>

                <div>
                    <label for="payment-detail-to" class="block text-sm font-medium text-gray-700">支付给谁?</label>
            <select id="payment-detail-to" name="payment-detail-to" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                        <option value="">请选择收款人</option>
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

                <div>
                    <label for="payment-deta"
                        class="block text-sm font-medium text-gray-700">为哪个费用支付?</label>
                    <select id="payment-detail-for-expense" name="payment-detail-for-expense" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                        <option value="">请选择费用</option>
                        <!-- 选项将通过JavaScript动态生                  </select>
                </div>

                <div>
                    <label for="payment-detail-payer" class="block text-sm font-medium text-gray-700">谁支付了?</label>
                    <select id="payment-detail-payer" name="payment-detail-payer" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success focus:border-success sm:text-sm">
                        <option value="">请选æ                       <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                </div>

                <div>
                    <label for="payment-detail-date" class="block text-sm font-medium text-gray-700">支付日期</label>
                    <input type="date" id="payment-detail-date" name="payment-detail-date" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-success fr-success sm:text-sm">
                </div>

                <div id="payment-detail-receipt-upload-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">支付凭证 (可选)</label>
                    <label for="payment-detail-receipt-file"
                        class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-success hover:bg-success/5 transition duration-150">
                        <svg c6 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        <span id="payment-detail-file-name-display" class="text-gray-700">点击上传支付凭证图片 (最大 1MB)</s                 </label>
                    <input type="file" id="payment-detail-receipt-file" name="payment-detail-receipt-file"
                        accept="image/*" onchange="updatePaymentDetailFileNameDisplay(this)">
                    <p class="text-xs text-gray-500 mt-1">仅支持图片格式 (JPEG, PNG)。</p>
                </div>

            </div>

            <div class="mt-8 border-t pt-6 flex justify-between">
                <button type="button" onclick="handleDeletePayment()"
                    class="py-3 px-6 bg-danger text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition duration-200">
                    删除支付
                </button>
                <div class="flex space-x-3">
                    <button type="button" onclick="handlePaymentDetailCancel()"
                        class="py-3 px-6 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-150">
                        取消
                    </button>
        <button type="submit"
                        class="py-3 px-6 bg-success text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-emerald-600 transition duration-200">
                        更新支付
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
    function goBackToHome() {
        window.location.href = '/home';
    }
</script>

<!-- 传统模式加载 - 解决ES6模块兼容性问题 -->
<script>
    console.log('🔧 启用群组页面传统模式加载...');
    
    // 基础功能立即可用
    window.setActiveTab = function(tab) {
        console.log('setActiveTab called:', tab);
        
        // 移除所有活动标签
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 隐藏所有内容
        document.querySelectorAll('[id$="-content"]').forEach(content => {
            content.style.display = 'none';
        });
        
        // 激活当前标签
        const activeBtn = document.querySelector(`button[onclick*="${tab}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // 显示对应内容
        const content = document.getElementById(tab + '-content');
        if (content) {
            content.style.display = 'block';
        }
    };
    
    window.handleAddNewExpense = function() {
        console.log('handleAddNewExpense called');
        const modal = document.getElementById('add-expense-modal');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            // 打开添加费用模态框
            showAddExpenseModal();
        }
    };
    
    window.handleAddNewPayment = function() {
        console.log('handleAddNewPayment called');
        const modal = document.getElementById('add-payment-modal');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            alert('添加支付功能暂时不可用，请刷新页面重试');
        }
    };
    
    window.handleAddNewRecurringExpense = function() {
        console.log('handleAddNewRecurringExpense called');
        const modal = document.getElementById('add-recurring-expense-modal');
        if (modal) {
            modal.classList.remove('hidden');
        } else {
            alert('添加定期费用功能暂时不可用，请刷新页面重试');
        }
    };
    
    window.closeModal = function(modalId) {
        console.log('closeModal called:', modalId);
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
        }
    };
    
    // 取消操作
    window.handleCancel = function() {
        const form = document.getElementById('expense-form');
        if (form) {
            form.reset();
        }
        closeModal('add-expense-modal');
    };

    // 保存费用
    window.handleSaveExpense = async function(event) {
        event.preventDefault();
        
        try {
            const form = document.getElementById('expense-form');
            const formData = new FormData(form);
            
            const expenseData = {
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                payer_id: parseInt(formData.get('payer')),
                category: formData.get('category') || '其他',
                date: formData.get('date') || new Date().toISOString().split('T')[0]
            };
            
            const groupId = getGroupId();
            const token = getToken();
            
            const response = await fetch(`/api/groups/${groupId}/expenses`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(expenseData)
            });
            
            if (response.ok) {
                alert('费用添加成功！');
                closeModal('add-expense-modal');
                form.reset();
                // 重新加载数据
                loadGroupData();
            } else {
                const error = await response.json();
                alert('添加费用失败: ' + (error.detail || '未知错误'));
            }
        } catch (error) {
            console.error('添加费用失败:', error);
            alert('添加费用失败，请检查网络连接');
        }
    };

    // 模态框处理函数
    window.handleExpenseCancel = function() {
        window.closeModal('add-expense-modal');
    };
    
    window.handlePaymentCancel = function() {
        window.closeModal('add-payment-modal');
    };
    
    window.handleRecurringExpenseCancel = function() {
        window.closeModal('add-recurring-expense-modal');
    };
    
    window.handleExpenseDetailCancel = function() {
        window.closeModal('expense-detail-modal');
    };
    
    window.handlePaymentDetailCancel = function() {
        window.closeModal('payment-detail-modal');
    };
    
    // 认证检查函数
    window.getAuthToken = function() {
        return localStorage.getItem('access_token');
    };

    window.checkAuth = function() {
        const token = window.getAuthToken();
        if (!token) {
            console.warn('未找到认证token');
            window.location.href = '/login';
            return false;
        }
        return true;
    };
    
    // 通用模态框关闭处理
    window.setupModalCloseHandlers = function() {
        // 点击背景关闭模态框
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.closest('.modal').classList.add('hidden');
                }
            });
        });
        
        // ESC键关闭模态框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal:not(.hidden)').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
        });
    };
    
    console.log('✅ 群组页面传统模式基础功能已加载');
</script>

<!-- 条件加载：检查功能状态 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('群组页面DOM加载完成，检查功能状态...');
    
    // 检查认证
    if (!window.checkAuth()) return;
    
    // 检查关键函数是否存在
    const functionsToCheck = [
        'setActiveTab',
        'handleAddNewExpense', 
        'handleAddNewPayment',
        'handleAddNewRecurringExpense',
        'closeModal'
    ];
    
    let allFunctionsReady = true;
    functionsToCheck.forEach(funcName => {
        if (typeof window[funcName] !== 'function') {
            console.warn(`函数 ${funcName} 未定义`);
            allFunctionsReady = false;
        }
    });
    
    if (allFunctionsReady) {
        console.log('✅ 群组页面所有核心功能正常');
        
        // 设置模态框关闭处理
        window.setupModalCloseHandlers();
        
        // 重新绑定按钮事件
        rebindAllEvents();
        
        // 默认显示费用标签
        window.setActiveTab('expenses');
    } else {
        console.warn('⚠️ 检测到群组页面功能缺失');
        alert('检测到页面功能异常，请刷新页面或在控制台运行修复脚本');
    }
});

function rebindAllEvents() {
    console.log('重新绑定群组页面按钮事件...');
    
    // 标签切换按钮
    document.querySelectorAll('.tab-button').forEach((btn, index) => {
        const tabs = ['expenses', 'recurring', 'payments', 'members', 'invite', 'manage', 'audit'];
        const tab = tabs[index] || 'expenses';
        
        btn.onclick = function() {
            window.setActiveTab(tab);
        };
    });
    
    // 添加按钮
    const addExpenseBtn = document.querySelector('[onclick*="handleAddNewExpense"]');
    if (addExpenseBtn) {
        addExpenseBtn.onclick = window.handleAddNewExpense;
    }
    
    const addPaymentBtn = document.querySelector('[onclick*="handleAddNewPayment"]');
    if (addPaymentBtn) {
        addPaymentBtn.onclick = window.handleAddNewPayment;
    }
    
    const addRecurringBtn = document.querySelector('[onclick*="handleAddNewRecurringExpense"]');
    if (addRecurringBtn) {
        addRecurringBtn.onclick = window.handleAddNewRecurringExpense;
    }
    
    // 模态框关闭按钮
    document.querySelectorAll('[onclick*="closeModal"], .close-modal, [onclick*="Cancel"]').forEach(btn => {
        const originalOnclick = btn.getAttribute('onclick');
        if (originalOnclick && originalOnclick.includes('Cancel')) {
            // 保持原有的取消函数
            return;
        }
        
        btn.onclick = function() {
            const modal = this.closest('.modal') || this.closest('[id$="-modal"]');
            if (modal) {
                modal.classList.add('hidden');
            }
        };
    });
    
    console.log('✅ 群组页面所有按钮事件已重新绑定');
}

// 添加动态数据加载功能
function getToken() {
    return localStorage.getItem('access_token');
}

function getGroupId() {
    const path = window.location.pathname;
    const match = path.match(/\/groups\/(\d+)/);
    return match ? parseInt(match[1]) : 1;
}

// 加载群组数据
async function loadGroupData() {
    try {
        const groupId = getGroupId();
        const token = getToken();
        
        if (!token) {
            console.error('未找到访问令牌');
            return;
        }
        
        const response = await fetch(`/api/groups/${groupId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const groupData = await response.json();
            updateGroupDisplay(groupData);
            await loadGroupBalance(groupId);
            await loadMembers(groupId);
        } else {
            console.error('获取群组数据失败:', response.status);
        }
    } catch (error) {
        console.error('加载群组数据失败:', error);
    }
}

// 更新群组显示
function updateGroupDisplay(groupData) {
    const nameElement = document.getElementById('group-name-display');
    const nameInput = document.getElementById('group-name-input');
    const descInput = document.getElementById('group-description-input');
    
    if (nameElement) {
        nameElement.innerHTML = `${groupData.name} <span class="text-sm font-normal text-gray-500">(ID: ${groupData.id})</span>`;
    }
    if (nameInput) {
        nameInput.value = groupData.name || '';
    }
    if (descInput) {
        descInput.value = groupData.description || '';
    }
}

// 加载群组余额
async function loadGroupBalance(groupId) {
    try {
        const token = getToken();
        const response = await fetch(`/api/groups/${groupId}/balances`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const balanceData = await response.json();
            updateBalanceDisplay(balanceData);
        } else {
            console.error('获取余额数据失败:', response.status);
        }
    } catch (error) {
        console.error('加载余额数据失败:', error);
    }
}

// 更新余额显示
function updateBalanceDisplay(balanceData) {
    const balanceOwed = document.getElementById('balance-owed');
    const balanceOwedCount = document.getElementById('balance-owed-count');
    const balanceOwingMe = document.getElementById('balance-owing-me');
    const balanceOwingCount = document.getElementById('balance-owing-count');
    const settlementCount = document.getElementById('settlement-count');
    
    if (balanceOwed) {
        balanceOwed.textContent = `¥${(balanceData.total_owed || 0).toFixed(2)}`;
    }
    if (balanceOwedCount) {
        balanceOwedCount.textContent = balanceData.owed_to_count || 0;
    }
    if (balanceOwingMe) {
        balanceOwingMe.textContent = `¥${(balanceData.total_owing || 0).toFixed(2)}`;
    }
    if (balanceOwingCount) {
        balanceOwingCount.textContent = balanceData.owing_from_count || 0;
    }
    if (settlementCount) {
        const totalCount = (balanceData.owed_to_count || 0) + (balanceData.owing_from_count || 0);
        settlementCount.textContent = totalCount;
    }
}

// 加载成员列表
async function loadMembers(groupId) {
    try {
        const token = getToken();
        const response = await fetch(`/api/groups/${groupId}/members`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const membersData = await response.json();
            updateExpenseModalMembers(membersData);
        } else {
            console.error('获取成员列表失败:', response.status);
        }
    } catch (error) {
        console.error('加载成员列表失败:', error);
    }
}

// 更新费用模态框中的成员选择
function updateExpenseModalMembers(members) {
    const payerSelect = document.getElementById('expense-payer');
    if (payerSelect) {
        // 清空现有选项
        payerSelect.innerHTML = '<option value="">选择付款人</option>';
        
        // 添加成员选项
        members.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = member.username;
            payerSelect.appendChild(option);
        });
    }
    
    // 更新结算相关成员选择
    const settleSelects = document.querySelectorAll('[id*="settle-member"]');
    settleSelects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">选择成员</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.username;
                select.appendChild(option);
            });
            // 恢复之前选中的值
            if (currentValue) {
                select.value = currentValue;
            }
        }
    });
}

// 显示添加费用模态框
function showAddExpenseModal() {
    const modal = document.getElementById('add-expense-modal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
}

// 关闭模态框
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadGroupData();
    
    // 绑定关闭模态框事件
    const closeButtons = document.querySelectorAll('.close-modal, [onclick*="closeModal"]');
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('[id$="-modal"]');
            if (modal) {
                closeModal(modal.id);
            }
        });
    });
    
    // ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('[id$="-modal"]:not(.hidden)');
            modals.forEach(modal => {
                closeModal(modal.id);
            });
        }
    });
});
</script>

{% endblock %}


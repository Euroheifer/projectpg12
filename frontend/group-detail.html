<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群组详情 - AA支付系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            min-height: calc(100vh - 56px);
        }
        
        .main-content {
            padding: 20px;
        }
        
        .group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .expense-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }
        
        .expense-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .balance-amount {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .positive {
            color: #28a745;
        }
        
        .negative {
            color: #dc3545;
        }
        
        .nav-tabs .nav-link {
            border-radius: 20px 20px 0 0;
            border: none;
            color: #6c757d;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .modal-header {
            background-color: #007bff;
            color: white;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .group-header {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-currency-exchange"></i> AA支付系统</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#" id="backBtn"><i class="bi bi-arrow-left"></i> 返回群组列表</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3 sidebar">
                <div class="p-3">
                    <h5><i class="bi bi-people"></i> 群组成员</h5>
                    <div id="memberList" class="mb-4">
                        <!-- 成员列表将在这里动态加载 -->
                    </div>
                    
                    <button class="btn btn-success btn-sm w-100 mb-3" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                        <i class="bi bi-person-plus"></i> 添加成员
                    </button>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-calculator"></i> 余额结算</h6>
                        </div>
                        <div class="card-body">
                            <div id="balanceSummary">
                                <!-- 余额结算信息将在这里动态加载 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-9 main-content">
                <!-- 群组信息头部 -->
                <div class="group-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 id="groupName">加载中...</h2>
                            <p id="groupDescription" class="mb-0">请稍候...</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#createExpenseModal">
                                <i class="bi bi-plus-circle"></i> 创建支出
                            </button>
                            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#createPaymentModal">
                                <i class="bi bi-credit-card"></i> 记录支付
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 标签页 -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
                            <i class="bi bi-receipt"></i> 支出列表
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
                            <i class="bi bi-arrow-left-right"></i> 支付记录
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                            <i class="bi bi-clock-history"></i> 活动日志
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recurring-tab" data-bs-toggle="tab" data-bs-target="#recurring" type="button" role="tab">
                            <i class="bi bi-arrow-repeat"></i> 定期支出
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="mainTabContent">
                    <!-- 支出列表 -->
                    <div class="tab-pane fade show active" id="expenses" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>群组支出</h5>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary active" id="filterAll">全部</button>
                                <button class="btn btn-outline-secondary" id="filterPaid">已支付</button>
                                <button class="btn btn-outline-secondary" id="filterUnpaid">未支付</button>
                            </div>
                        </div>
                        <div id="expenseList">
                            <!-- 支出列表将在这里动态加载 -->
                        </div>
                    </div>

                    <!-- 支付记录 -->
                    <div class="tab-pane fade" id="payments" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>支付记录</h5>
                            <span class="badge bg-success">已平衡</span>
                        </div>
                        <div id="paymentList">
                            <!-- 支付记录将在这里动态加载 -->
                        </div>
                    </div>

                    <!-- 活动日志 -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <h5>活动日志</h5>
                        <div class="activity-log">
                            <div id="activityLog">
                                <!-- 活动日志将在这里动态加载 -->
                            </div>
                        </div>
                    </div>

                    <!-- 定期支出 -->
                    <div class="tab-pane fade" id="recurring" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>定期支出</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createRecurringModal">
                                <i class="bi bi-plus-circle"></i> 添加定期支出
                            </button>
                        </div>
                        <div id="recurringList">
                            <!-- 定期支出列表将在这里动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加成员模态框 -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加群组成员</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberForm">
                        <div class="mb-3">
                            <label for="memberEmail" class="form-label">成员邮箱</label>
                            <input type="email" class="form-control" id="memberEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberRole" class="form-label">角色</label>
                            <select class="form-select" id="memberRole">
                                <option value="member">普通成员</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addMember()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建支出模态框 -->
    <div class="modal fade" id="createExpenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新支出</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createExpenseForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expenseTitle" class="form-label">支出标题</label>
                                <input type="text" class="form-control" id="expenseTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="expenseAmount" class="form-label">金额</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="expenseAmount" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expenseDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="expenseDescription" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expenseCategory" class="form-label">分类</label>
                                <select class="form-select" id="expenseCategory">
                                    <option value="food">餐饮</option>
                                    <option value="transport">交通</option>
                                    <option value="entertainment">娱乐</option>
                                    <option value="shopping">购物</option>
                                    <option value="bill">账单</option>
                                    <option value="other">其他</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="expenseDate" class="form-label">日期</label>
                                <input type="date" class="form-control" id="expenseDate" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">分摊方式</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="splitType" id="splitEqual" value="equal" checked>
                                <label class="btn btn-outline-primary" for="splitEqual">平均分摊</label>
                                
                                <input type="radio" class="btn-check" name="splitType" id="splitCustom" value="custom">
                                <label class="btn btn-outline-primary" for="splitCustom">自定义</label>
                            </div>
                        </div>
                        <div id="customSplitSection" class="d-none">
                            <label class="form-label">自定义分摊金额</label>
                            <div id="customSplitInputs">
                                <!-- 自定义分摊输入将在这里动态生成 -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createExpense()">创建支出</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 记录支付模态框 -->
    <div class="modal fade" id="createPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">记录支付</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPaymentForm">
                        <div class="mb-3">
                            <label for="paymentPayer" class="form-label">付款人</label>
                            <select class="form-select" id="paymentPayer" required>
                                <!-- 成员选项将在这里动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentReceiver" class="form-label">收款人</label>
                            <select class="form-select" id="paymentReceiver" required>
                                <!-- 成员选项将在这里动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">支付金额</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" id="paymentAmount" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="paymentDescription" class="form-label">说明</label>
                            <textarea class="form-control" id="paymentDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="paymentDate" class="form-label">支付日期</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="createPayment()">记录支付</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建定期支出模态框 -->
    <div class="modal fade" id="createRecurringModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建定期支出</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRecurringForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="recurringTitle" class="form-label">支出标题</label>
                                <input type="text" class="form-control" id="recurringTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="recurringAmount" class="form-label">金额</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="recurringAmount" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="recurringFrequency" class="form-label">重复频率</label>
                            <select class="form-select" id="recurringFrequency">
                                <option value="daily">每天</option>
                                <option value="weekly">每周</option>
                                <option value="monthly">每月</option>
                                <option value="yearly">每年</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="recurringStartDate" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="recurringStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="recurringEndDate" class="form-label">结束日期（可选）</label>
                            <input type="date" class="form-control" id="recurringEndDate">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">分摊方式</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="recurringSplitType" id="recurringSplitEqual" value="equal" checked>
                                <label class="btn btn-outline-primary" for="recurringSplitEqual">平均分摊</label>
                                
                                <input type="radio" class="btn-check" name="recurringSplitType" id="recurringSplitCustom" value="custom">
                                <label class="btn btn-outline-primary" for="recurringSplitCustom">自定义</label>
                            </div>
                        </div>
                        <div id="recurringCustomSplitSection" class="d-none">
                            <label class="form-label">自定义分摊金额</label>
                            <div id="recurringCustomSplitInputs">
                                <!-- 自定义分摊输入将在这里动态生成 -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createRecurringExpense()">创建定期支出</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除这个<span id="deleteType">项目</span>吗？此操作无法撤销。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">删除</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentGroup = null;
        let groupMembers = [];
        let expenses = [];
        let payments = [];
        let activityLog = [];
        let recurringExpenses = [];
        let selectedGroupId = null;

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 获取群组ID（从URL参数或全局变量）
            selectedGroupId = getGroupIdFromUrl() || 1;
            
            // 设置当前日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            document.getElementById('paymentDate').value = today;
            document.getElementById('recurringStartDate').value = today;
            
            // 加载数据
            loadGroupData();
            
            // 绑定事件
            bindEvents();
        });

        // 获取群组ID
        function getGroupIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('groupId');
        }

        // 绑定事件
        function bindEvents() {
            // 分摊方式切换
            document.querySelectorAll('input[name="splitType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const customSection = document.getElementById('customSplitSection');
                    if (this.value === 'custom') {
                        customSection.classList.remove('d-none');
                        generateCustomSplitInputs();
                    } else {
                        customSection.classList.add('d-none');
                    }
                });
            });

            // 定期支出分摊方式切换
            document.querySelectorAll('input[name="recurringSplitType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const customSection = document.getElementById('recurringCustomSplitSection');
                    if (this.value === 'custom') {
                        customSection.classList.remove('d-none');
                        generateRecurringCustomSplitInputs();
                    } else {
                        customSection.classList.add('d-none');
                    }
                });
            });

            // 过滤器按钮
            document.getElementById('filterAll').addEventListener('click', () => filterExpenses('all'));
            document.getElementById('filterPaid').addEventListener('click', () => filterExpenses('paid'));
            document.getElementById('filterUnpaid').addEventListener('click', () => filterExpenses('unpaid'));

            // 返回按钮
            document.getElementById('backBtn').addEventListener('click', function(e) {
                e.preventDefault();
                window.history.back();
            });
        }

        // 生成自定义分摊输入
        function generateCustomSplitInputs() {
            const container = document.getElementById('customSplitInputs');
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <label class="form-label">${member.name} 应支付金额</label>
                    <div class="input-group">
                        <span class="input-group-text">¥</span>
                        <input type="number" class="form-control" name="split_${member.id}" step="0.01" placeholder="0.00">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 生成定期支出自定义分摊输入
        function generateRecurringCustomSplitInputs() {
            const container = document.getElementById('recurringCustomSplitInputs');
            container.innerHTML = '';
            
            groupMembers.forEach(member => {
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <label class="form-label">${member.name} 应支付金额</label>
                    <div class="input-group">
                        <span class="input-group-text">¥</span>
                        <input type="number" class="form-control" name="recurring_split_${member.id}" step="0.01" placeholder="0.00">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 加载群组数据
        async function loadGroupData() {
            try {
                // 模拟API调用
                await Promise.all([
                    loadGroupInfo(),
                    loadMembers(),
                    loadExpenses(),
                    loadPayments(),
                    loadActivityLog(),
                    loadRecurringExpenses()
                ]);
                
                calculateBalances();
                renderMemberList();
                renderExpenseList();
                renderPaymentList();
                renderActivityLog();
                renderRecurringList();
                renderBalanceSummary();
            } catch (error) {
                console.error('加载数据失败:', error);
                showAlert('加载数据失败，请刷新页面重试', 'error');
            }
        }

        // 加载群组信息
        async function loadGroupInfo() {
            // 模拟API响应
            currentGroup = {
                id: selectedGroupId,
                name: '周末聚餐群',
                description: '记录我们每次聚餐的花费',
                createdAt: '2025-10-01',
                memberCount: 5,
                totalExpenses: 1250.50,
                status: 'active'
            };

            document.getElementById('groupName').textContent = currentGroup.name;
            document.getElementById('groupDescription').textContent = currentGroup.description;
        }

        // 加载成员列表
        async function loadMembers() {
            // 模拟API响应
            groupMembers = [
                { id: 1, name: '张三', email: 'zhang@example.com', avatar: 'Z', role: 'admin', balance: 125.50 },
                { id: 2, name: '李四', email: 'li@example.com', avatar: 'L', role: 'member', balance: -89.30 },
                { id: 3, name: '王五', email: 'wang@example.com', avatar: 'W', role: 'member', balance: 45.20 },
                { id: 4, name: '赵六', email: 'zhao@example.com', avatar: 'Z', role: 'member', balance: -180.90 },
                { id: 5, name: '钱七', email: 'qian@example.com', avatar: 'Q', role: 'member', balance: 99.50 }
            ];
        }

        // 加载支出列表
        async function loadExpenses() {
            // 模拟API响应
            expenses = [
                {
                    id: 1,
                    title: '火锅聚餐',
                    amount: 320.50,
                    description: '老北京火锅店',
                    category: 'food',
                    payerId: 1,
                    payerName: '张三',
                    date: '2025-11-01',
                    splitType: 'equal',
                    status: 'pending',
                    shares: [
                        { memberId: 1, amount: 64.10, paid: true },
                        { memberId: 2, amount: 64.10, paid: false },
                        { memberId: 3, amount: 64.10, paid: true },
                        { memberId: 4, amount: 64.10, paid: false },
                        { memberId: 5, amount: 64.10, paid: true }
                    ]
                },
                {
                    id: 2,
                    title: '打车费用',
                    amount: 45.00,
                    description: '从市中心到火锅店',
                    category: 'transport',
                    payerId: 3,
                    payerName: '王五',
                    date: '2025-11-01',
                    splitType: 'equal',
                    status: 'paid',
                    shares: [
                        { memberId: 1, amount: 9.00, paid: true },
                        { memberId: 2, amount: 9.00, paid: true },
                        { memberId: 3, amount: 9.00, paid: true },
                        { memberId: 4, amount: 9.00, paid: true },
                        { memberId: 5, amount: 9.00, paid: true }
                    ]
                },
                {
                    id: 3,
                    title: 'ktv娱乐',
                    amount: 480.00,
                    description: '周末KTV唱歌',
                    category: 'entertainment',
                    payerId: 5,
                    payerName: '钱七',
                    date: '2025-10-28',
                    splitType: 'custom',
                    status: 'pending',
                    shares: [
                        { memberId: 1, amount: 100.00, paid: false },
                        { memberId: 2, amount: 80.00, paid: false },
                        { memberId: 3, amount: 120.00, paid: true },
                        { memberId: 4, amount: 80.00, paid: false },
                        { memberId: 5, amount: 100.00, paid: true }
                    ]
                }
            ];
        }

        // 加载支付记录
        async function loadPayments() {
            // 模拟API响应
            payments = [
                {
                    id: 1,
                    payerId: 2,
                    payerName: '李四',
                    receiverId: 1,
                    receiverName: '张三',
                    amount: 64.10,
                    description: '火锅聚餐分摊',
                    date: '2025-11-02',
                    status: 'completed'
                },
                {
                    id: 2,
                    payerId: 4,
                    receiverId: 5,
                    amount: 45.00,
                    description: 'ktv分摊',
                    date: '2025-10-29',
                    status: 'completed'
                }
            ];
        }

        // 加载活动日志
        async function loadActivityLog() {
            // 模拟API响应
            activityLog = [
                {
                    id: 1,
                    type: 'expense_created',
                    description: '张三创建了支出 "火锅聚餐"',
                    userId: 1,
                    userName: '张三',
                    timestamp: '2025-11-01 18:30:00',
                    details: { amount: 320.50 }
                },
                {
                    id: 2,
                    type: 'payment_made',
                    description: '李四向张三支付了 ¥64.10',
                    userId: 2,
                    userName: '李四',
                    timestamp: '2025-11-02 10:15:00',
                    details: { amount: 64.10 }
                },
                {
                    id: 3,
                    type: 'member_added',
                    description: '王五邀请钱七加入了群组',
                    userId: 3,
                    userName: '王五',
                    timestamp: '2025-10-15 14:20:00',
                    details: { newMember: '钱七' }
                },
                {
                    id: 4,
                    type: 'expense_created',
                    description: '钱七创建了支出 "ktv娱乐"',
                    userId: 5,
                    userName: '钱七',
                    timestamp: '2025-10-28 20:45:00',
                    details: { amount: 480.00 }
                }
            ];
        }

        // 加载定期支出
        async function loadRecurringExpenses() {
            // 模拟API响应
            recurringExpenses = [
                {
                    id: 1,
                    title: '月度聚餐基金',
                    amount: 500.00,
                    frequency: 'monthly',
                    nextDate: '2025-12-01',
                    splitType: 'equal',
                    isActive: true
                },
                {
                    id: 2,
                    title: '周租金分摊',
                    amount: 1200.00,
                    frequency: 'weekly',
                    nextDate: '2025-11-08',
                    splitType: 'equal',
                    isActive: true
                }
            ];
        }

        // 计算余额
        function calculateBalances() {
            // 重置所有成员余额
            groupMembers.forEach(member => {
                member.balance = 0;
            });

            // 计算支出分摊
            expenses.forEach(expense => {
                expense.shares.forEach(share => {
                    const member = groupMembers.find(m => m.id === share.memberId);
                    if (member) {
                        if (share.memberId === expense.payerId) {
                            // 支出者收取金额
                            member.balance += share.amount;
                        } else if (share.paid) {
                            // 已支付者增加支出金额
                            member.balance -= share.amount;
                        }
                    }
                });
            });

            // 计算支付记录
            payments.forEach(payment => {
                const payer = groupMembers.find(m => m.id === payment.payerId);
                const receiver = groupMembers.find(m => m.id === payment.receiverId);
                
                if (payer && receiver) {
                    payer.balance -= payment.amount;
                    receiver.balance += payment.amount;
                }
            });
        }

        // 渲染成员列表
        function renderMemberList() {
            const container = document.getElementById('memberList');
            container.innerHTML = '';

            groupMembers.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'd-flex align-items-center justify-content-between mb-2 p-2 border rounded';
                memberDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="member-avatar me-2">${member.avatar}</div>
                        <div>
                            <div class="fw-bold">${member.name}</div>
                            <small class="text-muted">${member.role === 'admin' ? '管理员' : '成员'}</small>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="balance-amount ${member.balance >= 0 ? 'positive' : 'negative'}">
                            ${member.balance >= 0 ? '+' : ''}¥${member.balance.toFixed(2)}
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeMember(${member.id})" title="移除成员">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
                container.appendChild(memberDiv);
            });
        }

        // 渲染支出列表
        function renderExpenseList() {
            const container = document.getElementById('expenseList');
            container.innerHTML = '';

            expenses.forEach(expense => {
                const expenseDiv = document.createElement('div');
                expenseDiv.className = 'expense-card';
                
                const categoryIcon = {
                    'food': 'bi-cup-hot',
                    'transport': 'bi-bus',
                    'entertainment': 'bi-music-note',
                    'shopping': 'bi-bag',
                    'bill': 'bi-receipt',
                    'other': 'bi-three-dots'
                };

                expenseDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi ${categoryIcon[expense.category]} me-2"></i>
                                <h6 class="mb-0 me-2">${expense.title}</h6>
                                <span class="badge bg-${expense.status === 'paid' ? 'success' : 'warning'}">
                                    ${expense.status === 'paid' ? '已支付' : '待支付'}
                                </span>
                            </div>
                            <p class="text-muted mb-2">${expense.description}</p>
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted">支付人: ${expense.payerName}</small>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">日期: ${expense.date}</small>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">分摊: ${expense.splitType === 'equal' ? '平均' : '自定义'}</small>
                                </div>
                            </div>
                        </div>
                        <div class="text-end ms-3">
                            <div class="h5 mb-1">¥${expense.amount.toFixed(2)}</div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewExpenseDetails(${expense.id})">
                                    <i class="bi bi-eye"></i> 查看
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteExpense(${expense.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(expenseDiv);
            });
        }

        // 渲染支付记录
        function renderPaymentList() {
            const container = document.getElementById('paymentList');
            container.innerHTML = '';

            payments.forEach(payment => {
                const paymentDiv = document.createElement('div');
                paymentDiv.className = 'card mb-2';
                paymentDiv.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    <i class="bi bi-arrow-left text-danger"></i>
                                    ${payment.payerName}
                                    <i class="bi bi-arrow-right mx-2"></i>
                                    <i class="bi bi-arrow-right text-success"></i>
                                    ${payment.receiverName}
                                </h6>
                                <p class="text-muted mb-0">${payment.description}</p>
                                <small class="text-muted">${payment.date}</small>
                            </div>
                            <div class="text-end">
                                <div class="h5 mb-0 text-success">¥${payment.amount.toFixed(2)}</div>
                                <span class="badge bg-success">已完成</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(paymentDiv);
            });
        }

        // 渲染活动日志
        function renderActivityLog() {
            const container = document.getElementById('activityLog');
            container.innerHTML = '';

            activityLog.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'log-item';
                
                const iconMap = {
                    'expense_created': 'bi-receipt',
                    'payment_made': 'bi-arrow-left-right',
                    'member_added': 'bi-person-plus',
                    'member_removed': 'bi-person-dash',
                    'group_created': 'bi-people'
                };

                logDiv.innerHTML = `
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="bi ${iconMap[log.type]}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="mb-1">${log.description}</div>
                            <small class="text-muted">${log.timestamp}</small>
                        </div>
                    </div>
                `;
                container.appendChild(logDiv);
            });
        }

        // 渲染定期支出列表
        function renderRecurringList() {
            const container = document.getElementById('recurringList');
            container.innerHTML = '';

            recurringExpenses.forEach(recurring => {
                const recurringDiv = document.createElement('div');
                recurringDiv.className = 'card mb-2';
                recurringDiv.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${recurring.title}</h6>
                                <p class="text-muted mb-1">
                                    下次执行: ${recurring.nextDate} | 
                                    频率: ${recurring.frequency === 'daily' ? '每天' : 
                                           recurring.frequency === 'weekly' ? '每周' : 
                                           recurring.frequency === 'monthly' ? '每月' : '每年'}
                                </p>
                                <small class="text-muted">分摊方式: ${recurring.splitType === 'equal' ? '平均分摊' : '自定义'}</small>
                            </div>
                            <div class="text-end">
                                <div class="h5 mb-0">¥${recurring.amount.toFixed(2)}</div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-${recurring.isActive ? 'warning' : 'success'}" 
                                            onclick="toggleRecurringExpense(${recurring.id})">
                                        ${recurring.isActive ? '<i class="bi bi-pause"></i>' : '<i class="bi bi-play"></i>'}
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteRecurringExpense(${recurring.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(recurringDiv);
            });
        }

        // 渲染余额结算汇总
        function renderBalanceSummary() {
            const container = document.getElementById('balanceSummary');
            container.innerHTML = '';

            const positive = groupMembers.filter(m => m.balance > 0);
            const negative = groupMembers.filter(m => m.balance < 0);
            const total = positive.reduce((sum, m) => sum + m.balance, 0);

            container.innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">总金额: ¥${total.toFixed(2)}</small>
                </div>
                <div class="mb-3">
                    <div class="small text-success mb-1">应收款项 (${positive.length}人)</div>
                    ${positive.map(m => `
                        <div class="d-flex justify-content-between small">
                            <span>${m.name}</span>
                            <span class="text-success">+¥${m.balance.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                <div>
                    <div class="small text-danger mb-1">应付款项 (${negative.length}人)</div>
                    ${negative.map(m => `
                        <div class="d-flex justify-content-between small">
                            <span>${m.name}</span>
                            <span class="text-danger">-¥${Math.abs(m.balance).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 添加成员
        function addMember() {
            const email = document.getElementById('memberEmail').value;
            const role = document.getElementById('memberRole').value;

            if (!email) {
                showAlert('请输入成员邮箱', 'warning');
                return;
            }

            // 模拟API调用
            const newMember = {
                id: Date.now(),
                name: email.split('@')[0],
                email: email,
                avatar: email.charAt(0).toUpperCase(),
                role: role,
                balance: 0
            };

            groupMembers.push(newMember);
            renderMemberList();
            calculateBalances();
            renderBalanceSummary();
            
            // 清空表单
            document.getElementById('memberEmail').value = '';
            document.getElementById('memberRole').value = 'member';
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
            
            showAlert('成员添加成功', 'success');
        }

        // 移除成员
        function removeMember(memberId) {
            const member = groupMembers.find(m => m.id === memberId);
            if (!member) return;

            if (confirm(`确定要移除成员 ${member.name} 吗？`)) {
                // 模拟API调用
                groupMembers = groupMembers.filter(m => m.id !== memberId);
                renderMemberList();
                calculateBalances();
                renderBalanceSummary();
                showAlert('成员移除成功', 'success');
            }
        }

        // 创建支出
        function createExpense() {
            const title = document.getElementById('expenseTitle').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;
            const category = document.getElementById('expenseCategory').value;
            const date = document.getElementById('expenseDate').value;
            const splitType = document.querySelector('input[name="splitType"]:checked').value;

            if (!title || !amount || !date) {
                showAlert('请填写必要信息', 'warning');
                return;
            }

            // 模拟API调用
            const newExpense = {
                id: Date.now(),
                title: title,
                amount: amount,
                description: description,
                category: category,
                payerId: 1, // 当前用户
                payerName: '张三', // 当前用户名
                date: date,
                splitType: splitType,
                status: 'pending',
                shares: []
            };

            // 生成分摊信息
            if (splitType === 'equal') {
                const shareAmount = amount / groupMembers.length;
                groupMembers.forEach(member => {
                    newExpense.shares.push({
                        memberId: member.id,
                        amount: shareAmount,
                        paid: member.id === 1 // 当前用户默认已支付
                    });
                });
            } else {
                groupMembers.forEach(member => {
                    const customAmount = parseFloat(document.querySelector(`input[name="split_${member.id}"]`)?.value) || 0;
                    newExpense.shares.push({
                        memberId: member.id,
                        amount: customAmount,
                        paid: member.id === 1
                    });
                });
            }

            expenses.push(newExpense);
            renderExpenseList();
            calculateBalances();
            renderBalanceSummary();
            
            // 清空表单
            document.getElementById('createExpenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('createExpenseModal')).hide();
            
            showAlert('支出创建成功', 'success');
        }

        // 记录支付
        function createPayment() {
            const payerId = parseInt(document.getElementById('paymentPayer').value);
            const receiverId = parseInt(document.getElementById('paymentReceiver').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const description = document.getElementById('paymentDescription').value;
            const date = document.getElementById('paymentDate').value;

            if (!payerId || !receiverId || !amount || !date) {
                showAlert('请填写必要信息', 'warning');
                return;
            }

            if (payerId === receiverId) {
                showAlert('付款人和收款人不能相同', 'warning');
                return;
            }

            // 模拟API调用
            const payer = groupMembers.find(m => m.id === payerId);
            const receiver = groupMembers.find(m => m.id === receiverId);

            const newPayment = {
                id: Date.now(),
                payerId: payerId,
                payerName: payer.name,
                receiverId: receiverId,
                receiverName: receiver.name,
                amount: amount,
                description: description,
                date: date,
                status: 'completed'
            };

            payments.push(newPayment);
            renderPaymentList();
            calculateBalances();
            renderBalanceSummary();
            
            // 清空表单
            document.getElementById('createPaymentForm').reset();
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('createPaymentModal')).hide();
            
            showAlert('支付记录成功', 'success');
        }

        // 创建定期支出
        function createRecurringExpense() {
            const title = document.getElementById('recurringTitle').value;
            const amount = parseFloat(document.getElementById('recurringAmount').value);
            const frequency = document.getElementById('recurringFrequency').value;
            const startDate = document.getElementById('recurringStartDate').value;
            const endDate = document.getElementById('recurringEndDate').value;
            const splitType = document.querySelector('input[name="recurringSplitType"]:checked').value;

            if (!title || !amount || !startDate) {
                showAlert('请填写必要信息', 'warning');
                return;
            }

            // 模拟API调用
            const newRecurring = {
                id: Date.now(),
                title: title,
                amount: amount,
                frequency: frequency,
                nextDate: calculateNextDate(startDate, frequency),
                splitType: splitType,
                isActive: true
            };

            recurringExpenses.push(newRecurring);
            renderRecurringList();
            
            // 清空表单
            document.getElementById('createRecurringForm').reset();
            document.getElementById('recurringStartDate').value = new Date().toISOString().split('T')[0];
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('createRecurringModal')).hide();
            
            showAlert('定期支出创建成功', 'success');
        }

        // 计算下次执行日期
        function calculateNextDate(startDate, frequency) {
            const date = new Date(startDate);
            switch (frequency) {
                case 'daily':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + 7);
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + 1);
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + 1);
                    break;
            }
            return date.toISOString().split('T')[0];
        }

        // 删除支出
        function deleteExpense(expenseId) {
            if (confirm('确定要删除这个支出吗？')) {
                expenses = expenses.filter(e => e.id !== expenseId);
                renderExpenseList();
                calculateBalances();
                renderBalanceSummary();
                showAlert('支出删除成功', 'success');
            }
        }

        // 切换定期支出状态
        function toggleRecurringExpense(recurringId) {
            const recurring = recurringExpenses.find(r => r.id === recurringId);
            if (recurring) {
                recurring.isActive = !recurring.isActive;
                renderRecurringList();
                showAlert(`定期支出已${recurring.isActive ? '启用' : '暂停'}`, 'success');
            }
        }

        // 删除定期支出
        function deleteRecurringExpense(recurringId) {
            if (confirm('确定要删除这个定期支出吗？')) {
                recurringExpenses = recurringExpenses.filter(r => r.id !== recurringId);
                renderRecurringList();
                showAlert('定期支出删除成功', 'success');
            }
        }

        // 筛选支出
        function filterExpenses(type) {
            // 更新按钮状态
            document.querySelectorAll('#filterAll, #filterPaid, #filterUnpaid').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('filter' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');

            // 筛选支出
            let filteredExpenses = expenses;
            if (type === 'paid') {
                filteredExpenses = expenses.filter(e => e.status === 'paid');
            } else if (type === 'unpaid') {
                filteredExpenses = expenses.filter(e => e.status === 'pending');
            }

            // 重新渲染
            const container = document.getElementById('expenseList');
            container.innerHTML = '';

            filteredExpenses.forEach(expense => {
                const expenseDiv = document.createElement('div');
                expenseDiv.className = 'expense-card';
                
                const categoryIcon = {
                    'food': 'bi-cup-hot',
                    'transport': 'bi-bus',
                    'entertainment': 'bi-music-note',
                    'shopping': 'bi-bag',
                    'bill': 'bi-receipt',
                    'other': 'bi-three-dots'
                };

                expenseDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi ${categoryIcon[expense.category]} me-2"></i>
                                <h6 class="mb-0 me-2">${expense.title}</h6>
                                <span class="badge bg-${expense.status === 'paid' ? 'success' : 'warning'}">
                                    ${expense.status === 'paid' ? '已支付' : '待支付'}
                                </span>
                            </div>
                            <p class="text-muted mb-2">${expense.description}</p>
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted">支付人: ${expense.payerName}</small>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">日期: ${expense.date}</small>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">分摊: ${expense.splitType === 'equal' ? '平均' : '自定义'}</small>
                                </div>
                            </div>
                        </div>
                        <div class="text-end ms-3">
                            <div class="h5 mb-1">¥${expense.amount.toFixed(2)}</div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewExpenseDetails(${expense.id})">
                                    <i class="bi bi-eye"></i> 查看
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteExpense(${expense.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(expenseDiv);
            });
        }

        // 查看支出详情
        function viewExpenseDetails(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            // 这里可以打开一个模态框显示详情
            alert(`支出详情:\n标题: ${expense.title}\n金额: ¥${expense.amount}\n描述: ${expense.description}\n日期: ${expense.date}`);
        }

        // 显示提示消息
        function showAlert(message, type = 'info') {
            // 创建提示元素
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 70px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 初始化支付表单选项
        function initializePaymentFormOptions() {
            const payerSelect = document.getElementById('paymentPayer');
            const receiverSelect = document.getElementById('paymentReceiver');

            payerSelect.innerHTML = '';
            receiverSelect.innerHTML = '';

            groupMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                payerSelect.appendChild(option);

                const option2 = document.createElement('option');
                option2.value = member.id;
                option2.textContent = member.name;
                receiverSelect.appendChild(option2);
            });
        }

        // 在模态框显示时初始化选项
        document.addEventListener('DOMContentLoaded', function() {
            // 当创建支付模态框显示时初始化选项
            document.getElementById('createPaymentModal').addEventListener('shown.bs.modal', function() {
                initializePaymentFormOptions();
            });
        });
    </script>
</body>
</html>
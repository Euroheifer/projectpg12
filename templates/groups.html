{% extends "menu.html" %}
{% block title %}群组详情 | Project PG12{% endblock %}
{% block extra_css %}
<style>
/* 自定义样式 */
body {
  background-color: #F9FAFB;
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
}

.tab-button {
  transition: all 0.2s ease-in-out;
  border-bottom: 2px solid transparent;
}

.tab-button.active {
  border-bottom-color: #4F46E5;
  color: #4F46E5;
}

.tab-button:hover {
  background-color: #F8FAFC;
}

.member-item {
  transition: all 0.2s ease-in-out;
}

.member-item:hover {
  background-color: #F8FAFC;
}

.expense-item {
  transition: all 0.2s ease-in-out;
}

.expense-item:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.modal-overlay {
  backdrop-filter: blur(4px);
}

.modal-content {
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.btn-primary {
  background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #4338CA 0%, #4F46E5 100%);
}

.balance-positive {
  color: #10B981;
}

.balance-negative {
  color: #EF4444;
}

.admin-badge {
  background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
  color: #DC2626;
  padding: 2px 8px;
  border-radius: 6px;
  font-size: 0.7rem;
  font-weight: 600;
}

.notification-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: #EF4444;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 0.7rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
  <!-- 群组信息卡片 -->
  <div class="bg-white shadow-xl rounded-xl border border-gray-100 mb-6">
    <!-- 群组标题和状态 -->
    <div class="p-6 border-b border-gray-100">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-3xl font-extrabold text-gray-900 mb-2">
            {{ group.name if group else "群组名称" }}
            {% if is_admin %}
              <span class="admin-badge">管理员</span>
            {% endif %}
          </h1>
          <p class="text-gray-600">{{ group.description if group else "群组描述" }}</p>
          <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
            <span><i class="fa-solid fa-users mr-1"></i>{{ member_count or 0 }} 名成员</span>
            <span><i class="fa-solid fa-calendar mr-1"></i>创建于 {{ group.created_at[:10] if group else "日期" }}</span>
          </div>
        </div>
        <div class="flex space-x-3">
          {% if is_admin %}
          <button onclick="handleEditGroup()" 
            class="flex items-center space-x-2 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150">
            <i class="fa-solid fa-edit"></i>
            <span>编辑群组</span>
          </button>
          {% endif %}
          <button onclick="handleLeaveGroup()" 
            class="flex items-center space-x-2 px-4 py-2 text-red-700 bg-red-100 hover:bg-red-200 rounded-lg transition duration-150">
            <i class="fa-solid fa-sign-out-alt"></i>
            <span>退出群组</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- 财务概览 -->
    <div class="p-6 bg-gray-50">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-4 rounded-lg shadow-sm">
          <div class="text-sm font-medium text-gray-500 mb-1">您应付</div>
          <div class="text-2xl font-bold text-red-600">
            ¥{{ "{:.2f}".format(user_owes) if user_owes is defined else "0.00" }}
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm">
          <div class="text-sm font-medium text-gray-500 mb-1">您被欠</div>
          <div class="text-2xl font-bold text-green-600">
            ¥{{ "{:.2f}".format(user_owed) if user_owed is defined else "0.00" }}
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm">
          <div class="text-sm font-medium text-gray-500 mb-1">建议结算</div>
          <div class="text-2xl font-bold 
            {% if net_balance > 0 %}text-green-600
            {% elif net_balance < 0 %}text-red-600
            {% else %}text-gray-600{% endif %}">
            {% if net_balance > 0 %}应收 ¥{{ "{:.2f}".format(net_balance) }}
            {% elif net_balance < 0 %}应付 ¥{{ "{:.2f}".format(-net_balance) }}
            {% else %}已平衡{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 标签页导航 -->
  <div class="bg-white shadow-xl rounded-xl border border-gray-100">
    <div class="border-b border-gray-200">
      <nav class="flex space-x-8 px-6" aria-label="Tabs">
        <button onclick="switchTab('expenses')" id="tab-expenses" 
          class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap
          {% if active_tab == 'expenses' %}text-indigo-600 border-indigo-600{% else %}text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300{% endif %}">
          <i class="fa-solid fa-receipt mr-2"></i>费用
          {% if pending_expenses_count and pending_expenses_count > 0 %}
            <span class="notification-badge">{{ pending_expenses_count }}</span>
          {% endif %}
        </button>
        <button onclick="switchTab('members')" id="tab-members"
          class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap
          {% if active_tab == 'members' %}text-indigo-600 border-indigo-600{% else %}text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300{% endif %}">
          <i class="fa-solid fa-users mr-2"></i>成员
        </button>
        <button onclick="switchTab('settlements')" id="tab-settlements"
          class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap
          {% if active_tab == 'settlements' %}text-indigo-600 border-indigo-600{% else %}text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300{% endif %}">
          <i class="fa-solid fa-exchange-alt mr-2"></i>结算
        </button>
        <button onclick="switchTab('settings')" id="tab-settings"
          class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap
          {% if active_tab == 'settings' %}text-indigo-600 border-indigo-600{% else %}text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300{% endif %}">
          <i class="fa-solid fa-cog mr-2"></i>设置
        </button>
      </nav>
    </div>

    <!-- 标签页内容 -->
    <div class="p-6">
      <!-- 费用标签页 -->
      <div id="content-expenses" class="tab-content {% if active_tab != 'expenses' %}hidden{% endif %}">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-semibold text-gray-900">所有费用</h3>
          <button onclick="showAddExpenseModal()" 
            class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm hover:shadow-md transition duration-150">
            <i class="fa-solid fa-plus mr-2"></i>添加费用
          </button>
        </div>
        
        <div id="expense-list" class="space-y-4">
          {% if expenses %}
            {% for expense in expenses %}
            <div class="expense-item bg-white p-4 rounded-lg border border-gray-200">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h4 class="font-medium text-gray-900">{{ expense.description }}</h4>
                  <p class="text-sm text-gray-500 mt-1">
                    <i class="fa-solid fa-user mr-1"></i>{{ expense.payer_name }}
                    <i class="fa-solid fa-calendar ml-3 mr-1"></i>{{ expense.created_at[:10] }}
                  </p>
                </div>
                <div class="text-right">
                  <div class="text-lg font-semibold text-gray-900">¥{{ "{:.2f}".format(expense.amount) }}</div>
                  <div class="text-sm text-gray-500">{{ expense.participants|length }} 人分摊</div>
                </div>
              </div>
              {% if expense.notes %}
              <div class="mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                {{ expense.notes }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-12 text-gray-500">
              <i class="fa-solid fa-receipt text-4xl mb-4 opacity-50"></i>
              <p>还没有费用记录</p>
              <p class="text-sm">点击上方按钮添加第一笔费用</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- 其他标签页内容类似地实现 -->
      <div id="content-members" class="tab-content {% if active_tab != 'members' %}hidden{% endif %}">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-semibold text-gray-900">群组成员</h3>
          {% if is_admin %}
          <button onclick="showInviteMemberModal()" 
            class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm hover:shadow-md transition duration-150">
            <i class="fa-solid fa-user-plus mr-2"></i>邀请成员
          </button>
          {% endif %}
        </div>
        
        <div id="member-list" class="space-y-3">
          {% if members %}
            {% for member in members %}
            <div class="member-item flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                  <i class="fa-solid fa-user text-indigo-600"></i>
                </div>
                <div>
                  <div class="font-medium text-gray-900">{{ member.username }}</div>
                  <div class="text-sm text-gray-500">{{ member.email }}</div>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                {% if member.is_admin %}
                  <span class="admin-badge">管理员</span>
                {% endif %}
                {% if is_admin and member.id != current_user.id %}
                <button onclick="removeMember({{ member.id }})" 
                  class="text-red-600 hover:text-red-800 text-sm">
                  <i class="fa-solid fa-trash"></i>
                </button>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <!-- 结算标签页 -->
      <div id="content-settlements" class="tab-content {% if active_tab != 'settlements' %}hidden{% endif %}">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">建议结算</h3>
        <div id="settlement-suggestions" class="space-y-4">
          <!-- 结算建议将通过JavaScript动态生成 -->
        </div>
      </div>

      <!-- 设置标签页 -->
      <div id="content-settings" class="tab-content {% if active_tab != 'settings' %}hidden{% endif %}">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">群组设置</h3>
        {% if is_admin %}
        <div class="space-y-6">
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex">
              <i class="fa-solid fa-exclamation-triangle text-yellow-400 mt-0.5 mr-3"></i>
              <div>
                <h4 class="text-sm font-medium text-yellow-800">危险操作</h4>
                <p class="text-sm text-yellow-700 mt-1">这些操作无法撤销，请谨慎操作。</p>
              </div>
            </div>
          </div>
          
          <div class="flex justify-between items-center p-4 border border-red-200 rounded-lg">
            <div>
              <h4 class="font-medium text-gray-900">删除群组</h4>
              <p class="text-sm text-gray-500">永久删除此群组及其所有数据</p>
            </div>
            <button onclick="confirmDeleteGroup()" 
              class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition duration-150">
              删除群组
            </button>
          </div>
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
          <i class="fa-solid fa-lock text-4xl mb-4 opacity-50"></i>
          <p>只有管理员才能修改群组设置</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</main>

<!-- 模态弹窗 -->
<div id="add-expense-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
  <!-- 添加费用模态框内容 -->
</div>

<div id="invite-member-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
  <!-- 邀请成员模态框内容 -->
</div>

{% endblock %}

{% block extra_js %}
<script src="/static/js/ui/menu.js"></script>
<script type="module" src="/static/js/page/group_page.js"></script>
<script type="module" src="/static/js/api/groups.js"></script>
<script type="module" src="/static/js/api/expense.js"></script>
<script type="module" src="/static/js/api/members.js"></script>

<!-- 安全性增强 -->
<script>
// CSRF保护
function getCSRFToken() {
  const cookieMatch = document.cookie.match(/csrftoken=([^;]+)/);
  return cookieMatch ? cookieMatch[1] : '';
}

// 表单安全验证
document.addEventListener('DOMContentLoaded', function() {
  // 防止重复提交
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = '提交中...';
      }
    });
  });

  // 输入验证
  const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');
  inputs.forEach(input => {
    input.addEventListener('input', function() {
      // 清理非法字符
      this.value = this.value.replace(/[<>\"'&]/g, '');
    });
  });
});
</script>
{% endblock %}
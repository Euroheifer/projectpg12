{% extends "menu.html" %}
{% block title %}群组详情 (备用版) | Project PG12{% endblock %}
{% block extra_css %}
<style>
/* 备用版本的样式 - 简化版 */
body {
  background-color: #F9FAFB;
  font-family: 'Inter', sans-serif;
}

.group-container {
  max-width: 7xl;
  margin: 0 auto;
  padding: 1rem;
}

.group-card {
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  border: 1px solid #F3F4F6;
}

.member-card {
  transition: all 0.2s ease;
  border: 1px solid #E5E7EB;
}

.member-card:hover {
  border-color: #4F46E5;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.expense-card {
  transition: all 0.2s ease;
}

.expense-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.btn-primary {
  background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
  border: none;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-weight: 500;
  transition: all 0.15s ease;
  cursor: pointer;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #4338CA 0%, #4F46E5 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
}

.btn-secondary {
  background: #F3F4F6;
  border: 1px solid #D1D5DB;
  color: #374151;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-weight: 500;
  transition: all 0.15s ease;
  cursor: pointer;
}

.btn-secondary:hover {
  background: #E5E7EB;
  border-color: #9CA3AF;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 600;
}

.status-badge.active {
  background: #D1FAE5;
  color: #065F46;
}

.status-badge.pending {
  background: #FEF3C7;
  color: #92400E;
}

.status-badge.inactive {
  background: #FEE2E2;
  color: #991B1B;
}
</style>
{% endblock %}

{% block content %}
<div class="group-container">
  <!-- 群组信息概览 -->
  <div class="group-card p-6 mb-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          {{ group.name|default:"群组名称" }}
          {% if is_admin %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-2">
              管理员
            </span>
          {% endif %}
        </h1>
        <p class="text-gray-600 mb-4">{{ group.description|default:"群组描述信息" }}</p>
        <div class="flex items-center space-x-4 text-sm text-gray-500">
          <span><i class="fas fa-users mr-1"></i>{{ member_count|default:0 }} 名成员</span>
          <span><i class="fas fa-calendar mr-1"></i>创建于 {{ group.created_at[:10]|default:"日期" }}</span>
          <span class="status-badge {{ 'active' if group.is_active else 'inactive' }}">
            {{ '活跃' if group.is_active else '非活跃' }}
          </span>
        </div>
      </div>
      <div class="flex space-x-3">
        {% if is_admin %}
        <button onclick="editGroup()" class="btn-secondary">
          <i class="fas fa-edit mr-2"></i>编辑群组
        </button>
        {% endif %}
        <button onclick="leaveGroup()" class="btn-secondary text-red-600 hover:bg-red-50">
          <i class="fas fa-sign-out-alt mr-2"></i>退出群组
        </button>
      </div>
    </div>
    
    <!-- 财务概览 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
      <div class="bg-white p-4 rounded-lg">
        <div class="text-sm text-gray-500 mb-1">您应付</div>
        <div class="text-2xl font-bold text-red-600">
          ¥{{ "{:.2f}".format(user_owes|default(0)) }}
        </div>
      </div>
      <div class="bg-white p-4 rounded-lg">
        <div class="text-sm text-gray-500 mb-1">您被欠</div>
        <div class="text-2xl font-bold text-green-600">
          ¥{{ "{:.2f}".format(user_owed|default(0)) }}
        </div>
      </div>
      <div class="bg-white p-4 rounded-lg">
        <div class="text-sm text-gray-500 mb-1">净余额</div>
        <div class="text-2xl font-bold {% if net_balance > 0 %}text-green-600{% elif net_balance < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
          {% if net_balance > 0 %}+{% endif %}¥{{ "{:.2f}".format(net_balance|default(0)) }}
        </div>
      </div>
    </div>
  </div>

  <!-- 主要内容区域 -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 左侧：成员列表 -->
    <div class="lg:col-span-1">
      <div class="group-card p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-900">群组成员</h2>
          {% if is_admin %}
          <button onclick="inviteMember()" class="btn-primary text-sm">
            <i class="fas fa-user-plus mr-1"></i>邀请
          </button>
          {% endif %}
        </div>
        
        <div class="space-y-3">
          {% for member in members|default([]) %}
          <div class="member-card p-3 rounded-lg flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                <i class="fas fa-user text-indigo-600 text-sm"></i>
              </div>
              <div>
                <div class="font-medium text-gray-900 text-sm">{{ member.username }}</div>
                <div class="text-xs text-gray-500">{{ member.email }}</div>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              {% if member.is_admin %}
                <span class="status-badge bg-red-100 text-red-800 text-xs">管理员</span>
              {% endif %}
              {% if is_admin and member.id != current_user.id %}
              <button onclick="removeMember({{ member.id }})" class="text-red-600 hover:text-red-800 text-xs">
                <i class="fas fa-trash"></i>
              </button>
              {% endif %}
            </div>
          </div>
          {% else %}
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-users text-3xl mb-3 opacity-50"></i>
            <p class="text-sm">暂无成员</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 右侧：费用记录 -->
    <div class="lg:col-span-2">
      <div class="group-card p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-lg font-semibold text-gray-900">费用记录</h2>
          <button onclick="addExpense()" class="btn-primary">
            <i class="fas fa-plus mr-2"></i>添加费用
          </button>
        </div>
        
        <div class="space-y-4">
          {% for expense in expenses|default([]) %}
          <div class="expense-card p-4 bg-white border border-gray-200 rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h4 class="font-medium text-gray-900">{{ expense.description }}</h4>
                <p class="text-sm text-gray-500 mt-1">
                  <i class="fas fa-user mr-1"></i>{{ expense.payer_name }}
                  <i class="fas fa-calendar ml-3 mr-1"></i>{{ expense.created_at[:10] }}
                  <i class="fas fa-users ml-3 mr-1"></i>{{ expense.participants|length }} 人分摊
                </p>
                {% if expense.notes %}
                <p class="text-sm text-gray-600 mt-2 p-2 bg-gray-50 rounded">
                  {{ expense.notes }}
                </p>
                {% endif %}
              </div>
              <div class="text-right">
                <div class="text-lg font-semibold text-gray-900">¥{{ "{:.2f}".format(expense.amount) }}</div>
                <div class="text-xs text-gray-500">人均 ¥{{ "{:.2f}".format(expense.amount / expense.participants|length) }}</div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="text-center py-12 text-gray-500">
            <i class="fas fa-receipt text-4xl mb-4 opacity-50"></i>
            <p>还没有费用记录</p>
            <p class="text-sm mt-1">点击上方按钮添加第一笔费用</p>
          </div>
          {% endfor %}
        </div>
        
        {% if expenses and expenses|length > 5 %}
        <div class="mt-6 text-center">
          <button onclick="loadMoreExpenses()" class="btn-secondary">
            <i class="fas fa-chevron-down mr-2"></i>加载更多
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- 通用模态框 -->
<div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <!-- 模态框内容将动态插入 -->
</div>

{% endblock %}

{% block extra_js %}
<script src="/static/js/ui/menu.js"></script>
<script type="module" src="/static/js/page/group_page.js"></script>

<!-- 简化版JavaScript -->
<script>
// 基础功能实现
function editGroup() {
  showModal('编辑群组', `
    <form id="edit-group-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">群组名称</label>
        <input type="text" name="name" value="{{ group.name }}" required
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">群组描述</label>
        <textarea name="description" rows="3"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">{{ group.description }}</textarea>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal()" class="btn-secondary">取消</button>
        <button type="submit" class="btn-primary">保存</button>
      </div>
    </form>
  `);
}

function leaveGroup() {
  if (confirm('确定要退出这个群组吗？此操作无法撤销。')) {
    // 发送退出请求
    fetch('/groups/{{ group.id }}/leave/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      }
    }).then(response => {
      if (response.ok) {
        window.location.href = '/';
      } else {
        alert('退出失败，请重试');
      }
    });
  }
}

function inviteMember() {
  showModal('邀请新成员', `
    <form id="invite-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱地址</label>
        <input type="email" name="email" required
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="输入要邀请的成员邮箱">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">邀请消息（可选）</label>
        <textarea name="message" rows="3"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="向被邀请人发送的消息"></textarea>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal()" class="btn-secondary">取消</button>
        <button type="submit" class="btn-primary">发送邀请</button>
      </div>
    </form>
  `);
}

function addExpense() {
  showModal('添加新费用', `
    <form id="expense-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">费用描述</label>
        <input type="text" name="description" required
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="描述这笔费用">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">金额</label>
          <input type="number" name="amount" step="0.01" min="0" required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">付款人</label>
          <select name="payer_id" required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            {% for member in members|default([]) %}
            <option value="{{ member.id }}" {% if member.id == current_user.id %}selected{% endif %}>{{ member.username }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">参与人员</label>
        <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-300 rounded-lg p-3">
          {% for member in members|default([]) %}
          <label class="flex items-center">
            <input type="checkbox" name="participants" value="{{ member.id }}" 
              {% if member.id == current_user.id %}checked{% endif %}
              class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <span class="ml-2 text-sm text-gray-700">{{ member.username }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">备注（可选）</label>
        <textarea name="notes" rows="2"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="添加备注信息"></textarea>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal()" class="btn-secondary">取消</button>
        <button type="submit" class="btn-primary">添加费用</button>
      </div>
    </form>
  `);
}

// 模态框功能
function showModal(title, content) {
  const modal = document.getElementById('modal-container');
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">${title}</h3>
      </div>
      <div class="px-6 py-4">
        ${content}
      </div>
    </div>
  `;
  modal.classList.remove('hidden');
  
  // 处理表单提交
  const form = modal.querySelector('form');
  if (form) {
    form.addEventListener('submit', handleFormSubmit);
  }
}

function closeModal() {
  document.getElementById('modal-container').classList.add('hidden');
}

function handleFormSubmit(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  
  // 这里应该发送实际的API请求
  console.log('表单数据:', Object.fromEntries(formData));
  
  closeModal();
  alert('功能演示：表单提交成功');
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
  console.log('群组详情页面（备用版）已加载');
});
</script>
{% endblock %}